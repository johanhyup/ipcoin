"use strict";(self.webpackChunktradingview=self.webpackChunktradingview||[]).push([[78026],{200441:(e,t,i)=>{i.d(t,{AbstractBarColorer:()=>s});class s{constructor(){this._backColorers=[]}barStyle(e,t,i){const s={};for(const r of this._backColorers)r.applyBarStyle(e,t,s,i);return this.applyBarStyle(e,t,s,i),s}pushBackBarColorer(e){this._backColorers.unshift(e)}firstColoredBar(e){return null}}},546821:(e,t,i)=>{i.d(t,{actualCurrencyUnitVisibility:()=>h,currencyUnitVisibilityOptions:()=>a,currencyUnitVisibilityProperty:()=>o,migrateShowCurrencyAndShowUnitProperties:()=>c,restoreCurrencyUnitVisibilitySettingsValue:()=>l});var s=i(154241),r=i(62802),n=i.n(r);const{property:o,availableValues:a,restoreDefaultValue:l,actualBehavior:h}=(0,s.createVisibilityController)("PriceAxisCurrencyAndUnit.visibility");let u=!1;function c(e,t){u||(u=!0,void 0===n().getValue("PriceAxisCurrencyAndUnit.visibility")&&o().setValue(e||t?"alwaysOn":"alwaysOff"))}},49839:(e,t,i)=>{i.d(t,{DataWindowItem:()=>s,DataWindowView:()=>r});class s{constructor(e,t,i,s=!1){this._visible=!0,this._id=e,this._title=t,this._value=i,this._unimportant=s}id(){return this._id}title(){return this._title}setTitle(e){this._title=e}text(){return this._value}value(){return this._value}setValue(e){this._value=e}visible(){return this._visible}setVisible(e){this._visible=e}color(){return this._color}setColor(e){this._color=e}unimportant(){return this._unimportant}}class r{constructor(){this._items=[],this._header="",this._title=""}header(){return this._header}title(){return this._title}items(){return this._items}canShowItems(){return!0}update(){}}},799878:(e,t,i)=>{i.d(t,{FormattersSerializer:()=>h});var s=i(650151),r=i(735211),n=i(957365),o=i(142567),a=i(941252);const l={price:r.PriceFormatter,volume:n.VolumeFormatter,percentage:o.PercentageFormatter,quoteSessionPrice:a.QuoteSessionPriceFormatter};var h;!function(e){function t(e){return(0,s.ensureDefined)(l[e.type]).deserialize(e.state)}e.serialize=function(e){const t=(0,s.ensureDefined)(l[e.type]);return{type:e.type,state:t.serialize(e)}},e.deserialize=t,e.safeDeserialize=function(e){try{return t(e)}catch(e){return null}}}(h||(h={}))},941252:(e,t,i)=>{i.d(t,{QuoteSessionPriceFormatter:()=>r});var s=i(735211);class r{constructor(e){this.type="quoteSessionPrice",this.reset(e)}state(){return this._priceFormatter.state()}reset(e){this._priceFormatter=e||new s.PriceFormatter({priceScale:100,minMove:1,fractional:!1})}update(e,t){const i=null!=t.pricescale||null!=t.minmov||null!=t.fractional||null!=t.minmove2,r=null!=e.pricescale&&null!=e.minmov&&null!=e.fractional&&null!=e.minmove2;i&&r&&(this._priceFormatter=new s.PriceFormatter({priceScale:e.pricescale,minMove:e.minmov,fractional:e.fractional||!1,minMove2:e.minmove2}))}format(e,t){return this._priceFormatter.format(e,t)}hasForexAdditionalPrecision(){return this._priceFormatter.hasForexAdditionalPrecision()}static serialize(e){return e.state()}static deserialize(e){const t=new s.PriceFormatter(e);return new r(t)}}},498830:(e,t,i)=>{i.d(t,{
getPriceValueFormatterForSource:()=>l,getPriceValueFormatterForStudy:()=>h,shouldBeFormattedAsIndexedTo100:()=>o,shouldBeFormattedAsPercent:()=>n});var s=i(975179),r=i(487945);function n(e){const t=e.priceScale();return!(null===t||!t.isPercentage())&&(!(0,r.isActingAsSymbolSource)(e)||(0,s.isPriceSourceStyle)(e.style()))}function o(e){const t=e.priceScale();return!(null===t||!t.isIndexedTo100())&&(!(0,r.isActingAsSymbolSource)(e)||(0,s.isPriceSourceStyle)(e.style()))}function a(e){const t=e.priceScale();return o(e)&&null!==t?(i,s)=>t.formatPriceIndexedTo100(i,e.firstValue()??100,s):n(e)&&null!==t?(i,s)=>t.formatPricePercentage(i,e.firstValue()??100,s):null}function l(e){const t=a(e);if(t)return t;const i=e.formatter();return i.format.bind(i)}function h(e,t){const i=a(e);if(i)return i;const s=e.plotFormatter(t);return s.format.bind(s)}},345159:(e,t,i)=>{i.d(t,{HorizontalLinePaneView:()=>n});var s=i(467841),r=i(666574);class n{constructor(){this._lineRendererData={y:0,color:"rgba(0, 0, 0, 0)",linewidth:1,linestyle:r.LINESTYLE_SOLID,visible:!1},this._lineRenderer=new s.HorizontalLineRenderer,this._invalidated=!0,this._lineRenderer.setData(this._lineRendererData)}update(e){this._invalidated=!0}renderer(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._lineRenderer}}},581899:(e,t,i)=>{i.d(t,{notAvailable:()=>s});i(444372),i(764829);const s="âˆ…"},114555:(e,t,i)=>{i.d(t,{AreaBackgroundItem:()=>l,AreaBackgroundItemsGroup:()=>o,AreaBackgroundRenderer:()=>h,CachedMap:()=>a});var s=i(650151),r=i(961970),n=i(117908);class o extends n.CachedContainer{constructor(e){super(),this.color=e}}class a{constructor(){this._map=new Map,this._usedKeys=new Set,this._invalidations=0}invalidateCache(){this._invalidations+=1,50===this._invalidations&&(this._deleteUnused(),this._invalidations=0),this._usedKeys.clear(),this._map.forEach(((e,t)=>e.invalidateCache()))}get(e){const t=this._map.get(e);return void 0!==t&&this._usedKeys.add(e),t}set(e,t){this._usedKeys.add(e),this._map.set(e,t)}[Symbol.iterator](){const e=Array.from(this._usedKeys)[Symbol.iterator]();return{[Symbol.iterator](){return this},next:()=>{const t=e.next();return t.value?{value:[t.value,(0,s.ensureDefined)(this._map.get(t.value))],done:!1}:{value:void 0,done:!0}}}}forEach(e){this._map.forEach(((t,i)=>{this._usedKeys.has(i)&&e(t,i)}))}delete(e){const t=this._map.get(e);void 0!==t&&t.invalidateCache(),this._usedKeys.delete(e)}_deleteUnused(){const e=[];this._map.forEach(((t,i)=>{this._usedKeys.has(i)||e.push(i)}));for(const t of e)this._map.delete(t)}}class l extends n.CachedContainer{constructor(){super(),this.points1=new n.CachedContainer,this.points2=new n.CachedContainer,this.push(this.points1),this.push(this.points2)}addPoints1Point(e,t){let i=this.points1.newItem();null!==i?(i.x=e,i.y=t):i={x:e,y:t},this.points1.push(i)}addPoints2Point(e,t){let i=this.points2.newItem();null!==i?(i.x=e,i.y=t):i={x:e,y:t},this.points2.push(i)}invalidateCache(){this.points1.invalidateCache(),this.points2.invalidateCache()}}
class h extends r.BitmapCoordinatesPaneRenderer{constructor(e){super(),this._data=null,this._data=e??null}setData(e){this._data=e}hitTest(e){return null}_drawImpl(e){if(null===this._data)return;const{context:t,horizontalPixelRatio:i,verticalPixelRatio:s}=e,r=.25*this._data.barSpacing;for(const[,e]of this._data.colorAreas){t.beginPath();for(let n=0;n<e.length();n++){const o=e.at(n);if(o.points1.isEmpty()||o.points2.isEmpty())continue;const a=o.points1.at(0).x,l=o.points1.at(0).y;if(t.moveTo(Math.round(a*i),l*s),1!==o.points1.length()&&1!==o.points2.length()){for(const e of o.points1.iterator(1))t.lineTo(Math.round(e.x*i),e.y*s);for(const e of o.points2.iterator(o.points2.length()-1,!0))t.lineTo(Math.round(e.x*i),e.y*s)}else{const e=o.points2.at(0).x,n=o.points2.at(0).y;t.lineTo(Math.round((a+r)*i),l*s),t.lineTo(Math.round((e+r)*i),n*s),t.lineTo(Math.round((e-r)*i),n*s),t.lineTo(Math.round((a-r)*i),l*s)}}if(t.closePath(),0===e.color.type)t.fillStyle=e.color.color;else{const i=t.createLinearGradient(0,e.color.coordinate1*s,0,e.color.coordinate2*s);i.addColorStop(0,e.color.color1??"transparent"),i.addColorStop(1,e.color.color2??"transparent"),t.fillStyle=i}t.fill()}}}},117908:(e,t,i)=>{i.d(t,{CachedContainer:()=>r,ObjectValuesCache:()=>n});class s{constructor(e,t,i,s){this._items=e,this._actualLength=t,this._step=s?-1:1,this._currentIndex=i-this._step}[Symbol.iterator](){return this}next(){return this._currentIndex+=this._step,this._currentIndex>=this._actualLength||this._currentIndex<0?{value:void 0,done:!0}:{done:!1,value:this._items[this._currentIndex]}}}class r{constructor(){this._items=[],this._actualLength=0,this._invalidations=0}push(e){this._items.length===this._actualLength?this._items.push(e):this._items[this._actualLength]!==e&&(this._items[this._actualLength]=e),this._actualLength+=1}newItem(){const e=this._items.length>this._actualLength?this._items[this._actualLength]:null;return null!==e&&Boolean(e.invalidateCache)&&e.invalidateCache(),e}invalidateCache(){this._invalidations+=1,3e3===this._invalidations&&(this._items.splice(this._actualLength),this._invalidations=0),this._actualLength=0}at(e){return this._items[e]}data(){return this._items}length(){return this._actualLength}isEmpty(){return 0===this._actualLength}iterator(e,t){return new s(this._items,this._actualLength,e,t)}}class n extends r{constructor(){super(...arguments),this._startIndex=0}setStartIndex(e){this._startIndex=e}isValidIndex(e){return e>=this._startIndex}at(e){const t=e-this._startIndex;for(;t>=this._actualLength;)this._items.length<=t?this._items.push(this._newObject()):this._clearObject(this._items[this._actualLength]),this._actualLength+=1;return this._items[t]}}},336928:(e,t,i)=>{i.d(t,{PriceLineAxisView:()=>l,SeriesPriceLineAxisView:()=>h,StudyPriceLineAxisView:()=>u});var s=i(347808),r=i(650151),n=i(666574),o=i(665798);class a{constructor(e,t){this.setData(e,t)}setData(e,t){this._data=e,this._commonData=t}draw(e,t,i,s,a){if(!this._data.visible)return
;const{bitmapSize:l,verticalPixelRatio:h}=t,u=this._commonData.fixedCoordinate??this._commonData.coordinate;e.lineWidth=Math.max(1,Math.floor((0,r.ensureDefined)(this._data.linewidth)*h)),e.lineCap="butt",(0,o.setLineStyle)(e,void 0===this._data.linestyle?n.LINESTYLE_DOTTED:this._data.linestyle),e.strokeStyle=this._commonData.textColor,(0,o.drawHorizontalLine)(e,Math.round(u*h),0,l.width)}topBottomTotalHeight(e){return{top:0,bottom:0,total:0}}}class l extends s.PriceAxisView{constructor(e){super(e||a)}ignoreAlignment(){return!0}_updateRendererData(e,t,i){if(t.visible=!1,e.visible=!1,!this._isVisible())return;const s=this._value();s.noData||(i.background="",i.textColor=this._priceLineColor(s.color),i.coordinate=s.coordinate,i.floatCoordinate=s.floatCoordinate,e.linewidth=this._lineWidth(),e.linestyle=this._lineStyle(),e.backgroundAreaVisible=this._backgroundAreaVisible(),e.backgroundAreaColor=this._backgroundAreaColor(),e.backgroundAreaHeight=this._backgroundAreaHeight(),e.visible=!0)}_lineStyle(){return n.LINESTYLE_DOTTED}_backgroundAreaVisible(){return!1}_backgroundAreaColor(){return""}_backgroundAreaHeight(){return 0}}class h extends l{constructor(e){super(),this._series=e}_value(){return this._series.lastValueData(void 0,!0)}_priceLineColor(e){return this._series.priceLineColor(e)}_lineWidth(){return this._series.properties().childs().priceLineWidth.value()}_isVisible(){const e=this._series.model().properties().childs().scalesProperties.childs().showSeriesLastValue.value();return this._series.properties().childs().showPriceLine.value()&&e}}class u extends l{constructor(e,t){super(),this._study=e,this._plotname=t}_value(){return this._study.lastValueData(this._plotname,!0)}_lineWidth(){return this._study.properties().childs().styles.childs()[this._plotname].childs().linewidth.value()}_lineStyle(){return n.LINESTYLE_DOTTED}_priceLineColor(e){return e}_isVisible(){const e=this._study.model().properties().childs().scalesProperties.childs().showStudyLastValue.value(),t=this._study.isPlotVisibleAt(this._plotname,1);return this._study.properties().childs().styles.childs()[this._plotname].childs().trackPrice.value()&&e&&t}}},449524:(e,t,i)=>{i.d(t,{PaneRendererBars:()=>n});var s=i(286436),r=i(161160);class n extends r.PaneRendererSeriesBase{constructor(e){super(),this._bars=e.bars,this._dontDrawOpen=e.dontDrawOpen,this._thinBars=e.thinBars}_drawImpl(e){const{context:t,horizontalPixelRatio:i,verticalPixelRatio:s}=e;t.save();let r=null;for(const e of this._bars){let n=this._calcRealBarWidth(e.right-e.left,i);if(n>=2){Math.max(1,Math.floor(i))%2!=n%2&&n--}const o=this._thinBars?Math.min(n,Math.floor(i)):n,a=o<=n&&e.right-e.left>=Math.floor(1.5*i);r!==e.color&&(t.fillStyle=e.color,r=e.color);const l=Math.floor(.5*o),h=Math.round(e.center*i),u=h-l,c=o,d=u+c-1,p=Math.min(e.high,e.low),_=Math.max(e.high,e.low),f=Math.round(p*s)-l,m=Math.round(_*s)+l,y=Math.max(m-f,o);t.fillRect(u,f,c,y);const g=Math.ceil(1.5*n);if(a){const i=h-g,r=h+g,n=Math.min(u-i,r-d);if(!this._dontDrawOpen){let r=Math.max(f,Math.round(e.open*s)-l),o=r+c-1
;o>f+y-1&&(o=f+y-1,r=o-c+1),t.fillRect(i,r,n,o-r+1)}let o=Math.max(f,Math.round(e.close*s)-l),a=o+c-1;a>f+y-1&&(a=f+y-1,o=a-c+1),t.fillRect(d+1,o,n,a-o+1)}}t.restore()}_getTolerance(){return(0,s.interactionTolerance)().series}_calcRealBarWidth(e,t){const i=Math.floor(t);return Math.max(i,Math.floor((0,s.optimalBarWidth)(e,t)))}}},161160:(e,t,i)=>{i.d(t,{PaneRendererSeriesBase:()=>n});var s=i(509078),r=i(961970);class n extends r.BitmapCoordinatesPaneRenderer{constructor(){super(...arguments),this._bars=[]}hitTest(e){const t=this._bars;if(0===t.length)return null;const i=this._getTolerance(),s=t[0],r=t[t.length-1];if(e.x<s.left-i)return null;if(e.x>r.right+i)return null;let n=0,o=t.length-1,a=-1;for(;n<=o;){const i=Math.floor((n+o)/2),s=t[i];if(e.x>=s.left&&e.x<=s.right){a=i;break}e.x>s.right?n=i+1:o=i-1}if(-1===a)return null;if(this._isPointAtBar(t[a],e.y,i))return this._getHitTest();let l=a;for(;l>=1&&e.x-t[l-1].right<i;)l--;let h=a;for(;h<=t.length-2&&t[h+1].left-e.x<i;)h++;const u=Math.max(0,l),c=Math.min(t.length-1,h);for(let s=u;s<=c;s++)if(s!==a&&this._isPointAtBar(t[s],e.y,i))return this._getHitTest();return null}_getHitTest(){return new s.HitTestResult(s.HitTarget.Regular)}_isPointAtBar(e,t,i){const s=Math.min(e.high,e.low),r=Math.max(e.high,e.low);return s-i<=t&&t<=r+i}}},559327:(e,t,i)=>{i.d(t,{PaneRendererCandles:()=>h});var s=i(650151),r=i(509078),n=i(665798),o=i(286436),a=i(161160);function l(e,t,i,s){const r=Math.floor(t);return e.map((e=>{let n=(0,o.optimalCandlestickWidth)((e.right-e.left)*s,t);n>=2&&r%2!=n%2&&n--;const a=Math.floor(.5*n),l=function(e,t){let i=Math.floor(1*t);e<=2*i&&(i=Math.floor(.5*(e-1)));const s=Math.max(Math.floor(t),i);if(e<=2*s)return Math.max(Math.floor(t),Math.floor(1*t));return s}(n,t),h=Math.round(e.center*t),u=h-a,c=u+n-1,d=Math.abs(Math.max(e.open,e.close)-Math.min(e.open,e.close))*i,p=Math.round(Math.min(e.open,e.close)*i),_=Math.round(Math.max(e.open,e.close)*i);let f=Math.min(Math.floor(t),Math.floor(n*t));f=Math.max(Math.floor(t),Math.min(f,n));const m=Math.floor(.5*f);return{rawBodyHeight:d,top:p,bottom:_,center:h,left:u,right:c,candleWidth:n,high:Math.round(e.high*i),low:Math.round(e.low*i),wickWidth:f,wickOffset:m,borderWidth:l}}))}class h extends a.PaneRendererSeriesBase{constructor(e){super(),this._scaleCoeff=1,this._borderVisible=!1,this._wickVisible=!1,this._bodyVisible=!0,this._borderColor=void 0,this._wickColor=void 0,this._hittest=void 0,this._isPriceScaleInverted=!1,e&&this.setData(e)}setData(e){this._bars=e.bars,this._scaleCoeff=e.scaleCoeff??1,this._borderVisible=e.borderVisible,this._bodyVisible=e.bodyVisible,this._wickVisible=e.wickVisible,this._borderColor=e.borderColor,this._wickColor=e.wickColor,this._hittest=e.hittest,this._isPriceScaleInverted=e.isPriceScaleInverted}hitTest(e){return this._wickVisible||this._borderVisible||this._bodyVisible?super.hitTest(e):null}_drawImpl(e){const{context:t,horizontalPixelRatio:i,verticalPixelRatio:s}=e;if(0===this._bars.length)return;const r=l(this._bars,i,s,this._scaleCoeff)
;this._wickVisible&&this._drawWicks(t,r),this._borderVisible&&this._drawBorder(t,r),this._bodyVisible&&this._drawCandles(t,r)}_getTolerance(){return(0,o.interactionTolerance)().series}_getHitTest(){return this._hittest||new r.HitTestResult(r.HitTarget.Regular)}_isPointAtBar(e,t,i){const s=this._bodyVisible||this._borderVisible,r=this._wickVisible;if(!s&&!r)return!1;if(s){const s=r?Math.min(e.high,e.low):Math.min(e.open,e.close),n=r?Math.max(e.high,e.low):Math.max(e.open,e.close);return s-i<=t&&t<=n+i}{const s=Math.min(e.open,e.close),r=Math.max(e.open,e.close);return e.high-i<=t&&t<=s+i||r-i<=t&&t<=e.low+i}}_drawWicks(e,t){let i="",r=null;this._bars.forEach(((n,o)=>{const a=n.wickColor?n.wickColor:(0,s.ensureDefined)(this._wickColor);a!==i&&(e.fillStyle=a,i=a);let{top:l,bottom:h}=t[o];const{rawBodyHeight:u,borderWidth:c,center:d,high:p,low:_,wickWidth:f,wickOffset:m}=t[o];this._isPriceScaleInverted&&([h,l]=[l,h]);let y=d-m;const g=y+f-1;null!==r&&(y=Math.max(r+1,y),y=Math.min(y,g));const v=g-y+1;u<=c&&(l!==p&&(l=Math.round(l-.5*c)),h=h!==_?Math.round(l-.5*c)+c-1:_-1),l!==p&&e.fillRect(y,p,v,l-p),_-h-1&&e.fillRect(y,h+1,v,_-h-1),r=g}))}_drawBorder(e,t){let i="",r=null;this._bars.forEach(((o,a)=>{if(o.borderColor!==i&&(e.fillStyle=o.borderColor?o.borderColor:(0,s.ensureDefined)(this._borderColor),i=o.borderColor),this._bodyVisible&&o.hollow)return;let{left:l}=t[a];const{rawBodyHeight:h,top:u,bottom:c,right:d,borderWidth:p}=t[a];null!==r&&(l=Math.max(r+1,l),l=Math.min(l,d));const _=d-l+1;h<=p?e.fillRect(l,Math.round(u-.5*p),_,p):_>2*p?(0,n.fillRectInnerBorder)(e,l,u,d-l+1,c-u+1,p):e.fillRect(l,u,_,c-u+1),r=d}))}_drawCandles(e,t){let i="";this._bars.forEach(((s,r)=>{let{top:o,bottom:a,left:l,right:h}=t[r];const{rawBodyHeight:u,borderWidth:c,candleWidth:d}=t[r];if(!(this._borderVisible&&d<=2*c)||s.hollow){if(s.color!==i){const t=s.color;e.fillStyle=t,i=t}if(s.hollow)e.fillStyle=s.color,u<=c?e.fillRect(l,Math.round(o-.5*c),d,c):(0,n.fillRectInnerBorder)(e,l,o,h-l+1,a-o+1,c);else{if(!this._borderVisible&&u<=c)return void e.fillRect(l,Math.round(o-.5*c),d,c);if(this._borderVisible&&(l+=c,o+=c,h-=c,a-=c),o>a)return;e.fillRect(l,o,h-l+1,a-o+1)}}}))}}},781298:(e,t,i)=>{i.d(t,{AbstractFilledAreaPaneView:()=>_});var s=i(650151),r=(i(86441),i(5531),i(828473)),n=i(259332),o=i(432059),a=i(211414);var l=i(114555),h=i(181530);function u(e,t){return Array.from({length:e},((e,i)=>({timePointIndex:i+t})))}function c(e,t,i){let s,r;const n=e.length;for(let o=t;o>=0&&o<n;o+=i){const t=e[o];if(void 0===s&&void 0!==t.plot1Value&&(s=o),void 0===r&&void 0!==t.plot2Value&&(r=o),void 0!==s&&void 0!==r)return o}return null}function d(e){return 0===e.type?`${e.color}`:`${e.color1}:${e.color2}:${e.coordinate1}:${e.coordinate2}`}const p={type:0,color:""};class _{constructor(e,t,i){this._isHlineFill=!1,this._bandAKey=null,this._bandBKey=null,this._colorPlotIndex=null,this._areaRenderer=new l.AreaBackgroundRenderer,this._dataInvalidated=null,this._viewportInvalidated=!1,this._plIndex1=null,this._plIndex2=null,this._items=[],
this._colorAreas=new l.CachedMap,this._generateColor=function(e=1e3){const t=n.default.Cache;n.default.Cache=a.CircularCacheBuffer.bind(a.CircularCacheBuffer,e);const i=(0,n.default)(o.generateColor,((e,t,i)=>`${e}_${t}_${i}`));return n.default.Cache=t,i}(),this._source=e,this._model=t,this._fillGaps=!!i?.fillgaps,this._fillToIntersection=!!i?.fillToIntersection}update(e){if("global-change"===e.type)return this._dataInvalidated=(0,h.mergeDataInvalidation)(this._dataInvalidated,{}),void(this._viewportInvalidated=!0);if("data-source-change"!==e.type)this._viewportInvalidated=!0;else{e.sourceId===this._source.id()&&(this._dataInvalidated=(0,h.mergeDataInvalidation)(this._dataInvalidated,{firstIndex:e.firstUpdatedTimePointIndex,clearData:e.clearData}))}}renderer(){return this._dataInvalidated?this._updateImplFull(this._dataInvalidated)&&(this._dataInvalidated=null,this._viewportInvalidated=!1):this._viewportInvalidated&&(this._updateImplLight(),this._viewportInvalidated=!1),this._areaRenderer}_minFirstBarIndex(){return-1/0}_priceScale(){return this._source.priceScale()}_firstValue(){return this._source.firstValue()}_plotNames(){return this._source.metaInfo().plots.map((e=>e.id))}_plotIndex1(){return null===this._plIndex1&&(this._plIndex1=this._plotNames().indexOf(this._plotAId())+1),this._plIndex1}_plotIndex2(){return null===this._plIndex2&&(this._plIndex2=this._plotNames().indexOf(this._plotBId())+1),this._plIndex2}_updateImplFull(e){if(this._areaRenderer.setData(null),this._dataInvalidated?.clearData&&(this._items=[]),!this._visible())return!1;if(null===this._priceScale())return!1;if(null===this._firstValue())return!1;const t=this._source.plots().plottableRange(),i=t.size();if(0===i)return!1;const n=this._source.offset(this._plotAId()),o=this._source.offset(this._plotBId()),a=Math.min(n,o),l=Math.max(n,o);let h=e.firstIndex;const c=i+(l-a)+1,d=this._plotIndex1(),p=this._plotIndex2();c!==this._items.length&&(void 0===h||0===this._items.length||h<this._items[0].timePointIndex+a?(h=void 0,this._items=u(c,1e10)):this._items=this._items.concat(u(c-this._items.length,1e10+this._items.length)));const _=this._colorPlotIndex,f=this._transparency(),m=void 0===h?t.fullRangeIterator():t.rangeIterator(h,(0,s.ensureNotNull)(t.lastIndex()));let y=void 0!==h?(0,r.lowerbound)(this._items,h+a,((e,t)=>e.timePointIndex<t))-a:-a;for(const e of m){const t=e.index+n,i=e.index+o,s=this._items[y+n],r=this._items[y+o];if(s.timePointIndex=t,r.timePointIndex=i,this._isHlineFill||(s.plot1Value=e.value[d]??void 0,r.plot2Value=e.value[p]??void 0),null!==_){const t=y+a-1;if(t>=0&&t<this._items.length){const i=this._items[t];let s;s=0===_.type?{type:0,colorIndexOrRgba:e.value[_.colorIndexOrRgba+1]}:{type:1,colorIndexOrRgba1:void 0===_.colorIndexOrRgba1?void 0:e.value[_.colorIndexOrRgba1+1],colorIndexOrRgba2:void 0===_.colorIndexOrRgba2?void 0:e.value[_.colorIndexOrRgba2+1],value1:void 0===_.valueIndex1?void 0:e.value[_.valueIndex1+1],value2:void 0===_.valueIndex2?void 0:e.value[_.valueIndex2+1]};const r=i.color=this._getColorByPlotValue(s)??void 0
;void 0!==r&&(1===r.type?(r.color1=r.color1&&this._generateColor(r.color1,f),r.color2=r.color2&&this._generateColor(r.color2,f)):r.color=this._generateColor(r.color,f))}}y+=1}return this._updateImplLight(),!0}_updateImplLight(){if(!this._visible())return;const e=this._priceScale();if(null===e)return;const t=this._firstValue();if(null===t)return;if(0===this._items.length)return;let i;if(this._isHlineFill){const r=this._source.properties().bands[(0,s.ensureNotNull)(this._bandAKey)],n=this._source.properties().bands[(0,s.ensureNotNull)(this._bandBKey)];i={level1:e.priceToCoordinate(r.value.value(),t),level2:e.priceToCoordinate(n.value.value(),t)}}const n=this._model.timeScale(),o=n.visibleBarsStrictRange();if(null===o)return;const a=e.priceToCoordinateFn(t),h=this._transparency(),u=this._minFirstBarIndex(),_=Math.max(u,o.firstBar()),f=(0,r.lowerbound)(this._items,_,((e,t)=>e.timePointIndex<t));if(f>=this._items.length)return;const m=Math.min(this._items.length-1,(0,r.lowerbound)(this._items,o.lastBar(),((e,t)=>e.timePointIndex<t)));let y,g;this._isHlineFill?(y=u===_?f:Math.max(0,f-1),g=Math.min(this._items.length-1,m+1)):(y=u===_?f:c(this._items,f-1,-1)??f,g=c(this._items,m+1,1)??m);const v=this._colorAreas;v.invalidateCache();let S,b=null,I=null,P=null;const w=this._commonColor();let C;1===w.type?(w.coordinate1=a(w.value1),w.coordinate2=a(w.value2),w.color1=w.color1&&this._generateColor(w.color1,h),w.color2=w.color2&&this._generateColor(w.color2,h)):w.color=this._generateColor(w.color,h);for(let e=y;e<=g;e+=1){const t=this._items[e],s=t.timePointIndex;let r,o;!this._fillGaps&&void 0!==C&&s-C>1&&(b=null),void 0!==i?(r=i.level1,o=i.level2):(r=t.plot1Coordinate=void 0===t.plot1Value?void 0:a(t.plot1Value),o=t.plot2Coordinate=void 0===t.plot2Value?void 0:a(t.plot2Value));const h=t.xCoordinate=n.indexToCoordinate(t.timePointIndex);if(t.color&&1===t.color.type&&(t.color.coordinate1=a(t.color.value1),t.color.coordinate2=a(t.color.value2)),this._fillGaps?void 0!==r||void 0!==o:void 0!==r&&void 0!==o){const i=null!==this._colorPlotIndex?t.color||p:w;if(V=i,!(null===(x=P)||null===V?x===V:0===x.type&&0===V.type?x.color===V.color:1===x.type&&1===V.type&&x.color1===V.color1&&x.color2===V.color2&&x.coordinate1===V.coordinate1&&x.coordinate2===V.coordinate2)||null===b){if(null!==b&&(void 0!==r&&b.addPoints1Point(h,r),void 0!==o&&b.addPoints2Point(h,o)),e===g)continue;P=i;const t=d(i),s=v.get(t)??new l.AreaBackgroundItemsGroup(i);I=b,b=s.newItem()??new l.AreaBackgroundItem,s.push(b),v.set(t,s)}void 0!==r&&b.addPoints1Point(h,r),void 0!==o&&b.addPoints2Point(h,o)}else this._fillGaps||(P=null,b=null,I=null);C=s,S=t}var x,V;v.delete(d(p));const A={barSpacing:this._model.timeScale().barSpacing(),colorAreas:v};this._areaRenderer.setData(A)}}},512230:(e,t,i)=>{i.d(t,{AreaBackgroundPaneView:()=>n});var s=i(650151),r=i(781298);class n extends r.AbstractFilledAreaPaneView{constructor(e,t){super(e,t)}_plotAId(){return(0,s.ensureDefined)(this._source.metaInfo().area)[0].name}_plotBId(){return(0,
s.ensureDefined)(this._source.metaInfo().area)[1].name}_commonColor(){return{type:0,color:this._source.properties().areaBackground.backgroundColor.value()}}_transparency(){return this._source.properties().areaBackground.transparency?.value()??0}_visible(){return this._source.properties().areaBackground.fillBackground.value()}_getColorByPlotValue(e){return this._commonColor()}}},156863:(e,t,i)=>{i.d(t,{HHistBasedValuesProvider:()=>f});var s=i(150335),r=i(650151),n=i(638456),o=i(518439),a=i(419283),l=i(627183),h=i(307801),u=i(627620),c=i(581899);function d(e,t="",i=""){return{id:t,index:e,title:i,value:"",visible:!1}}const p=n.CheckMobile.any(),_=(0,l.getVolumeFormatter)();class f{constructor(e,t,i=!1){this._emptyValues=[],this._study=e,this._model=t,this._emptyTitles=i,void 0!==this._study.metaInfo().graphics.hhists&&this._emptyValues.push(d(0),d(1),d(2))}getItems(){return this._emptyValues}getValues(e){const t=this._emptyValues.map((e=>({...e})));t.forEach((e=>{e.visible=this._study.isVisible(),e.value=c.notAvailable}));const i=this._study.properties().childs().inputs.childs().volume.value();switch(i){case h.HHistVolumeMode.UpDown:this._emptyTitles||(t[0].title="Up",t[1].title="Down",t[2].title="Total");break;case h.HHistVolumeMode.Total:this._emptyTitles||(t[0].title="Total"),t[1].visible=!1,t[2].visible=!1;break;case h.HHistVolumeMode.Delta:this._emptyTitles||(t[0].title="Delta",t[1].title="Max(Up, Down)",t[2].title="Total")}const n=this._study.priceScale(),a=this._model.timeScale();if(null===n||n.isEmpty()||a.isEmpty()||this._hideValues())return t;if(null===e||!isFinite(e)){const i=this._study.data().last();if(null===i)return t;e=i.index}const l=this._model.crossHairSource(),u=l.price;if(!isFinite(l.y)&&null===(e=function(e,t){const i=e.visibleBarsStrictRange()?.lastBar();if(!i)return null;const s=t.data().search(i,o.PlotRowSearchMode.NearestLeft);return s?s.index:null}(this._model.timeScale(),this._model.mainSeries())))return t;const d=function(e,t,i,s){if(0===e.size)return null;if(!i){const e=(0,r.ensureNotNull)(s.data().valueAt(t));i=s.barFunction()(e)}const n=function(e,t){let i=null;return e.forEach(((e,s)=>{null!==s&&s<=t&&(null===i||s>i)&&(i=s)})),i}(e,t);if(null===n)return null;const o=e.get(n);if(!o||0===o.size)return null;return function(e,t){let i=null;return e.forEach((e=>{e.priceLow<=t&&t<e.priceHigh&&(i=e)})),i}(o,i)}(this._study.graphics().hhistsByTimePointIndex(),e,u,this._model.mainSeries());if(null===d)return t.forEach((e=>{e.value="0"})),t;const p=this._study.metaInfo().graphics.hhists;if(void 0===p)return t;if(void 0===p[d.styleId])return t;const f=this._study.properties().childs().graphics.childs().hhists?.childs()[d.styleId]?.childs(),m=e=>(0,s.isNumber)(e)?_.format(e):"";if(i!==h.HHistVolumeMode.Delta){if(d.rate.forEach(((e,i)=>{t[i].value=m(e),t[i].color=(0,r.ensureDefined)(f).colors[i].value()})),i===h.HHistVolumeMode.UpDown){const e=d.rate[0]+d.rate[1];t[2].value=m(e),t[2].color=(0,r.ensureDefined)(f).valuesColor.value()}}else{const e=d.rate[0]>d.rate[1]?0:1,i=(0,
r.ensureDefined)(f).colors[e].value(),s=d.rate[0]+d.rate[1];[2*d.rate[e]-s,d.rate[e],s].forEach(((e,s)=>{t[s].value=m(e),t[s].color=i}))}return t}_hideValues(){return p&&(null===this._model.crossHairSource().pane||(0,u.isLineToolName)(a.tool.value())||null!==this._model.lineBeingEdited())}}},242337:(e,t,i)=>{i.d(t,{StudyBaseWindowView:()=>n});var s=i(49839),r=i(287741);class n extends s.DataWindowView{constructor(e,t){super(),this._invalidated=!0,this._study=e,this._model=t,this._valueProvider=this._createValuesProvider(e,t),this._items=this._valueProvider.getItems().map((e=>new s.DataWindowItem(e.id,e.title,""))),this.update()}update(){this._invalidated=!0}items(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._items}study(){return this._study}_updateImpl(){this._header=this._study.title(r.TitleDisplayTarget.DataWindow,!0),this._title=this._study.title(r.TitleDisplayTarget.DataWindow);const e=this._valueProvider.getValues(this._currentIndex());for(let t=0;t<e.length;++t){const i=e[t],s=this._items[t];s.setValue(i.value),s.setVisible(i.visible),s.setColor(i.color),s.setTitle(i.title)}}_currentIndex(){const e=this._model.crossHairSource().appliedIndex();return isNaN(e)?null:e}}},193938:(e,t,i)=>{i.d(t,{StudyDataWindowView:()=>n});var s=i(242337),r=i(316980);class n extends s.StudyBaseWindowView{canShowItems(){const e=this._model.paneForSource(this._study);return!!e?.maximized().value()||this._model.panes().every((e=>!e.maximized().value()))}_createValuesProvider(e,t){return new r.StudyDataWindowValuesProvider(e,t)}}},316980:(e,t,i)=>{i.d(t,{StudyDataWindowValuesProvider:()=>n});var s=i(911144),r=i(156863);class n{constructor(e,t){this._study=e,this._model=t,this._hhistBasedStudy=void 0!==e.metaInfo().graphics.hhists,this._valuesProvider=this._createValuesProvider(e,t)}getItems(){return this._valuesProvider.getItems()}getValues(e){const t=this._valuesProvider.getValues(e),i=e=>!!this._hhistBasedStudy||this._study.isPlotVisibleAt(e,2);for(const e of t)e.visible=e.visible&&i(e.id);return t}_createValuesProvider(e,t){return this._hhistBasedStudy?new r.HHistBasedValuesProvider(e,t):new s.StudyValuesProvider(e,t)}}},843563:(e,t,i)=>{i.d(t,{StudyLegendValuesProvider:()=>n});var s=i(911144),r=i(156863);class n{constructor(e,t,i,s){this._study=e,this._model=t,this._showStudyValues=s??t.properties().childs().paneProperties.childs().legendProperties.childs().showStudyValues,this._hhistBasedStudy=void 0!==e.metaInfo().graphics.hhists,this._valuesProvider=this._createValuesProvider(e,t,i)}getItems(){return this._valuesProvider.getItems()}getValues(e){const t=this._valuesProvider.getValues(e),i=this._study.properties(),s=this._showStudyValues.value()&&i.childs().showLegendValues.value(),r=e=>!!this._hhistBasedStudy||this._study.isPlotVisibleAt(e,8);for(const e of t)e.visible=e.visible&&s&&r(e.id);return t}_createValuesProvider(e,t,i){return this._hhistBasedStudy?new r.HHistBasedValuesProvider(e,t,i):new s.StudyValuesProvider(e,t,i)}}},181945:(e,t,i)=>{i.d(t,{StudyStatusProvider:()=>l})
;var s=i(444372),r=i(757402),n=i(971417),o=i(170411);const a=s.t(null,void 0,i(224077));class l extends o.StudyStatusProviderBase{sourceStatusText(){const e=this._source;if(e.status().type===r.StudyStatusType.Error){const t=e.metaInfo(),i=(0,n.extractPineId)(t.fullId);if(t.scriptIdPart&&(0,n.isEdgrPineId)(t.scriptIdPart)||i&&(0,n.isEdgrPineId)(i))return a}return super.sourceStatusText()}}},911144:(e,t,i)=>{i.d(t,{StudyValuesProvider:()=>S});var s=i(150335),r=i(638456),n=i(432059),o=i(764829),a=i(518439),l=i(627620),h=i(419283),u=i(748947),c=i(962973),d=i(296842),p=i(498830),_=i(650151),f=i(581899),m=i(287741);const y=r.CheckMobile.any(),g=o.enabled("hide_last_na_study_output"),v=o.enabled("always_show_legend_values_on_mobile");class S{constructor(e,t,i){this._emptyValues=[],this._colorProviders=new Map,this._study=e,this._model=t,this._studyMetaInfo=this._study.metaInfo(),this._studyProperties=this._study.properties().childs(),this._isFundamental=(0,d.isFundamentalStudyMetaInfo)(this._studyMetaInfo);const s=this._studyMetaInfo.plots;s&&s.forEach(((e,t)=>{if((0,u.isPlotWithTechnicalValues)(e))return;const s=e.id;this._emptyValues.push(function(e,t="",i=""){return{id:t,index:e,title:i,value:"",visible:!1}}(t,s,i?"":this._study.guiPlotName(m.TitleDisplayTarget.StatusLine,s)));const r=(0,u.isOhlcPlot)(e)?e.target:s;this._colorProviders.set(r,(0,c.createStudyPlotColorProvider)(this._studyMetaInfo,this._study.properties(),r))}))}getItems(){return this._emptyValues}getPlotColor(e,t){const i=t[e+1];if(!(0,s.isNumber)(i))return"";const r=i>0;let n;const o=this._studyMetaInfo.plots[e];let a=o.id;const l=this._studyProperties;if((0,u.isOhlcPlot)(o))a=o.target||a,n=(0,_.ensureDefined)(l.ohlcPlots.childs()[a].childs().color).value();else if((0,u.isArrowsPlot)(o)){const e=(0,_.ensureDefined)(l.styles.childs()[a]);n=r?e.childs().colorup.value():e.childs().colordown.value()}else n=(0,_.ensureDefined)(l.styles.childs()[a]?.child("color")).value();let h=n;const c=this._colorProviders.get(a),d=c&&c.getPlotPointStyle(t);return d&&((0,u.isArrowsPlot)(o)?(r&&void 0!==d.colors[5]&&(h=d.colors[5]),r||void 0===d.colors[6]||(h=d.colors[6])):void 0!==d.colors[0]&&(h=d.colors[0])),"transparent"===h&&(h=n),h}getValues(e){const t=this._emptyValues.map((e=>({...e})));let i=null;const r=this._study.data().lastIndex(),o=this._studyProperties;if(null!==r)for(const e of t){const t=o.styles.childs()[e.id]?.childs().display.value();if(0===t)continue;const s=this._study.nearestIndex(r,a.PlotRowSearchMode.NearestLeft,e.index+1);if(void 0===s)continue;const n=s+this._study.offset(e.id);i=null!==i?Math.max(n,i):n}(null===e||null!==i&&e>i)&&(e=i);const l=this._hideValues(),h=this._study.isVisible()&&!l?f.notAvailable:"";for(const e of t)e.value=h;if(l)return t;g&&t.length&&(t[t.length-1].value="");const c=this._study.priceScale();if(!this._study.isVisible()||null===e||null===c||c.isEmpty()||this._model.timeScale().isEmpty())return t;const d={};for(const i of t){const t=i.id,l=(0,p.getPriceValueFormatterForStudy)(this._study,t),h=(0,
_.ensureDefined)(o.styles.childs()[t]),c=h.childs().display.value();if(i.visible=0!==c,!i.visible)continue;const f=h.hasChild("plottype")?h.child("plottype")?.value():null,m=this._isFundamental&&(f===u.LineStudyPlotStyle.StepLine||f===u.LineStudyPlotStyle.StepLineWithDiamonds),y=i.index,g=e-this._study.offset(t),v=m||null!==r&&g>r?a.PlotRowSearchMode.NearestLeft:a.PlotRowSearchMode.Exact,S=this._study.nearestIndex(g,v);if(void 0===S)continue;let b=d[t];if(void 0===b&&(b=this._study.getMinFirstBarIndexForPlot(t),Number.isFinite(b)&&(d[t]=b)),b>S)continue;const I=this._study.data().last(),P=this._study.data().valueAt(S)||(null!==I?I.value:null);if(null===P)continue;const w=P[y+1];(0,s.isNumber)(w)&&(i.value=l(w),i.color=(0,n.resetTransparency)(this.getPlotColor(y,P)))}return t}_hideValues(){return v?(0,l.isLineToolName)(h.tool.value())||null!==this._model.lineBeingEdited():y&&(null===this._model.crossHairSource().pane||(0,l.isLineToolName)(h.tool.value())||null!==this._model.lineBeingEdited())}}},924166:(e,t,i)=>{i.d(t,{EXCLUDED_FOR_ALERT_ID_INPUTS:()=>_,collectDepsForAlert:()=>y,plotsForAlert:()=>m});var s=i(802564),r=i(650151),n=i(218049),o=i(338619),a=i(675647),l=i(637761),h=i(732634),u=i(748947);const c=(0,o.getLogger)("Chart.Study");function d(e,t,i){void 0!==i&&i.forEach((i=>{const s=e[i];"string"==typeof s?e[i]=p(s,t):(0,n.isExtendedInput)(s)&&(0,n.isExtendedInputSource)(s)?s.v=p((0,n.getInputValue)(s),t):c.logError(`Cannot patch source input, its type is not source: ${JSON.stringify(s)}`)}))}function p(e,t){const[i,s]=e.split("$"),r=t.get(i);return r?r+(void 0===s?"":"$"+s):e}const _=["text","pineFeatures"];function f(e){return(0,s.default)(e,_)}function m(e,t){const i=[u.isLinePlot,u.isShapesPlot,u.isCharsPlot,u.isArrowsPlot,u.isOhlcPlot,u.isAlertConditionPlot];return e.plots.map(((e,t)=>({...e,pinePlotIndex:t}))).filter((e=>i.some((t=>t(e))))).map((i=>{const s={id:i.id,type:i.type,pinePlotIndex:i.pinePlotIndex,offset:t(i.id)};if(e.styles&&void 0!==e.styles[i.id]){const t=(0,r.ensureDefined)((0,r.ensureDefined)(e.styles)[i.id]);s.title=t.title||"",s.text=t.text||""}return(0,u.isOhlcPlot)(i)&&i.target&&e.ohlcPlots&&e.ohlcPlots[i.target]&&(s.ohlcTitle=(0,r.ensureDefined)((0,r.ensureDefined)(e.ohlcPlots)[i.target]).title),s}))}function y(e,t){const i=[],s=new Map;let n;for(let r=e.length-1;r>=0;r--){const o=e[r],u=(0,a.extractStudyId)(o.metaInfo().id),c=l.StudyMetaInfo.getStudyIdWithLatestVersion(o.metaInfo());n=o.inputsForAlertState();d(n,s,o.metaInfo().inputs.filter((e=>"source"===e.type)).map((e=>e.id)));const p=o.metaInfo().isTVScript?f(n):n,_=(0,h.getStudyIdForAlert)(u,p,t);i.push({id:_,study:c,inputs:n}),s.set(o.id(),_)}const o=i.reverse();return{idForAlert:(0,r.ensureDefined)(o[0].id),inputsForAlert:(0,r.ensureDefined)(n),studyDependencies:o}}},689052:(e,t,i)=>{i.r(t),i.d(t,{Study:()=>fi});var s=i(650279),r=i(154834),n=i(998034),o=i(650151),a=i(444372),l=i(338619),h=i(879938),u=i(716004),c=i(682170),d=i(799878),p=i(19303),_=i(218049),f=i(230839);function m(e){const t=new Set
;e.metaInfo().historyCalculationMayChange&&t.add(p.DataSourceDangerReason.PineRepainting);for(const i of Object.values(e.inputs()))if((0,_.isExtendedInput)(i)&&"symbol"===i.t){const s=e.resolvedSymbolInfoBySymbol(i.v);"spread"===s?.type&&t.add(p.DataSourceDangerReason.Spread),"CRYPTOCAP"===s?.exchange&&t.add(p.DataSourceDangerReason.CryptoCap)}for(const i of e.parentSources())(0,f.addToSet)(t,m(i));const i=e.ownerSource();return e.isChildStudy()&&i&&(0,f.addToSet)(t,m(i)),t}function y(e){const[t]=m(e);return t??null}var g=i(924166),v=i(675647),S=i(500013),b=i(923451),I=i(590508),P=i(640146),w=i(545437),C=i(120984),x=i(942634),V=i(432059),A=i(355468),M=i(979351),R=i(475892),D=i(704670),T=i(55243),O=i(637761),F=i(381401),B=i(518439),N=i(497503),k=i(242337),E=i(843563),L=i(748947);class H extends k.StudyBaseWindowView{constructor(e,t){super(e,t),this._showStudyValues=t.properties().childs().paneProperties.childs().legendProperties.childs().showStudyValues,this._showStudyValues.subscribe(this,this.update);const i=this._study.properties();i.childs().showLegendValues.subscribe(this,this.update);const s=this._study.metaInfo().plots,r=new Set;s.forEach((e=>{if((0,L.isOhlcPlot)(e)){const t=e.target;if(r.has(t))return;r.add(t),i.childs().ohlcPlots.childs()[t].childs().display.subscribe(this,this.update)}else(0,L.isPlotSupportDisplay)(e)&&i.childs().styles.childs()[e.id]?.childs().display.subscribe(this,this.update)}))}areValuesVisible(){return this._showStudyValues.value()}additional(){return null}destroy(){this._showStudyValues.unsubscribeAll(this);const e=this._study.properties();e.childs().showLegendValues.unsubscribeAll(this);const t=this._study.metaInfo().plots,i=new Set;t.forEach((t=>{if((0,L.isOhlcPlot)(t)){const s=t.target;if(i.has(s))return;i.add(s),e.childs().ohlcPlots.childs()[s].childs().display.unsubscribe(this,this.update)}else(0,L.isPlotSupportDisplay)(t)&&e.childs().styles.childs()[t.id]?.childs().display.unsubscribe(this,this.update)}))}_createValuesProvider(e,t){return new E.StudyLegendValuesProvider(e,t)}}var W=i(419283),U=i(323719),z=i(882782),G=i(362805),j=i(124066),$=i(181945),K=i(124829),q=i(287741),Y=i(828473),J=i(401809);class X{constructor(e,t,i=!1){this.price=t,this.index=e,this.useMainSeriesForPriceRange=i}}var Z=i(597461);function Q(e,t,i,s){if(e.y1===e.y2)return function(e,t,i){return(0,o.assert)(e.y1===e.y2),(0,Z.doesItemAffectVisibleRange)(e.x1,e.x2,e.extend,t,i)?[new X(t,e.y1,!1),new X(i,e.y2,!1)]:[]}(e,i,s);const r=[];return null!==e.x1&&r.push(new X(e.x1,e.y1,!1)),null!==e.x2&&r.push(new X(e.x2,e.y2,!1)),r}function ee(e,t,i,s){return e.points.filter((e=>e.x>=i&&e.x<=s)).map((e=>new X(e.x,e.y,!1)))}function te(e,t,i,s){return(0,Z.doesItemAffectVisibleRange)(e.left,e.right,e.extend,i,s)?[new X(i,e.top,!1),new X(s,e.bottom,!1)]:[]}var ie=i(15141);function se(e,t,i,s){let r;const n=e.yloc!==ie.DwgLabelYloc.Price&&e.yloc!==ie.DwgLabelYloc.Auto;if(n){const i=e.yloc===ie.DwgLabelYloc.AboveBar?2:3,s=t.valueAt(e.x);null!==s&&(r=s[i])}else r=e.y;return null==r?null:[new X(e.x,r,n)]}
function re(e,t,i,s,r,n){if(!(0,Z.doesItemAffectVisibleRange)(e.firstBarTime,e.lastBarTime,Z.DwgExtend.None,i,s))return[];let o=1/0,a=-1/0;for(const[t,i]of r.tpoBlockSets())if(n===t)for(const t of i.get(e.id)||[])o=Math.min(o,t.rowIndex*e.priceRange),a=Math.max(a,(t.rowIndex+1)*e.priceRange);return Number.isFinite(o)?[new X(i,a,!1),new X(s,o,!1)]:[]}class ne{constructor(e,t,i,s,r){this._mapGetter=e,this._study=t,this._bars=t.series().bars(),this._visibilityGetter=i,this._getPoints=s,this._getMargins=r}groupPriceRange(e,t,i){let s=null;const r=this._study.graphics();for(const[n,o]of this._mapGetter(i))if(this._visibilityGetter(n))for(const i of o){const o=this._getPoints(i,this._bars,e,t,r,n);if(null===o)continue;let a=1/0,l=-1/0,h=!1,u=!1,c=!1;for(const i of o){const s=i.index<=t,r=i.index>=e;h=h||s,u=u||r,c=c||s&&r;let n=i.price,o=i.price;if(i.useMainSeriesForPriceRange){const e=this._bars.valueAt(i.index);if(null===e)continue;const t=e[2];if(null==t)continue;const s=e[3];if(null==s)continue;n=s,o=t}n<a&&(a=n),o>l&&(l=o)}if(!(c||h&&u))continue;const d=new D.PriceRange(a,l);s=null===s?d:s.merge(d)}return s}firstValue(e,t){let i=1/0,s=1/0,r=-1/0,n=1/0,o=1/0,a=1/0;const l=this._study.graphics();for(const[h,u]of this._mapGetter(!1))if(this._visibilityGetter(h))for(const c of u){const u=this._getPoints(c,this._bars,e,t,l,h);if(null!==u)for(const l of u){const h=l.index;h>=e&&h<=t&&h<i?(i=h,s=l.price):h<e&&h>r?(r=h,n=l.price):h>t&&h<o&&(o=h,a=l.price)}}return{firstVisible:i===1/0?null:new X(i,s),leftClosest:r===-1/0?null:new X(r,n),rightClosest:o===1/0?null:new X(o,a)}}groupPixelMargins(e,t,i){if(!this._getMargins)return oe();const s=oe();if(null===this._study.priceScale())return s;if(null===this._study.firstValue())return s;const r=this._study.graphics();for(const[n,o]of this._mapGetter(i))if(this._visibilityGetter(n))for(const i of o){const o=this._getPoints(i,this._bars,e,t,r,n);if(null===o)continue;if(0===o.filter((i=>{const s=i.index;return s>=e&&s<=t})).length)continue;const a=this._getMargins(i,this._bars);s.bottomPixelMargin=Math.max(s.bottomPixelMargin,a.bottomPixelMargin),s.topPixelMargin=Math.max(s.topPixelMargin,a.topPixelMargin)}return s}}const oe=()=>({bottomPixelMargin:0,topPixelMargin:0});function ae(e){const t=(0,o.ensureDefined)(e.properties().childs().graphics).childs();return[new ne((()=>(0,Y.mapEntriesGenerator)(e.graphics().tpos())),e,(e=>{const i=(0,o.ensureDefined)(t.tpoBlockSets).childs()[e].childs();return i.showLetters.value()||i.showBlocks.value()||(0,o.ensureDefined)(t.tpoVolumeRows).childs()[e].childs().visible.value()}),re,oe),new ne((t=>(0,Y.nestedMapGenerator)(e.graphics().dwglabels(),t)),e,(e=>(0,o.ensureDefined)(t.dwglabels).childs()[e].childs().visible.value()),se,J.calculateDwgLabelsMargins.bind(null,e)),new ne((t=>(0,Y.nestedMapGenerator)(e.graphics().dwglines(),t)),e,(e=>(0,o.ensureDefined)(t.dwglines).childs()[e].childs().visible.value()),Q,oe),new ne((t=>(0,Y.nestedMapGenerator)(e.graphics().dwgpolylines(),t)),e,(e=>(0,
o.ensureDefined)(t.dwgpolylines).childs()[e].childs().visible.value()),ee,oe),new ne((t=>(0,Y.nestedMapGenerator)(e.graphics().dwgboxes(),t)),e,(e=>(0,o.ensureDefined)(t.dwgboxes).childs()[e].childs().visible.value()),te,oe),new ne((t=>function*(e,t){const i=e.dwglines(),s=e.dwglinefills(),r=new Map;i.forEach((e=>{if(void 0===t)e.forEach((e=>{e?.forEach((e=>{r.set(e.id,e)}))}));else{const i=e.get(t);i?.forEach((e=>{r.set(e.id,e)}))}}));for(const[e,t]of s){const i=Array.from(t).filter((e=>r.has(e.line1)));i.length&&(yield[e,new Set(i)])}}(e.graphics(),t)),e,(e=>(0,o.ensureDefined)(t.dwglinefills).childs()[e].childs().visible.value()),((t,i,s,r)=>{const n=new Map;for(const[,t]of e.graphics().dwglines())for(const[,e]of t)for(const t of e)n.set(t.id,t);return function(e,t,i,s,r){const n=e.get(t.line1),o=e.get(t.line2);return void 0!==n&&void 0!==o&&((0,Z.doesItemAffectVisibleRange)(n.x1,n.x2,n.extend,s,r)||(0,Z.doesItemAffectVisibleRange)(o.x1,o.x2,o.extend,s,r))?[new X(s,n.y1,!1),new X(r,n.y2,!1),new X(s,o.y1,!1),new X(r,o.y2,!1)]:[]}(n,t,0,s,r)}),oe)]}function le(e,t,i){return null===t?e:null===e?t:e.index<t.index?i?t:e:i?e:t}class he{constructor(){this.firstVisible=null,this.leftClosest=null,this.rightClosest=null}improve(e){this.firstVisible=le(this.firstVisible,e.firstVisible,!0),this.leftClosest=le(this.leftClosest,e.leftClosest,!0),this.rightClosest=le(this.rightClosest,e.rightClosest,!1)}bestPrice(){return null!==this.firstVisible?this.firstVisible.price:null!==this.leftClosest?this.leftClosest.price:null!==this.rightClosest?this.rightClosest.price:null}}var ue=i(175203),ce=i(971417),de=i(296842),pe=i(354957),_e=i(322825),fe=i(272933);function me(e,t){return e.studyId.localeCompare(t.studyId)}function ye(e){const t=new Set,i=[];return e.forEach((e=>{t.has(e.studyId)||(t.add(e.studyId),i.push(e))})),i}function ge(e){const t=e.model().mainSeries();return{studyId:(0,o.ensureNotNull)(e.sourceId()),turnaround:e.turnaround(),sourceStudies:e.parentSources().filter((e=>e!==t)).map((e=>ge(e)))}}var ve=i(764829),Se=i(982949),be=i(961970);class Ie extends be.BitmapCoordinatesPaneRenderer{constructor(e){super(),this._data=e}hitTest(e){return null}_drawImpl(e){}_drawBackgroundImpl(e){const{context:t,horizontalPixelRatio:i,bitmapSize:s}=e,r=this._data;for(let e=0;e<r.items.length;++e){const n=r.items[e];if(null==n.color)continue;t.fillStyle=n.color;const o=Math.round(n.left*i)+1,a=Math.round(n.right*i);t.fillRect(o,0,a-o+1,s.height)}}}var Pe=i(962973),we=i(249121);class Ce extends we.StudyForceOverlayPlotView{constructor(e,t,i,s){super(t,i,s),this._items=[],this._invalidated=!0,this._isMarkersEnabled=ve.enabled("source_selection_markers"),this._study=e;const r=this._study.metaInfo().plots;for(let e=0;e<r.length;e++){const t=r[e];t.id===this._plotName&&(this._plotIndex=e,(0,o.assert)((0,L.isBgColorerPlot)(t),"Plot '"+this._plotName+"' is not a background colorer!"))}this._colorProvider=(0,Pe.createStudyPlotColorProvider)(e.metaInfo(),e.properties(),s)}items(){return this._items}update(){this._invalidated=!0}renderer(){if(1&~(0,
o.ensureDefined)(this._study.properties().childs().styles.childs()[this._plotName]).childs().display.value())return null;if(!this._scalesReady())return null;this._invalidated&&(this._updateImpl(),this._invalidated=!1);const e={items:this._items},t=new Se.CompositeRenderer;return t.append(new Ie(e)),t}_scalesReady(){const e=this._model.timeScale(),t=this._priceScale();return e&&!e.isEmpty()&&null!==t&&!t.isEmpty()}_getTranspValue(){const e=(0,o.ensureDefined)(this._study.properties().childs().styles.childs()[this._plotName]).childs();let t=0;return e.transparency&&(t=e.transparency.value(),t=(0,K.isNumber)(t)?t:40),t}_updateImpl(){this._items=[],(0,o.assert)(this._scalesReady(),"Scales must be ready!");const e=this._model.timeScale().visibleBarsStrictRange();if(null===e)return;const t=this._getTranspValue();let i=(0,o.ensureDefined)(this._series.nearestIndex(e.firstBar(),B.PlotRowSearchMode.NearestRight)),s=(0,o.ensureDefined)(this._series.nearestIndex(e.lastBar(),B.PlotRowSearchMode.NearestLeft));const r=this._study.offset(this._plotName);r>0?(i-=r,s+=r):(i+=r,s-=r);const n=this._study.getMinFirstBarIndexForPlot(this._plotName);if(n>s)return;i=Math.max(n,i);const a=this._study.data();for(const e of a.rangeIterator(i,s)){let i=e.index;const s=e.value;i+=r;const n={timePointIndex:Math.floor(i),left:NaN,center:NaN,right:NaN};let a=(0,K.isNumber)(t)?t:50;a=Math.min(a,100),a=Math.max(a,0);const l=this._colorProvider.getPlotPointStyle(s);void 0!==l.colors[1]&&(n.color=(0,V.generateColor)((0,o.ensureDefined)(l.colors[1]),a)),this._items.push(n)}this._model.timeScale().fillBarBorders(this._items)}}var xe=i(112377),Ve=i(359658),Ae=i(750139),Me=i(836687),Re=i(368628),De=i(40563),Te=i(354012),Oe=i(381065),Fe=i(744688),Be=i(743537),Ne=i(754533),ke=i(819788),Ee=i(311156),Le=i(975696),He=i(245356),We=i(337827);const Ue=new Map;Ue.set("PaneRendererArrowUp",Te.PaneRendererArrowUp),Ue.set("PaneRendererArrowDown",Te.PaneRendererArrowDown),Ue.set("PaneRendererCircleShape",Oe.PaneRendererCircleShape),Ue.set("PaneRendererCrossShape",Fe.PaneRendererCrossShape),Ue.set("PaneRendererDiamond",Be.PaneRendererDiamond),Ue.set("PaneRendererFlagShape",Ne.PaneRendererFlagShape),Ue.set("PaneRendererLabelUp",ke.PaneRendererLabelUp),Ue.set("PaneRendererLabelDown",ke.PaneRendererLabelDown),Ue.set("PaneRendererSquare",Ee.PaneRendererSquare),Ue.set("PaneRendererTriangleApexUp",Le.PaneRendererTriangleApexUp),Ue.set("PaneRendererTriangleApexDown",Le.PaneRendererTriangleApexDown),Ue.set("PaneRendererXCross",He.PaneRendererXCross);class ze extends We.StudyPaneViewInplaceUpdatable{constructor(e,t,i,s){super(t,i,s),this._renderer=null,this._shapesRenderer=null,this._selectionRenderer=null,this._isMarkersEnabled=ve.enabled("source_selection_markers"),this._study=e;const r=e.metaInfo().plots;for(let e=0;e<r.length;e++)if(r[e].id===this._plotName){this._plotIndex=e;break}this._plotStyleInfo=(0,o.ensureDefined)(e.metaInfo().styles?.[this._plotName]),this._colorProvider=(0,Pe.createStudyPlotColorProvider)(e.metaInfo(),e.properties(),s),
this._selectionIndexer=new Me.SelectionIndexes(i.timeScale())}items(){return this._items}renderer(){return this._isPlotVisible()&&this._scalesReady()?(this._makeSureRendererIsValid(),this._renderer):null}_isPlotVisible(){return this._study.isPlotVisibleAt(this._plotName,1)}_scalesReady(){const e=this._model.timeScale(),t=this._priceScale();return e&&null!==t&&!e.isEmpty()&&!t.isEmpty()}_updateImplFull(e){if(this._dataInvalidated?.clearData&&(this._items=[],this._renderer=null),!this._scalesReady())return!1;const t=this._model.timeScale(),i=this._priceScale(),s=t.visibleBarsStrictRange();if(null===s||null===i)return!1;const r=this._study.plots().plottableRange(!1);if(0===r.size())return!1;const n=this._study.offset(this._plotName),a=this._study.firstValue(void 0,this.isForceOverlay());if(null===a)return!1;this._updateAdditionalPrices(i,a);const{hiPlot:l,loPlot:h}=this._hiLoPlots(),u=this._preallocateItems(r,((e,t)=>this._createItem(e,t??null,l,h,n)));let c=this._series.nearestIndex(s.firstBar(),B.PlotRowSearchMode.NearestRight),d=this._series.nearestIndex(s.lastBar(),B.PlotRowSearchMode.NearestLeft);if(void 0===c||void 0===d)return!1;n>0?(c-=n,d+=n):(c+=n,d-=n);const p=this._study.getMinFirstBarIndexForPlot(this._plotName);if(p>d)return!0;c=Math.max(p,c);const _=this._getTranspValue(),f=this._study.properties().childs().styles.childs()[this._plotName].childs(),m=f.color.value(),y=f.textColor?f.textColor.value():void 0,g=m,v=m,S=void 0===y?void 0:y,b=(0,o.ensureNotNull)(this._plotIndex),I=(0,De.createEmptyStyle)(),P=u??(0,o.ensureNotNull)(r.firstIndex()),w=r.rangeIterator(P,(0,o.ensureNotNull)(r.lastIndex())+1);let C=(0,Y.lowerbound)(this._items,P+n,((e,t)=>e.timePointIndex<t));for(const e of w){const t=e.value,i=t[b+1];if(null==i){C++;continue}const s=this._items[C];if(!isNaN(s.origPrices.price)){if(this._colorProvider.isColorDefined()){s.style={color:g,borderColor:v,textColor:S};const e=this._colorProvider.getPlotPointStyle(t,I);this._fillItemWithPointStyle(s,e,_)}}C++}return this._updateImplLight(),!0}_fillItemWithPointStyle(e,t,i){const s=(0,o.ensureDefined)(e.style);if(void 0!==t.colors[0]){s.color=(0,V.generateColor)((0,o.ensureDefined)(t.colors[0]),i);const e=i>9?i-10:0;s.borderColor=(0,V.generateColor)(s.color,e)}void 0!==t.colors[2]&&(s.textColor=(0,V.generateColor)((0,o.ensureDefined)(t.colors[2]),i))}_updateRenderer(e,t){this._makeSureRendererIsValid();const i=this._model.timeScale(),s={},r=this._getTranspValue(),n=i.barSpacing(),o=this._calculateShapeHeight(n),a=this._study.properties().childs().styles.childs()[this._plotName].childs(),l=a.location.value(),h=this._calculateVerticalOffset(l,o+o/2);s.barSpacing=n,s.items=this._items,s.color=(0,V.generateColor)(a.color.value(),r),s.height=o,s.vertOffset=h,s.visibleItemsRange={startItemIndex:e,endItemIndex:t};const u=a.plottype.value(),c=Ve.plotShapesData[u],d=new Se.CompositeRenderer;c&&(this._shapesRenderer?this._shapesRenderer.setData(s):(this._shapesRenderer=this._createRenderer(c.paneRendererClass,s),d.append(this._shapesRenderer))),
this._model.selection().isSelected(this._study)&&this._isMarkersEnabled&&null!==this._selectionData&&(this._selectionData.vertOffset=h,d.append(new xe.SelectionRenderer(this._selectionData))),this._renderer=d}_createRenderer(e,t){const i=Ue.get(e);return new((0,o.ensureDefined)(i))(t)}_getSeriesVal(e,t){const i=(0,Re.barFunction)(e),s=this._series.data().valueAt(t);return null===s?null:i(s)}_getTranspValue(){let e=0;const t=this._study.properties().childs();t.transparency&&(e=t.transparency.value(),e=(0,K.isNumber)(e)?e:50);const i=t.styles.childs()[this._plotName].childs();return i.transparency&&(e=i.transparency.value(),e=(0,K.isNumber)(e)?e:50),(0,Ae.clamp)(e,0,100)}_createItem(e,t,i,s,r){const n=this._study.properties().childs().styles.childs()[this._plotName].childs().location.value(),a={origPrices:{price:NaN},timePointIndex:e+r};if((null===t||0===t)&&n!==N.MarkLocation.Absolute)return a;if(null==t)return a;let l=NaN;switch(n){case N.MarkLocation.AboveBar:{const t=this._getLocationPrice(e,i,r);if(null===t)return a;l=t;break}case N.MarkLocation.BelowBar:{const t=this._getLocationPrice(e,s,r);if(null===t)return a;l=t;break}case N.MarkLocation.Absolute:l=(0,o.ensureNotNull)(t);break;case N.MarkLocation.Top:case N.MarkLocation.Bottom:l=0;break;default:throw new Error("Bad value: "+n)}return{y:NaN,origPrices:{price:l},timePointIndex:e+r}}_dependsOnSeriesData(){const e=this._study.properties().childs().styles.childs()[this._plotName].childs().location.value();return e===N.MarkLocation.AboveBar||e===N.MarkLocation.BelowBar}_getValueForUpdating(e){const t=e.value[this._plotIndex+1];if(null==t)return null;const i=this._study.properties().childs().styles.childs()[this._plotName].childs().location.value();if(0===t&&i!==N.MarkLocation.Absolute)return null;const s=this._study.offset(this._plotName),{hiPlot:r,loPlot:n}=this._hiLoPlots();switch(i){case N.MarkLocation.AboveBar:return this._getLocationPrice(e.index,r,s);case N.MarkLocation.BelowBar:return this._getLocationPrice(e.index,n,s)}return super._getValueForUpdating(e)}_convertItemsToCoordinates(e,t,i,s){for(let e=i;e<s;e++){const t=this._items[e];t.y=t.origPrices.price}this._model.timeScale().fillBarBorders(this._items);const r=this._study.properties().childs().styles.childs()[this._plotName].childs().location.value(),n=e.height()*e.topMargin(),o=e.height()*(1-e.bottomMargin()),a=e.isInverted(),l=a?o:n,h=a?n:o,u=e=>{for(let t=i;t<s;t++)isNaN(this._items[t].y)||(this._items[t].y=e)};switch(r){case N.MarkLocation.Top:u(l);break;case N.MarkLocation.Bottom:u(h);break;default:e.pointsArrayToCoordinates(this._items,t,{startItemIndex:i,endItemIndex:s})}}_calculateVerticalOffset(e,t){let i=0;switch(e){case N.MarkLocation.AboveBar:case N.MarkLocation.Bottom:i=-t;break;case N.MarkLocation.BelowBar:case N.MarkLocation.Top:i=t}return(0,o.ensureNotNull)(this._priceScale()).isInverted()&&(i*=-1),i}_calculateShapeHeight(e,t){let i=e;switch(t){case L.PlotSymbolSize.Tiny:i=.3*e;break;case L.PlotSymbolSize.Small:i=.6*e;break;case L.PlotSymbolSize.Normal:i=e;break
;case L.PlotSymbolSize.Large:i=1.5*e;break;case L.PlotSymbolSize.Huge:i=2*e}return"number"==typeof t&&t>0&&(i=t),i}_hiLoPlots(){let e,t;let i=null;switch(this._series.properties().childs().style.value()){case 2:i="lineStyle";break;case 14:i="lineWithMarkersStyle";break;case 15:i="steplineStyle";break;case 3:i="areaStyle"}return i?(e=this._series.properties().childs()[i].childs().priceSource.value(),t=e):(e="high",t="low"),{hiPlot:e,loPlot:t}}_getLocationPrice(e,t,i){const s=Math.min(e+i,(0,o.ensureNotNull)(this._series.data().last()).index);return this._getSeriesVal(t,s)}}class Ge extends ze{_updateRenderer(e,t){const i=this._study.properties().childs().styles.childs()[this._plotName].childs(),s=this._model.timeScale(),r={},n=this._getTranspValue(),o=s.barSpacing();let a;a=this._plotStyleInfo.size?this._calculateShapeHeight(25,this._plotStyleInfo.size):Math.round(o/2),a=Math.max(a,1);const l=i.location.value(),h=(0,V.generateColor)(i.color.value(),n),c=n>19?n-10:0,d=this._calculateVerticalOffset(l,Math.round(1.5*a));r.barSpacing=o,r.items=this.items(),r.color=h,r.borderColor=(0,V.generateColor)(i.color.value(),c),r.height=a,r.vertOffset=d,r.visibleItemsRange={startItemIndex:e,endItemIndex:t};const p=i.plottype.value(),_=Ve.plotShapesData[p],f=this._plotStyleInfo.text;if(void 0!==f&&""!==f.trim()){let e=f.replace(/\\n/gm,"\n");e=(0,u.cleanButAmpersand)(e,!0),r.text=e,r.fontSize=12;const t=i.textColor?i.textColor.value():void 0;r.textColor=t?(0,V.generateColor)(t,n):h}if(this._renderer&&this._shapesRenderer&&this._selectionRenderer)this._shapesRenderer.setData(r),this._model.selection().isSelected(this._study)&&this._isMarkersEnabled&&null!==this._selectionData?(this._selectionData.vertOffset=d,this._selectionRenderer.setData(this._selectionData)):this._selectionRenderer.setData(null);else{const e=new Se.CompositeRenderer;this._shapesRenderer=super._createRenderer(_.paneRendererClass,r),e.append(this._shapesRenderer),this._selectionRenderer=new xe.SelectionRenderer(this._selectionData??void 0),this._model.selection().isSelected(this._study)&&this._isMarkersEnabled&&null!==this._selectionData?this._selectionData.vertOffset=d:this._selectionRenderer.setData(null),e.append(this._selectionRenderer),this._renderer=e}}}var je=i(687795),$e=i.n(je),Ke=i(86441),qe=i(694852),Ye=i(916403),Je=i(509078),Xe=i(286436),Ze=i(5486),Qe=i(511275),et=i(631088);class tt extends Ye.PaneRendererAbstractShape{constructor(e,t){super(null,t),this._textWidthCache=new Ze.TextWidthCache,this._fontSizeEnsured=0,this._font="",this._ch="",null!==e&&this.setData(e)}setData(e){super.setData(e),this._fontSizeEnsured=(0,o.ensureDefined)(this._height),this._font=(0,qe.makeFont)(this._fontSizeEnsured,e.fontFamily||Qe.CHART_FONT_FAMILY);const t=e.char.slice(0,40);this._ch=$e()(t)[0]||" "}hitTest(e){const t=(0,Xe.interactionTolerance)().series+this._fontSizeEnsured/2;for(const i of this._items){if(new Ke.Point(i.center,i.y+i.vertOffset).subtract(e).length()<=t)return new Je.HitTestResult(Je.HitTarget.Regular)}return null}_drawItemShape(e,t){
const i=t.center,s=t.vertOffset>0?1:-1,r=Math.trunc(this._fontSizeEnsured/6),n=t.y+t.vertOffset-s*Math.round(this._fontSizeEnsured/2)+(s>0?r:-this._fontSizeEnsured);let o;o=t.style&&void 0!==t.style.color?t.style.color:this._color;const{context:a,horizontalPixelRatio:l,verticalPixelRatio:h}=e;a.font!==this._font&&(a.font=this._font);const u=this._textWidthCache.measureText(a,this._ch);if(this._fontSizeEnsured<=4/l){a.save();const e=Math.max(1,Math.floor(l));let s=Math.max(1,Math.floor(u*l));s%2!=e%2&&(s+=s>1?-1:1);const r=Math.round(n*h)+(t.vertOffset>=0?0:-s);return a.fillStyle=o,a.fillRect(Math.round(i*l)+(l%2?.5:0)-s/2,r,s,s),void a.restore()}(0,et.drawScaled)(a,l,h,(()=>{a.fillStyle=o,a.textAlign="center",a.textBaseline="top",a.fillText(this._ch,i,n)}))}_startPath(e,t,i){}_endPath(e){}}class it extends ze{constructor(){super(...arguments),this._charRenderer=new tt(null)}_updateRenderer(e,t){const i=this._getTranspValue(),s=this._model.timeScale().barSpacing();let r;const n=this._study.properties().childs().styles.childs()[this._plotName].childs();r=this._plotStyleInfo.size?this._calculateShapeHeight(50,this._plotStyleInfo.size):Math.round(s);const a=n.location.value(),l=(0,V.generateColor)(n.color.value(),i),h=this._calculateVerticalOffset(a,r),c={items:this.items(),barSpacing:s,char:(0,o.ensureDefined)(n.char?.value()??this._plotStyleInfo.char),height:r,vertOffset:h,color:l,visibleItemsRange:{startItemIndex:e,endItemIndex:t}},d=this._plotStyleInfo.text;if(void 0!==d&&""!==d.trim()){let e=d.replace(/\\n/gm,"\n");e=(0,u.cleanButAmpersand)(e,!0),c.text=e,c.fontSize=12;const t=n.textColor?n.textColor.value():void 0;c.textColor=t?(0,V.generateColor)(t,i):l}this._charRenderer.setData(c);const p=new Se.CompositeRenderer;p.append(this._charRenderer),this._model.selection().isSelected(this._study)&&this._isMarkersEnabled&&null!==this._selectionData&&(this._selectionData.vertOffset=h,p.append(new xe.SelectionRenderer(this._selectionData))),this._renderer=p}}var st=i(724377);class rt{constructor(e,t,i,s,r){this.left=NaN,this.right=NaN,this.height=NaN,this.center=e,this.y=t,this.origHeight=i,this.isUp=s,this.origPrices=r,this.timePointIndex=e,this.style={}}}function nt(e){return Math.round(e/4)}function ot(e){return Math.round(e/2)}class at extends be.BitmapCoordinatesPaneRenderer{constructor(e){super(),this._data=e}hitTest(e){const t=this._data,i=ot(t.barSpacing),s=Math.round(i/2),r=Math.round(i),n=nt(t.barSpacing),o=t.visibleItemsRange?.startItemIndex??0,a=t.visibleItemsRange?.endItemIndex??t.items.length;if(o>=a)return null;for(const i of t.items.slice(o,a)){if(!i)continue;if(!Number.isFinite(i.center)||!Number.isFinite(i.y))continue;const t=Math.abs(i.height),o=i.isUp?-1:1,a=t+r,l=i.y-o*n,h=l-o*a,u=i.center-s,c=i.center+s;if(u<e.x&&e.x<c&&(i.isUp?l<e.y&&e.y<h:h<e.y&&e.y<l))return new Je.HitTestResult(Je.HitTarget.Regular)}return null}_drawImpl(e){const{horizontalPixelRatio:t,verticalPixelRatio:i,context:s}=e,r=this._data,n=ot(r.barSpacing),o=nt(r.barSpacing),a=n<4,l=Math.max(n/2,1),h=(0,
Ae.ceiledEven)(n*t),u=h/2,c=Math.round(n*i);s.lineCap="butt",s.lineWidth=Math.max(1,Math.floor(t));const d=s.lineWidth%2?.5:0,p=r.visibleItemsRange?.startItemIndex??0,_=r.visibleItemsRange?.endItemIndex??r.items.length;if(!(p>=_))for(const e of r.items.slice(p,_)){if(!Number.isFinite(e.center)||!Number.isFinite(e.y))continue;const n=e.isUp?-1:1,p=Math.round(Math.abs(e.height)*i),_=Math.round(e.center*t)+d,f=Math.round((e.y-n*o)*i)+d;s.beginPath(),s.translate(_,f);const m=(e.style&&e.style.color)??(e.isUp?r.colorup:r.colordown);a?(s.moveTo(0,0),s.lineTo(-u,-u*n),s.moveTo(0,0),s.lineTo(u,-u*n),s.moveTo(0,0),s.lineTo(0,-p*n),s.moveTo(-u,-p*n),s.lineTo(u,-p*n),s.lineWidth=l,s.strokeStyle=m,s.stroke()):(s.moveTo(0,0),p<c?(s.lineTo(h,-p*n),s.lineTo(-h,-p*n)):(s.lineTo(h,-c*n),s.lineTo(u,-c*n),s.lineTo(u,-p*n),s.lineTo(-u,-p*n),s.lineTo(-u,-c*n),s.lineTo(-h,-c*n)),s.lineTo(0,0),s.strokeStyle=e.isUp?r.colorBorderUp:r.colorBorderDown,s.stroke(),s.fillStyle=m,s.fill()),s.translate(-_,-f)}}}class lt extends xe.SelectionRenderer{_drawMarker(e,t,i,s){const{context:r,horizontalPixelRatio:n,verticalPixelRatio:a}=e,l=(0,o.ensureNotNull)(this._data),h=t.isUp?1:-1;const u=i+h*nt(l.barSpacing)+h*ot(l.barSpacing);let c=Math.round(3.5*n*2);c%2!=s%2&&(c+=1);const d=s%2/2,p=Math.round(t.center*n)+d,_=Math.round((t.y+u)*a)+d;r.beginPath(),r.arc(p,_,c/2,0,2*Math.PI,!0),r.closePath(),r.fill(),r.stroke()}}class ht extends ze{_updateRenderer(e,t){const i=this._study.properties().childs().styles.childs()[this._plotName].childs(),s=(0,Ae.clamp)(this._getTranspValue(),0,100),r=this._model.timeScale().barSpacing(),n=(0,V.generateColor)(i.colorup.value(),s),o=(0,V.generateColor)(i.colordown.value(),s),a=(0,st.parseRgba)(n),l=a?100*(1-a[3]):0,h=(0,st.parseRgba)(o),u=h?100*(1-h[3]):0,c={items:this._items,barSpacing:r,colorup:n,colordown:o,colorBorderUp:(0,V.generateColor)("#000000",l),colorBorderDown:(0,V.generateColor)("#000000",u),minHeight:this._plotStyleInfo.minHeight,visibleItemsRange:{startItemIndex:e,endItemIndex:t}};this._updateItemsHeights(c);const d=new Se.CompositeRenderer;if(d.append(new at(c)),this._model.selection().isSelected(this._study)&&null!==this._selectionData){const e=this._selectionData;e.barSpacing=r,d.append(new lt(e))}this._renderer=d}_fillItemWithPointStyle(e,t,i){const s=(0,o.ensureDefined)(e.style);e.isUp?void 0!==t.colors[5]?s.color=(0,V.generateColor)((0,o.ensureDefined)(t.colors[5]),i):s.color=(0,V.generateColor)(this._study.properties().childs().styles.childs()[this._plotName].childs().colorup.value(),i):void 0!==t.colors[6]?s.color=(0,V.generateColor)((0,o.ensureDefined)(t.colors[6]),i):s.color=(0,V.generateColor)(this._study.properties().childs().styles.childs()[this._plotName].childs().colordown.value(),i)}_getValueForUpdating(e){const t=e.value[this._plotIndex+1];if(!t)return null;const i=e.index,s=t>0,{hiPlot:r,loPlot:n}=this._hiLoPlots(),a=this._study.offset(this._plotName),l=Math.min(i+a,(0,o.ensureNotNull)(this._series.data().last()).index);if(s){const e=this._getSeriesVal(n,l);if(null!==e)return e}else{
const e=this._getSeriesVal(r,l);if(null!==e)return e}return null}_updateItem(e,t){const i=this._getValueForUpdating(e),s=e.value[this._plotIndex+1]>0;return this._items[t].origPrices.price=i??NaN,this._items[t].isUp=s,t+1}_createItem(e,t,i,s,r){const n={center:NaN,y:NaN,origPrices:{price:NaN,timePointIndex:NaN},origHeight:NaN};if(n.timePointIndex=e+r,!t)return n;const a=Math.min(e+r,(0,o.ensureNotNull)(this._series.data().last()).index),l=t>0;let h;if(l){const e=this._getSeriesVal(s,a);if(null===e)return n;h=e}else{const e=this._getSeriesVal(i,a);if(null===e)return n;h=e}return new rt(e+r,h,t,l,{price:h,timePointIndex:e+r})}_dependsOnSeriesData(){return!0}_convertItemsToCoordinates(e,t,i,s){this._convertItemsToCoordinatesImpl(e,t,i,s)}_updateItemsHeights(e){const t=this._study.properties().childs().styles.childs();let i=Math.abs((0,o.ensureDefined)(t[this._plotName].childs().minHeight?.value()??this._plotStyleInfo.minHeight)),s=Math.abs((0,o.ensureDefined)(t[this._plotName].childs().maxHeight?.value()??this._plotStyleInfo.maxHeight));if(i>s){const e=i;i=s,s=e}const r=this._items,n=e.visibleItemsRange?.startItemIndex??0,a=(e.visibleItemsRange?.endItemIndex??r.length)-1;let l=0;for(let e=n;e<=a;e++){const t=r[e],i=Math.abs(t.origHeight);i>l&&(l=i)}const h=(s-i)/l;for(let e=n;e<=a;e++){const t=r[e],s=Math.abs(t.origHeight);t.height=s*h+i}}}var ut=i(449524);class ct extends we.StudyForceOverlayPlotView{constructor(e,t,i,s){super(t,i,s),this._bars=[],this._invalidated=!1,this._isMarkersEnabled=ve.enabled("source_selection_markers"),this._selectionData=null,this._ohlcPlotIndexes=new Map,this._study=e,this._isMarkersEnabled=ve.enabled("source_selection_markers"),this._colorProvider=(0,Pe.createStudyPlotColorProvider)(e.metaInfo(),e.properties(),s),this._selectionIndexer=new Me.SelectionIndexes(i.timeScale());const r=this._study.metaInfo().plots;for(let e=0;e<r.length;e++){const t=r[e];"target"in t&&(t.target===this._plotName&&((0,L.isOhlcOpenPlot)(t)&&this._ohlcPlotIndexes.set(1,e),(0,L.isOhlcHighPlot)(t)&&this._ohlcPlotIndexes.set(2,e),(0,L.isOhlcLowPlot)(t)&&this._ohlcPlotIndexes.set(3,e),(0,L.isOhlcClosePlot)(t)&&this._ohlcPlotIndexes.set(4,e)))}}update(){this._invalidated=!0}items(){return this._bars}_updateImpl(){this._bars.length=0;const e=this._priceScale();if(this._model.timeScale().isEmpty()||null===e||e.isEmpty())return;const t=this._model.timeScale().visibleBarsStrictRange();if(null===t)return;let i=this._series.nearestIndex(t.firstBar(),B.PlotRowSearchMode.NearestRight);const s=this._series.nearestIndex(t.lastBar(),B.PlotRowSearchMode.NearestLeft);if(void 0===i||void 0===s)return;const r=this._study.getMinFirstBarIndexForPlot(this._plotName);if(r>s)return;i=Math.max(r,i);const n=this._study.data(),a=this._study.firstValue(void 0,this.isForceOverlay());if(null===a)return;const l=n.rangeIterator(i,s),h=(0,o.ensureDefined)(this._study.properties().childs().ohlcPlots).childs()[this._plotName].childs(),u=new Map,c=(e,t)=>{const i=e+"@"+t;if(!u.has(i)){const s=(0,V.generateColor)(e,t);return u.set(i,s),s}
return u.get(i)},d=(0,De.createEmptyStyle)();for(const e of l){let t=e.index;const i=e.value;t=Math.floor(t);let s=!0;const r=new Map;for(let e=1;e<=4;++e){const t=this._ohlcPlotIndexes.get(e);if(void 0===t){s=!1;break}const n=i[t+1];if(null==n){s=!1;break}r.set(e,n)}if(!s)continue;const n=(0,o.ensureDefined)(r.get(1)),a=(0,o.ensureDefined)(r.get(4)),l=(0,o.ensureDefined)(r.get(2)),u=(0,o.ensureDefined)(r.get(3)),p=Math.max(n,l,u,a),_=Math.min(n,l,u,a);let f=(0,o.ensureDefined)(c(h.color.value(),0));const m=this._colorProvider.getPlotPointStyle(i,d);void 0!==m.colors[0]&&(f=(0,o.ensureDefined)(m.colors[0]));const y={open:n,high:p,low:_,close:a,color:f,wickColor:m.colors[4],borderColor:m.colors[3],hollow:null,center:NaN,left:NaN,right:NaN,timePointIndex:Math.round(t)};this._bars.push(y)}if(e.barPricesToCoordinates(this._bars,a),this._model.timeScale().fillBarBorders(this._bars),this._model.selection().isSelected(this._study)){const t=this._selectionIndexer.indexes();this._selectionData={points:[],hittestResult:Je.HitTarget.Regular,bgColors:[],visible:!0,barSpacing:this._model.timeScale().barSpacing()};const i=(0,o.ensureNotNull)(this._model.paneForSource(this._study)).height(),s=(0,o.ensureDefined)(this._ohlcPlotIndexes.get(4));for(let r=0;r<t.length;r++){const n=t[r],o=this._study.data().valueAt(n);if(null===o)continue;const l=o[s+1];if(null==l)continue;const h=this._model.timeScale().indexToCoordinate(Math.floor(n)),u=e.priceToCoordinate(l,a);this._selectionData.points.push({point:new Ke.Point(h,u)}),this._selectionData.bgColors.push(this._model.backgroundColorAtYPercentFromTop(u/i))}}else this._selectionIndexer.clear()}_isOHLCPlotVisible(){return this._study.isPlotVisibleAt(this._plotName,1)}}class dt extends ct{renderer(){if(!this._isOHLCPlotVisible())return null;this._invalidated&&(this._updateImpl(),this._invalidated=!1);const e={bars:this._bars,dontDrawOpen:this._series.properties().childs().barStyle.childs().dontDrawOpen.value(),thinBars:this._series.properties().childs().barStyle.childs().thinBars.value()},t=new Se.CompositeRenderer;return t.append(new ut.PaneRendererBars(e)),this._model.selection().isSelected(this._study)&&this._isMarkersEnabled&&this._selectionData&&t.append(new xe.SelectionRenderer(this._selectionData)),t}}var pt=i(559327);class _t extends ct{renderer(){if(!this._isOHLCPlotVisible())return null;const e=this._priceScale();if(!e||e.isEmpty())return null;this._invalidated&&(this._updateImpl(),this._invalidated=!1);const t=(0,o.ensureDefined)(this._study.properties().childs().ohlcPlots).childs()[this._plotName].childs(),i=this._model.timeScale().barSpacing(),s={bars:this._bars,barSpacing:i,wickVisible:t.drawWick.value(),bodyVisible:!0,borderVisible:t.drawBorder.value(),barWidth:(0,Xe.optimalBarWidth)(i),borderColor:t.borderColor.value(),wickColor:t.wickColor.value(),isPriceScaleInverted:e.isInverted()},r=new Se.CompositeRenderer;return r.append(new pt.PaneRendererCandles(s)),
this._model.selection().isSelected(this._study)&&this._isMarkersEnabled&&this._selectionData&&r.append(new xe.SelectionRenderer(this._selectionData)),r}}var ft=i(95370),mt=i(703614),yt=i(345159),gt=i(666574);class vt extends yt.HorizontalLinePaneView{constructor(e,t){super(),this._lineRendererData.linestyle=gt.LINESTYLE_DOTTED,this._study=e,this._plotName=t}_updateImpl(){this._lineRendererData.visible=!1;const e=this._study.properties().childs().styles.childs()[this._plotName].childs();if(!e.trackPrice.value()||!this._study.isPlotVisibleAt(this._plotName,1))return;const t=this._study.lastValueData(this._plotName,!0);t.noData||(this._lineRendererData.visible=!0,this._lineRendererData.y=t.coordinate,this._lineRendererData.color=t.color,this._lineRendererData.linewidth=e.linewidth.value())}}var St=i(512230),bt=i(19932),It=i(781298);const Pt={type:0,color:"transparent"};class wt extends It.AbstractFilledAreaPaneView{constructor(e,t,i,s){super(e,t,i),this._palettesInfo={},this._gradientPropsStateCache=null,this._rgbaFromInteger=(0,bt.rgbaFromIntegerCached)();const r=this._source.metaInfo();this._isRGB=Boolean(r.isRGB),this._isHlineFill="hline_hline"===i.type,(0,o.assert)(this._isHlineFill||"plot_plot"===i.type,"Wrong filledArea type: "+i.type),this._isHlineFill&&this._initBandIndexes(i.objAId,i.objBId),this._fillMetaInfo=i,this._fillStyleProps=s,this._gradientFillType=s.hasChild("fillType")&&"gradient"===s.childs().fillType?.value(),this._gradientStaticState={color1:i.topColor,color2:i.bottomColor,value1:i.topValue,value2:i.bottomValue},this._hasAllGradientRequiredProps=this._gradientFillType&&(void 0!==this._gradientStaticState.color1||s.hasChild("topColor")||void 0!==this._gradientStaticState.color2||s.hasChild("bottomColor"))&&(void 0!==this._gradientStaticState.value1||s.hasChild("topValue"))&&(void 0!==this._gradientStaticState.value2||s.hasChild("bottomValue"));const n=()=>this._colorPlotIndex=this._colorPlotIndex??{type:1};for(let t=0;t<r.plots.length;++t){const s=r.plots[t];if(((0,L.isColorerPlot)(s)||(0,L.isDataPlot)(s))&&s.target===i.id){if((0,L.isColorerPlot)(s)){let i;void 0!==s.targetField?"topColor"===s.targetField?(n().colorIndexOrRgba1=t,i="color1"):"bottomColor"===s.targetField&&(n().colorIndexOrRgba2=t,i="color2"):this._colorPlotIndex={type:0,colorIndexOrRgba:t},(0,L.isPaletteColorerPlot)(s)&&(this._palettesInfo[i??"color"]={map:(0,o.ensureDefined)((0,o.ensureDefined)(r.palettes)[s.palette]?.valToIndex),values:e.properties().palettes[s.palette].colors})}else(0,L.isDataPlot)(s)&&("topValue"===s.targetField?n().valueIndex1=t:"bottomValue"===s.targetField&&(n().valueIndex2=t));if(0===this._colorPlotIndex?.type)break}}}update(e){super.update(e),this._gradientPropsStateCache=null}isForceOverlay(){return!!this._source.metaInfo().isPlotForceOverlay(this._plotAId())}_firstValue(){const e=this.isForceOverlay();return this._source.firstValue(void 0,e)}_minFirstBarIndex(){return this._source.getMinFirstBarIndexForPlot(this._fillMetaInfo.id)}_getColorByPlotValue(e){if(0===e.type){let t
;if(null==e.colorIndexOrRgba)return null;if(this._isRGB)t=this._rgbaFromInteger(e.colorIndexOrRgba);else{const i=(0,o.ensureDefined)(this._palettesInfo.color),s=(0,o.ensureDefined)(i.map[e.colorIndexOrRgba]);t=i.values[s]?.childs().color.value()}return{type:0,color:t}}const t=this._gradientColorPropsState();let i,s;if(this._isRGB)null!=e.colorIndexOrRgba1&&(i=this._rgbaFromInteger(e.colorIndexOrRgba1)),null!=e.colorIndexOrRgba2&&(s=this._rgbaFromInteger(e.colorIndexOrRgba2));else{if(null!=e.colorIndexOrRgba1){const t=(0,o.ensureDefined)(this._palettesInfo.color1);i=t.values[(0,o.ensureDefined)(t.map[e.colorIndexOrRgba1])].childs().color.value()}if(null!=e.colorIndexOrRgba2){const t=(0,o.ensureDefined)(this._palettesInfo.color2);s=t.values[(0,o.ensureDefined)(t.map[e.colorIndexOrRgba2])].childs().color.value()}}const r=e.value1??t.value1,n=e.value2??t.value2;return i=i??t.color1,s=s??t.color2,void 0===r||void 0===n||void 0===i&&void 0===s?null:{type:1,color1:i,color2:s,value1:r,value2:n,coordinate1:NaN,coordinate2:NaN}}_plotAId(){return this._fillMetaInfo.objAId}_plotBId(){return this._fillMetaInfo.objBId}_commonColor(){const e=this._fillStyleProps.childs();if(this._gradientFillType){if(!this._hasAllGradientRequiredProps)return Pt;const e=this._gradientColorPropsState();return{type:1,color1:e.color1,color2:e.color2,value1:e.value1,value2:e.value2,coordinate1:NaN,coordinate2:NaN}}return{type:0,color:e.color.value()}}_transparency(){return this._fillStyleProps.childs().transparency?.value()??0}_visible(){return this._fillStyleProps.childs().visible.value()}_priceScale(){return this.isForceOverlay()?this._model.mainSeries().priceScale():this._source.priceScale()}_initBandIndexes(e,t){this._bandAKey=null,this._bandBKey=null;const i=this._source.metaInfo().bands;if(void 0!==i)for(let s=0;s<i.length;++s){const r=i[s];null!==this._bandAKey||r.id!==e?null===this._bandBKey&&r.id===t&&(this._bandBKey=s):this._bandAKey=s}}_gradientColorPropsState(){if(null===this._gradientPropsStateCache){const e=this._fillStyleProps.state();this._gradientPropsStateCache={color1:this._gradientStaticState.color1??e.topColor,color2:this._gradientStaticState.color2??e.bottomColor,value1:this._gradientStaticState.value1??e.topValue,value2:this._gradientStaticState.value2??e.bottomValue}}return this._gradientPropsStateCache}}var Ct=i(193938),xt=i(467841);class Vt{constructor(e,t){this._invalidated=!0,this._lineRenderer=new xt.HorizontalLineRenderer,this._source=t,this._points=[new Ke.Point(-1,-1)],this._invalidated=!0,this._properties=e}update(){this._invalidated=!0}renderer(){this._invalidated&&(this._updateImpl(),this._invalidated=!1);const e={y:this._points[0].y,color:this._properties.childs().color.value(),linewidth:this._properties.childs().linewidth.value(),linestyle:this._properties.childs().linestyle.value()};return this._lineRenderer.setData(e),this._lineRenderer}_updateImpl(){const e=this._source.priceScale();if(!e||e.isEmpty())return void(this._points[0]=new Ke.Point(-1,-1))
;const t=this._properties.childs().value.value(),i=this._source.firstValue(),s=(0,K.isNumber)(t)&&null!==i?e.priceToCoordinate(t,i):NaN;this._points[0]=new Ke.Point(-1,s)}}var At=i(367637);class Mt extends At.MediaCoordinatesPaneRenderer{constructor(){super(),this._data=null,this._data=null}setData(e=null){this._data=e}hitTest(){return null}_drawImpl(e){if(null===this._data||0===this._data.points.length)return;const t=e.context,i=e.mediaSize.width;if(this._data.gradient){const e=t.createLinearGradient(0,this._data.coordinate1,0,this._data.coordinate2);e.addColorStop(0,this._data.backColor1??"transparent"),e.addColorStop(1,this._data.backColor2??"transparent"),t.fillStyle=e}else t.fillStyle=this._data.backcolor;const s=Math.min(this._data.points[0],this._data.points[1]),r=Math.max(this._data.points[0],this._data.points[1]);t.fillRect(0,s,i,r-s)}}class Rt{constructor(e){this._bandBgRenderer=new Mt,this._invalidated=!0,this._source=e}update(){this._invalidated=!0}renderer(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._bandBgRenderer}_updateImpl(){this._bandBgRenderer.setData(null);const e=this._source.properties().childs(),t=e.bands;if(t.childCount()<2)return;const i=e.bandsBackground;if(!i?.childs().fillBackground.value())return;const s=t[0].childs(),r=t[1].childs(),n=this._source.priceScale(),a=this._source.firstValue();if(!n||n.isEmpty()||null===a)return;const l=[n.priceToCoordinate(s.value.value(),a),n.priceToCoordinate(r.value.value(),a)],h=(0,o.ensureDefined)(e.bandsBackground).childs(),u=(0,Ae.clamp)(h.transparency?.value()??0,0,100);this._bandBgRenderer.setData({gradient:!1,points:l,backcolor:(0,V.generateColor)(h.backgroundColor.value(),u)})}}class Dt{constructor(e,t,i){this._bandBgRenderer=new Mt,this._bandAKey=null,this._bandBKey=null,this._invalidated=!0,this._source=e,(0,o.assert)("hline_hline"===t.type,"Wrong filledArea type: "+t.type),this._initBandIndexes(t.objAId,t.objBId),this._fillStyleProps=i,this._bandBgRenderer=new Mt,this._gradientFillType=i.hasChild("fillType")&&"gradient"===i.childs().fillType?.value(),this._gradientStaticState={color1:t.topColor,color2:t.bottomColor,value1:t.topValue,value2:t.bottomValue}}update(){this._invalidated=!0}renderer(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._bandBgRenderer}_updateImpl(){if(this._bandBgRenderer.setData(null),!this._fillStyleProps.childs().visible.value())return;if(null===this._bandAKey||null===this._bandBKey)return;const e=(0,o.ensureDefined)(this._source.properties().childs().bands),t=e.childs()[this._bandAKey].childs(),i=e.childs()[this._bandBKey].childs(),s=this._source.priceScale(),r=this._source.firstValue();if(!s||s.isEmpty()||null===r)return;const n=[s.priceToCoordinate(t.value.value(),r),s.priceToCoordinate(i.value.value(),r)],a=(0,Ae.clamp)(this._fillStyleProps.childs().transparency?.value()??0,0,100);let l;const h=this._fillStyleProps.childs();if(this._gradientFillType){const e=this._gradientStaticState,t=h,i=e.value1??t.topValue?.value(),o=e.value2??t.bottomValue?.value()
;if(void 0===i||void 0===o)return;const u=e.color1??t.topColor?.value(),c=e.color2??t.bottomColor?.value();if(void 0===u&&void 0===c)return;l={gradient:!0,points:n,backColor1:u&&(0,V.generateColor)(u,a),backColor2:c&&(0,V.generateColor)(c,a),coordinate1:s.priceToCoordinate(i,r),coordinate2:s.priceToCoordinate(o,r)}}else l={gradient:!1,points:n,backcolor:(0,V.generateColor)(h.color.value(),a)};this._bandBgRenderer.setData(l)}_initBandIndexes(e,t){this._bandAKey=null,this._bandBKey=null;(0,o.ensureDefined)(this._source.metaInfo().bands).forEach(((i,s)=>{null===this._bandAKey&&i.id===e&&(this._bandAKey=s),null===this._bandBKey&&i.id===t&&(this._bandBKey=s)}))}}var Tt=i(757402),Ot=i(412788),Ft=i(219849),Bt=i(169532),Nt=i(375397),kt=i(643322),Et=i(975179),Lt=i(546821),Ht=i(125624),Wt=i(336928),Ut=i(200441);class zt extends Ut.AbstractBarColorer{constructor(e,t){super(),this._rgbaFromInteger=(0,bt.rgbaFromIntegerCached)(),this._study=e,this._plotIndex=t}applyBarStyle(e,t,i,s){if(t)return i;const r=this._study.properties().childs();if(!r.visible.value())return i;const n=this._study.metaInfo(),a=this._study.data();if(!a||0===a.size())return i;const l=n.plots[this._plotIndex],h=this._getOffset();if(this._study.getMinFirstBarIndexForPlot(l.id)>e+h)return i;if(0===r.styles.childs()[l.id].childs().display.value())return i;const u=a.valueAt(e-h);if(null===u)return i;let c=u[this._plotIndex+1];if(null==c)return i;if(c=Math.round(c),n.isRGB)i.barColor=this._rgbaFromInteger(c),i.upColor=i.barColor,i.downColor=i.barColor;else{const e=n.plots[this._plotIndex];if("palette"in e){const t=e.palette,s=r.palettes.childs()[t],a=(0,o.ensureDefined)(n.palettes?.[t]),l=a.valToIndex?(0,o.ensureDefined)(a.valToIndex[c]):c,h=s.childs().colors.childs()[l].childs().color.value();i.barColor=h,i.upColor=h,i.downColor=h}}return i}firstColoredBar(e){let t=e;for(const i of this._backColorers)t=Math.min(t,i.firstColoredBar(e)??1/0);const i=this._getOffset();t=Math.min(t,e+i);const s=this._getBars().firstIndex(),r=Math.max(t,s??-1/0),n=this._study.metaInfo().plots[this._plotIndex];return Math.max(this._study.getMinFirstBarIndexForPlot(n.id),r)}_getBars(){return this._study.series().bars()}_getOffset(){const e=this._study.metaInfo().plots[this._plotIndex];return this._study.offset(e.id)}}var Gt=i(251954),jt=i(911144),$t=i(735211),Kt=i(984217);class qt extends ft.PanePriceAxisView{constructor(e,t,i,s){super(e,t,i),this._dataSource=t,this._isForceOverlay=t.metaInfo().isPlotForceOverlay(s)}_position(){const e=this._isForceOverlay?this._chartModel.mainPane():this._chartModel.paneForSource(this._dataSource);if(null===e)return null;const t=this._isForceOverlay?this._chartModel.mainSeries().priceScale():this._dataSource.priceScale();if(null===t)return null;let i=e.priceScalePosition(t);return"overlay"===i&&(i=e.priceScalePosition(e.defaultPriceScale())),"overlay"===i?null:i}}var Yt=i(627183),Jt=i(941654),Xt=i(903424);const Zt=(0,l.getLogger)("Chart.Study"),Qt=a.t(null,void 0,i(314285));const ei={symbolsForDisplay:!1,symbolsForChartApi:!0,skipHiddenInputs:!1,
skipFakeInputs:!1,skipBooleanInputs:!1,asObject:!0,skippedGroups:[],skippedInputs:[],noExchanges:!1,noResolution:!1,keepOptionalSymbolsEmpty:!1,skipColorInputs:!1,skipTimeInputs:!1,skipOptionalEmptySymbolInputs:!1,skipTextareaInputs:!1,priceInputsForDisplay:!1},ti={symbolsForDisplay:!1,symbolsForChartApi:!0,skipHiddenInputs:!0,skipFakeInputs:!1,skipBooleanInputs:!1,skippedGroups:[],skippedInputs:[],noExchanges:!1,noResolution:!1,keepOptionalSymbolsEmpty:!1,skipColorInputs:!1,skipTimeInputs:!1,skipOptionalEmptySymbolInputs:!1,skipTextareaInputs:!1,priceInputsForDisplay:!1,fakeInputsForDisplay:!1,doNotSkipHiddenWithMigrate:!1,onlyAtomValues:!0,patchSosInputs:!1},ii=ve.enabled("study_symbol_ticker_description"),si=ve.enabled("hide_main_series_symbol_from_indicator_legend"),ri=ve.enabled("datasource_copypaste"),ni=ve.enabled("hide_unresolved_symbols_in_legend");function oi(e,t){const i=e.plots[t];if(!i||!(0,L.isOhlcPlot)(i))return!1;const s=i.target,r=e.defaults.styles&&e.defaults.styles[s],n=e.defaults.ohlcPlots&&e.defaults.ohlcPlots[s],o=e.ohlcPlots&&e.ohlcPlots[s];return r&&(0,L.isOhlcPlotStyleBars)(r)||n&&(0,L.isOhlcPlotStyleBars)(n)||!!o&&(0,L.isOhlcPlotStyleBars)(o)}function ai(e,t){const i=e.plots[t];if(!i||!(0,L.isOhlcPlot)(i))return!1;const s=i.target,r=e.defaults.styles&&e.defaults.styles[s],n=e.defaults.ohlcPlots&&e.defaults.ohlcPlots[s],o=e.ohlcPlots&&e.ohlcPlots[s];return r&&(0,L.isOhlcPlotStyleCandles)(r)||n&&(0,L.isOhlcPlotStyleCandles)(n)||!!o&&(0,L.isOhlcPlotStyleCandles)(o)}function li(e,t){(0,o.assert)(void 0!==e,"zOrder must be defined"),(0,o.assert)(!t.has(e),"zOrder must be unique")}function hi(e,t){return e.plots.some((e=>((0,L.isColorerPlot)(e)||(0,L.isDataPlot)(e))&&e.target===t))}function ui(e,t,i){let s=0,r=0;return e.inputs.filter((e=>"source"===e.type)).forEach((e=>{(0,_.getInputValue)(i[e.id]).includes("$")&&s++,(0,_.getInputValue)(t[e.id]).includes("$")&&r++})),Math.sign(r)-Math.sign(s)}function ci(e){const t=new Set;for(const i of e.parentSources())for(const e of ci(i))t.add(e);return t.add(e),Array.from(t)}function di(e){return"inherit"===e.type&&(e.type="price"),e}function pi(e,t,i,s){if(null!==t)switch(e.type){case"inherit":case"price":return new $t.PriceFormatter({priceScale:t});case"volume":return(0,Yt.getVolumeFormatter)(Math.log10(t));case"percent":return(0,Yt.getPercentageFormatter)(Math.log10(t))}if("inherit"===e.type)return null;const r=(0,K.isNumber)(e.precision)?Math.pow(10,e.precision):void 0;switch(e.type){case"price":return new $t.PriceFormatter({priceScale:r});case"volume":{let t=e.precision;return void 0===t&&(t=i&&(0,K.isNumber)(i.volume_precision)?i.volume_precision:0),(0,Yt.getVolumeFormatter)(t)}case"percent":return(0,Yt.getPercentageFormatter)(void 0===r?void 0:Math.log10(r));default:return Zt.logWarn(`Unsupported format type: ${e.type}`),null}}const _i=new Set(["first_visible_bar_time","last_visible_bar_time","subscribeRealtime"]);class fi extends R.PriceDataSource{constructor(e,t,i,s,r){super(e),this._onStart=new x.Delegate,this._restarting=!1,this._paneViews=[],
this._forceOverlaysPaneViews=[],this._legendView=null,this._priceAxisViews=[],this._forceOverlayPriceAxisViews=[],this._priceAxisViewsBase=[],this._resolvedSymbols={},this._resolvedSymbolsByInput={},this._priceLinesAxisViews=[],this._labelPaneViews=[],this._forceOverlayLabelPaneViews=[],this._ownFirstValue=null,this._formatter=null,this._defaultFormatter=null,this._dataUpdated=new x.Delegate,this._currencySourceSymbolInputProperty=null,this._onHibernationStateChange=new x.Delegate,this._symbolsResolved=new x.Delegate,this._statusChanged=new x.Delegate,this._inputsAnchorsPaneView=null,this._inputsLinesPaneView=null,this._inputsTimeAxisPaneViews=[],this._inputsPriceAxisPaneViews=[],this._sources=[],this._status={type:Tt.StudyStatusType.Undefined},this._compileActiveStatus=null,this._compileErrorStatus=null,this._wasCompletedBefore=!1,this._studyId=null,this._isSubscribedToSessionId=!1,this._titleStrCache={},this._titleInPartsCache={},this._children=[],this._graphicsPriceAxisViews=[],this._plotOffsets={},this._ongoingDataUpdate=Promise.resolve(),this._studyModified=!1,this._tagsChanged=new x.Delegate,this._studyName="",this._turnaround="st0",this._pendingResolveSymbols=new Map,this._onIsActualIntervalChange=new x.Delegate,this._childStudyByRebind=new x.Delegate,this._lastNonEmptyPlotRowCache={},this._startMovingPoint=null,this._processHibernateBound=this.processHibernate.bind(this,1),this._maxOffset=new Nt.WatchedValue(0),this._currencySourceSymbolInfo=null,this._graphicsPriceRangeGroups=null,this._graphicsViewsReady=!1,this._visibleTimeRangeInputs=null,this._turnaroundCounter=0,this._deferredPinePatchProps=!1,this._propertiesPatched=Promise.resolve(),this._aboutToBeDestroyed=new x.Delegate,this._definitionsViewModel=null,this._plotFormatters=new Map,this._showPineVersionInStatusLine=new Nt.WatchedValue(!1).spawn(),this._pineSourceCodeModel=null,this._onParentSourcesChanges=new x.Delegate,this._statusChangesSubscriber={},this._calculationTime=new Nt.WatchedValue(0),this._chartApi=e.chartApi(),this._properties=t,this._metaInfo=s,this._hideMatches=s.inputs.filter((e=>e.hideWhenPlotsHidden)).map((e=>({id:e.id,plotIds:e.hideWhenPlotsHidden||[]}))),this._series=this._model.mainSeries(),this._series.onIntervalChanged().subscribe(this,this._calcIsActualInterval),this._series.alertCreationAvailable().subscribe(this._updateAlertCreationAvailable.bind(this)),this._showStudyArgumentsProperty=e.properties().childs().paneProperties.childs().legendProperties.childs().showStudyArguments,e.collapsed().subscribe(this._processHibernateBound),this._sources=i,O.StudyMetaInfo.setChildStudyMetaInfoPropertiesSourceId(s,this._sources[0]?.id(),t),i.forEach((e=>{e.setChild(this)})),[this._series,...i].forEach((e=>{e.currencyChanged().subscribe(this,this._onSourceCurrencyChanged),e.unitChanged().subscribe(this,this._onSourceUnitChanged),e.priceRangeReadyChanged().subscribe(this,this._onSourcePriceRangeReadyChanged),e.formatterChanged().subscribe(this,this._onSourceFormatterChanged),
e.priceStepChanged().subscribe(this,this._onSourcePriceStepChanged)})),ii&&this._model.mainSeries().properties().childs().statusViewStyle.childs().symbolTextSource.subscribe(this,(()=>{this.invalidateTitleCache(!0)}));const n=this._properties.childs();for(const e of O.StudyMetaInfo.getSourceInputIds(s))n.inputs.childs()[e]?.subscribe(this,this._onSourceInputChanged);this._properties.subscribe(this,this._onPropertiesChanged),n.visible.subscribe(this,this._visibleChanged),n.visible.subscribe(this,(()=>this.processHibernate())),n.intervalsVisibilities.subscribe(this,this._calcIsActualInterval),n.inputs.subscribe(this,this._updateMaxOffsetValue),void 0!==n.offsets&&n.offsets.subscribe(this,this._updateMaxOffsetValue),void 0!==n.offset&&n.offset.subscribe(this,this._updateMaxOffsetValue),W.hideAllIndicators().subscribe(this,this._visibleChanged);for(let e=0;e<this._metaInfo.plots.length;e++){const t=this._metaInfo.plots[e].id,i=n.styles.childs()[t];i?.childs().display.subscribe(this,(()=>{this.processHibernate(),this.invalidateTitleCache()}))}for(const e of Object.keys(this._metaInfo.graphics))for(const t of Object.keys(this._metaInfo.graphics[e])){const i=n.graphics.childs()[e]?.childs()[t];i&&i.childs().visible&&(0,o.ensureDefined)(i.childs().visible).subscribe(this,(()=>this.processHibernate()))}this._isActualInterval=(0,Ot.isActualInterval)(this._series.intervalObj(),n.intervalsVisibilities),this._initializeStudyInputsPaneViews(),this._handler=e=>this._onData(e),this._valuesProvider=new jt.StudyValuesProvider(this,e),this._graphicsPriceRangeGroups=ae(this),this._graphics=new F.LiveStudyGraphics(s.graphics),this._signlePerformanceValue=(0,fe.createWVFromGetterAndSubscriptions)((()=>Array.from((0,o.ensureDefined)(this._graphics.performance().get("performance")))[0]??null),[(0,o.ensureDefined)(this._graphics.observablePerformance().get("performance")).changed(),(0,o.ensureDefined)(this._graphics.observablePerformance().get("performance")).cleared()]),this._chartApi=e.chartApi(),this._invalidateLastNonEmptyPlotRowCache(),this._data=new T.PlotList((0,Kt.studyPlotFunctionMap)(this._metaInfo),Kt.studyEmptyPlotValuePredicate),this._createViews(),this._recreatePriceFormattingDependencies(this._series.symbolInfo()),n.precision.subscribe(this,this._onFormatterPropsChanged),this._showStudyArgumentsProperty.subscribe(this,(()=>this.invalidateTitleCache(!0))),n.inputs.subscribe(this,(()=>this.invalidateTitleCache(!0))),ve.enabled("update_study_formatter_on_symbol_resolve")&&e.mainSeries().dataEvents().symbolResolved().subscribe(this,this._recreatePriceFormattingDependencies),e.mainSeries().dataEvents().symbolResolved().subscribe(this,(()=>this.invalidateTitleCache(!0)));const a=new Set;if(this._simplePlotsCount=s.plots.filter(((e,t)=>{if((0,L.isLinePlot)(e))return!0;if((0,L.isOhlcPlot)(e)){const t=e.target;return!a.has(t)&&(a.add(t),!0)}return!1})).length,this.hasBarColorer()&&n.visible.subscribe(this,(()=>e.mainSeries().invalidateBarStylesCache)),this._definitionsViewModel=null,this._updateMaxOffsetValue(),
s.inputs.some((e=>_i.has(e.id)))){this._visibleTimeRangeInputs=e.visibleRangeStudiesInputs().spawn();const t=this._visibleTimeRangeInputs.value();let i=null!==t;this._visibleTimeRangeInputs.subscribe((e=>{const t=()=>{this._onVisibleTimeRangeInputsChanged(e),i!==(null!==e)&&(i=null!==e,!i||this._restarting||this.isStarted()||this.start(!0))};this._statusChanged.unsubscribeAll(this._statusChangesSubscriber),this._status.type===Tt.StudyStatusType.Loading?this._statusChanged.subscribe(this._statusChangesSubscriber,t,!0):t()})),t&&this._updateVisibleTimeRangeInputs(t,!1)}if((0,_e.isCountedUserScript)(s)&&(this._showPineVersionInStatusLine=(0,kt.combine)((()=>(0,_e.userScriptVersionsCount)(s.scriptIdPart)>1),(0,_e.userScriptsOnLayout)().weakReference()),this._showPineVersionInStatusLine.subscribe((()=>{this.invalidateTitleCache(),e.updateSource(this)}))),!r&&s.TVScriptMetaInfoExprs&&s.defaults.inputs){const e=this.inputs();for(const t of s.inputs)if(!t.isHidden&&!(0,_.isStudyInputDependsOnChart)(t)&&s.defaults.inputs[t.id]!==e[t.id]){this._deferredPinePatchProps=!0,this._oldStudyInputs=this._prepareInputs(ti),this._oldStudyInputs[t.id]=s.defaults.inputs[t.id];break}}this._properties.setNameInOwner((0,Jt.propertyPathForSource)(this))}destroy(){this._signlePerformanceValue?.destroy(),this._aboutToBeDestroyed.fire(),null!==this._definitionsViewModel&&(this._definitionsViewModel.destroy(),this._definitionsViewModel=null),this._showStudyArgumentsProperty.unsubscribeAll(this),this._model.mainSeries().dataEvents().symbolResolved().unsubscribeAll(this);this.parentSources().forEach((e=>{e.currencyChanged().unsubscribeAll(this),e.unitChanged().unsubscribeAll(this),e.priceRangeReadyChanged().unsubscribeAll(this),e.formatterChanged().unsubscribeAll(this),e.priceStepChanged().unsubscribeAll(this)})),this._series.properties().childs().statusViewStyle.childs().symbolTextSource.unsubscribeAll(this),this._series.onIntervalChanged().unsubscribeAll(this),this._series.alertCreationAvailable().unsubscribe(this._updateAlertCreationAvailable),this.formatterChanged().unsubscribe(this,this.invalidateTitleCache),W.hideAllIndicators().unsubscribe(this,this._visibleChanged),this._model.collapsed().unsubscribe(this._processHibernateBound),null!==this._currencySourceSymbolInputProperty&&this._currencySourceSymbolInputProperty.unsubscribeAll(this),this._legendView?.destroy(),this._pineSourceCodeModel?.get()?.destroy(),this._pineSourceCodeModel?.destroy(),this._visibleTimeRangeInputs?.destroy(),this._showPineVersionInStatusLine.destroy(),super.destroy()}setId(e){super.setId(e),this._properties.setNameInOwner((0,Jt.propertyPathForSource)(this))}properties(){return this._properties}propertiesPatched(){return this._propertiesPatched}isDraggable(){return!this._metaInfo.linkedToSeries}logs(){return this._metaInfo.graphics.logs&&this._graphics instanceof F.LiveStudyGraphics?(0,o.ensureDefined)(this._graphics.observableLogs().get("logs")):null}logLevelMask(){const e=this._properties.childs().inputs.childs().__log_level.value();if(!(0,
K.isNumber)(e)||e<0||e>7)throw new Error(`Value of log level is unexpected, current value is ${e}, but expected values from 0 to 7`);return{error:Boolean(1&e),warning:Boolean(2&e),info:Boolean(4&e)}}setLogLevelMask(e){const t=(Number(e.error)&&1)|(Number(e.warning)&&2)|(Number(e.info)&&4);this._properties.childs().inputs.childs().__log_level.setValue(t)}performance(){return this._graphics instanceof F.LiveStudyGraphics?this._signlePerformanceValue:new Nt.WatchedValue(null)}profilingEnabled(){return!!this._properties.childs().inputs.childs().__profile?.value()}enableProfiling(e){this._properties.childs().inputs.childs().__profile?.setValue(e)}onAboutToBeDestroyed(){return this._aboutToBeDestroyed}priceScale(e){return e?this._model.mainSeries().priceScale():super.priceScale()}lastValueData(e,t,i){const s={noData:!0},r=this.metaInfo().isPlotForceOverlay(e),n=r?this._model.mainSeries().priceScale():this.priceScale();if(this._model.timeScale().isEmpty()||null===n||n.isEmpty()||this.data().isEmpty())return s;const o=this._model.timeScale().visibleBarsStrictRange(),a=this.firstValue(!0,r);if(null===o||null===a)return s;if(!this._properties.childs().visible.value())return s;const l=this._properties.childs().styles,h=this._properties.childs().ohlcPlots;let u,c;if(l&&l.childs()[e]&&(u=l.childs()[e]),h&&h.childs()[e]&&(u=h.childs()[e]),!u||0===u.childs().display.value())return s;const d=this.metaInfo().plots;for(c=0;c<d.length;c++){const t=d[c];if(t.id===e||(0,L.isOhlcClosePlot)(t)&&t.target===e)break}const p=c+1,_=this.offset(e),f=this.nearestIndex(o.lastBar()-_,B.PlotRowSearchMode.NearestLeft,p);if(void 0===f)return s;const m=this._lastNonEmptyPlotRow(p),y=null!==m&&o.contains(m.index),g=null!==m?m.value:null,v=t||y?g:this.data().valueAt(f);if(!v||!(0,K.isNumber)(v[p]))return s;const S=v[p],b=this._valuesProvider.getPlotColor(c,v),I=n.priceToCoordinate(S,a),P=this.plotFormatter(e).format(S),w={...n.getFormattedValues(S,a,void 0,P),noData:!1,color:b,floatCoordinate:I,coordinate:I};return i&&(w.price=S),w}isFailed(){return this.status().type===Tt.StudyStatusType.Error}isLoading(){return this.status().type===Tt.StudyStatusType.Loading}isCompleted(){return this.status().type===Tt.StudyStatusType.Completed}isSymbolInvalid(){return this._status.type===Tt.StudyStatusType.Error&&this._status.errorDescription.error===Qt}series(){return this._series}model(){return this._model}state(e,t){const i=(0,o.ensureNotNull)((0,h.getStudyClassName)(this.constructor)),s=this.metaInfo(),r={type:i,id:this.id(),state:this.properties().state(),zorder:this.zorder(),ownFirstValue:this.isVisible()?null:this._ownFirstValue,metaInfo:s.state()},n=this._sources.map((e=>e.id()));if(n.length&&(r.parentSources=n),e){let e=this.data();const t=this._model.timeScale(),i=this._seriesDataRangeToSave(e);null!==i&&(e=e.range(i.firstBar(),i.lastBar())),r.data=e.state(),r.data.symbols=this._resolvedSymbols,r.data.graphics=(0,F.saveStudyGraphics)(this.graphics(),t.visibleBarsStrictRange()),r.data.plotOffsets=this._plotOffsets}
this.ownerSource()&&(r.ownerSource=this.ownerSource()?.id());for(let e=0;e<s.inputs.length;e++)if("bar_time"===s.inputs[e].type){const t=s.inputs[e].id,i=r.state.inputs[t];if(i<0){const e=this._rightOffsetToUnixTime(-i);r.state.inputs[t]=e&&e>=0?e:0}}if(r.state?.inputs){const e=r.metaInfo.inputs.find((e=>"ILScript"===e.name));e&&delete r.state.inputs[e.id],delete r.state.inputs.__log_level,delete r.state.inputs.__profile}const a=this.stateCustomFields();var l;return a&&(r.customFields=a),t&&(l=r).metaInfo&&l.metaInfo.scriptIdPart&&l.metaInfo.scriptIdPart.startsWith("USER;")&&(function(e){if(!e.metaInfo)return;const t=e.metaInfo.scriptIdPart;if(!t)return;const i=t.split(";")[0],s=e.metaInfo;s.id=(s.id||"").replace(t,i),s.fullId=(s.fullId||"").replace(t,i),s.name=(s.name||"").replace(t,i),s.shortId=(s.shortId||"").replace(t,i),s.scriptIdPart=(s.scriptIdPart||"").replace(t,i),e.state&&(e.state.id=(e.state.id||"").replace(t,i),e.state.name=(e.state.name||"").replace(t,i),e.state.scriptIdPart=(e.state.scriptIdPart||"").replace(t,i))}(l),function(e){const t=(e.metaInfo&&e.metaInfo.inputs||[]).find((e=>"ILScript"===e.name));t&&(t.defval="",e.state&&e.state.inputs&&(e.state.inputs[t.id]=""),e.metaInfo.defaults.inputs&&(e.metaInfo.defaults.inputs[t.id]=""))}(l)),r}stateCustomFields(){if(this._compileErrorStatus)return{compileErrorDescription:this._compileErrorStatus.errorDescription}}restoreStateCustomFields(e){const t=e.compileErrorDescription;t&&this.setErrorCompilation([(0,o.ensureDefined)(t.editorError)])}restoreData(e){this._invalidateLastNonEmptyPlotRowCache(),this.data().restoreState(e),this._resolvedSymbols=e.symbols??{},this._graphics=e.graphics?(0,F.loadStudyGraphics)(e.graphics):(0,F.emptyStudyGraphics)(),this._postProcessGraphics(),this._plotOffsets=e.plotOffsets??{},this._setStatus({type:Tt.StudyStatusType.Completed},!0)}hasStateForAlert(){return pe.alertsAvailable&&!this.isFailed()&&!this._metaInfo.isTVLibrary&&this._series.alertCreationAvailable().value()&&(this._hasAlertConditions()||this._hasAvailableAlertPlots()||this._hasAlertFunction())}stateForAlert(){const e=(0,o.ensureNotNull)(this._alertMetaInfo()),t=this._plotsForAlert(),i=this._collectDepsForAlert(),s=i.idForAlert,r=i.studyDependencies,n=i.inputsForAlert,a=(this.priceScale()||this.model().mainSeries().priceScale()).formatter(),l=a?d.FormattersSerializer.serialize(a):null,c=S.studyIdsWithNoInputsInTitle.has((0,v.extractStudyId)(e.fullId)),p={id:s,type:(0,o.ensureNotNull)((0,h.getStudyClassName)(this.constructor)),title:(0,u.clean)(this._title(q.TitleDisplayTarget.Alerts,!1,{},c,!1,!0),!0),shortTitle:(0,u.clean)(this._title(q.TitleDisplayTarget.Alerts,!0,{},c,!1,!0),!0),shortDescription:(0,u.clean)(e.shortDescription||"Study",!0),fullId:e.fullId,isTVScript:Boolean(e.isTVScript),hasAlertFunction:Boolean(e.hasAlertFunction),plots:t,inputs:n,alerts:e.alerts,scriptIdPart:e.scriptIdPart,scriptVersion:e.pine?e.pine.version:"-1",studyDependencies:r,formatter:l},_=y(this);_&&(p.dangerReason=_);const f=e.defaultStrategyAlertMessage
;return f&&(p.defaultStrategyAlertMessage=(0,u.clean)(f,!0)),p}idForAlert(){return this._collectDepsForAlert().idForAlert}hasBarColorer(){return(0,o.ensureNotNull)(this._metaInfo).plots.some(L.isBarColorerPlot)}barColorer(){const e=this._metaInfo.plots;let t=null;for(let i=0;i<e.length;++i)if((0,L.isBarColorerPlot)(e[i])){const e=new zt(this,i);null===t?t=e:t.pushBackBarColorer(e)}return t}isSavedInStudyTemplates(){return this._metaInfo.inputs.every((e=>"bar_time"!==e.type))}restart(e){this._restarting=!0,this.clearData(),(e||ve.enabled("stop_study_on_restart"))&&this.stop(),setTimeout(this.start.bind(this),0)}stop(e,t){if(!0===e&&this._children)for(const e of this._children)e.stop(!0);this._stopStudyOnServer(),this.clearData(),this._unsubscribeToSessionId(),this.recalculate()}disconnect(){this._studyId=null,this._model.isSnapshot()||(this._resolvedSymbols={},this._resolvedSymbolsByInput={})}sourceId(){return this._studyId}parentSources(){return this._sources}symbolSource(){return this._firstSourceOrSeries().symbolSource()}valueAt(e,t){return this.symbolSource().valueAt(e,t)}barsProvider(){return this._firstSourceOrSeries().barsProvider()}ownerSource(){return this.isChildStudy()?this._sources[0]:super.ownerSource()}isChildStudy(){return this._sources.length>0}hasChildren(){return this._children.length>0}isStarted(){return Boolean(this._studyId)}isRestarting(){return this._restarting}isActualInterval(){return this._isActualInterval}onIsActualIntervalChange(){return this._onIsActualIntervalChange}isVisible(){const e=this._properties.childs();if(this._model.collapsed().value()||!e.visible.value()||!this.isActualInterval())return!1;const t=this.metaInfo();if(t.plots.length>0)for(let i=0;i<t.plots.length;i++){const s=t.plots[i].id,r=e.styles.childs()[s];if(void 0===r)continue;if(0!==r.childs().display.value())return!0}if(t.bands)for(let i=0;i<t.bands.length;i++)if(e.bands.childs()[i].childs().visible.value())return!0;for(const i of Object.keys(t.graphics))for(const s of Object.keys(t.graphics[i])){const t=e.graphics.childs()[i]?.childs()[s];if(void 0!==t&&(t.child("visible")?.value()??1))return!0}if(t.filledAreas)for(let i=0;i<t.filledAreas.length;i++)if(e.filledAreasStyle.childs()[t.filledAreas[i].id].childs().visible.value())return!0;return!(!t.isTVScriptStrategy&&!t.hasAlertFunction)}async start(e,t,i){const s=this._model.mainSeries();await s.seriesCreated(),await Promise.all(this._sources.filter((e=>e.isHibernated())).map((e=>e.start())));const r=!(this.isHibernationAllowed()&&!this.isVisible())||!0===t;if(this._chartApi&&this._chartApi.isConnected().value()&&r)try{await this._allSymbolsAreResolved(),await this._startAfterSymbolsResolved(e,t)}catch(e){const t=`ERROR: ${this._debugId()} start failed, ${e}`;Zt.logError(t),this._restarting=!1,"TooManyStudies"===e?.cause&&(0,w.showTooManyStudiesNotice)(this._chartApi.getStudyCounter())}}replaceData(e,t,i){this._invalidateLastNonEmptyPlotRowCache(),this.data().remove(e+1),this.data().addTail(i,t)}inputs(e){const t=(0,n.default)((0,K.clone)(ei),e||{})
;t.skipOptionalEmptySymbolInputs&&(t.keepOptionalSymbolsEmpty=!0);const i=(0,r.default)(this._buildInputs(t));return t.patchSosInputs&&O.StudyMetaInfo.patchSoSInputs(i,(e=>this._sources.find((t=>t.id()===e))?.sourceId()??null)),i}data(){return this._data}moveData(e){this._ongoingDataUpdate=this._ongoingDataUpdate.then((()=>{this._invalidateLastNonEmptyPlotRowCache(),this.data().move(e)}))}plots(){return this.data()}metaInfo(){return this._metaInfo}status(){return this._compileActiveStatus??this._compileErrorStatus??this._status}name(e){return e?this.metaInfo().shortDescription||"Study":this.metaInfo().description||"Study"}title(e,t,i,s,r,n){s=void 0===s?!this._showStudyArgumentsProperty.value():s;const o=JSON.stringify([e,t,i,s,r,n]);if(this._titleStrCache[o])return this._titleStrCache[o];if(this._titleInPartsCache[o])return this._joinTitlesParts(this._titleInPartsCache[o]);const a=this._title(e,t,i,s,r,n);return this._titleStrCache[o]=a,a}titleInParts(e,t,i,s,r){s=void 0===s?!this._showStudyArgumentsProperty.value():s;const n=JSON.stringify([e,t,i,s,r]);if(this._titleInPartsCache[n])return this._titleInPartsCache[n];const o=this._titleInParts(e,t,i,s,r);return this._titleInPartsCache[n]=o,o}invalidateTitleCache(e){if(this._titleStrCache={},this._titleInPartsCache={},!0===e&&this._children)for(let t=0;t<this._children.length;++t)this._children[t].invalidateTitleCache(e)}graphics(){return this._graphics}graphicsInfo(){return this._metaInfo.graphics}priceLabelText(e){const t=this._metaInfo.styles,i=this._metaInfo.ohlcPlots;let s;t&&t[e]&&(s=t[e]),i&&i[e]&&(s=i[e]);const r=(0,o.ensureDefined)(s).title;return 1!==this._simplePlotsCount||(0,L.isPlotTitleDefined)(r)?this._metaInfo.is_price_study&&r!==this._metaInfo.shortDescription?""===r?this._metaInfo.shortDescription:this._metaInfo.shortDescription+":"+r:r:this._metaInfo.shortDescription}setOwnFirstValue(e){this._ownFirstValue=e}firstValue(e,t){if(t)return this._series.firstValue();if(!this.isChildStudy()&&"Compare@tv-basicstudies"===this._metaInfo.id||!this._metaInfo.is_price_study){const t=this._model.timeScale().visibleBarsStrictRange();if(null===t)return null;const i=this.properties().childs();if(!i.visible.value()||!this.isActualInterval()||null!==this._startMovingPoint)return this._ownFirstValue;const s=t.firstBar(),r=t.lastBar();let n=this._graphicsPriceRangeGroups?function(e,t){const i=e.model().timeScale();if(i.isEmpty())return null;const s=i.visibleBarsStrictRange();if(null===s)return null;const r=s.firstBar(),n=s.lastBar(),o=new he;for(const e of t){const t=e.firstValue(r,n);o.improve(t)}return o.bestPrice()}(this,this._graphicsPriceRangeGroups):null;const a=(this._metaInfo.plots||[]).filter((e=>!this._metaInfo.isPlotForceOverlay(e.id)));if(null===n){const t=new Set,l=this._metaInfo.filledAreas||[];for(let e=0;e<l.length;e++){const s=l[e];i.filledAreasStyle.childs()[s.id].childs().visible.value()&&(t.add(s.objAId),t.add(s.objBId))}for(const l of this.data().rangeIterator(s,r)){const s=l.value;for(let r=0;r<a.length;++r){if((0,L.isColorerPlot)(a[r]))continue
;const l=s[r+1];if(null==l)continue;const h=a[r].id;if((0!==(0,o.ensureDefined)(i.styles.childs()[h]).childs().display.value()||t.has(h))&&!(e&&Math.abs(l)<1e-10)){n=l;break}}if(null!==n)break}}return this._ownFirstValue=n,null!==n?n:this._bandsFirstValue(e)}if(this.isChildStudy()){const e=this._getNonPriceParent();if(e&&this.priceScale()===e.priceScale())return null!==e._ownFirstValue?e._ownFirstValue:e.firstValue()}return this._series.firstValue()}desiredPriceScalePosition(){if(this.metaInfo().isTVScriptStub)return"overlay";if(this.metaInfo().linkedToSeries)return"as-series";switch(this.metaInfo().priceScale){case 1:return"left";case 0:return"right";case 2:return"overlay";default:return null}}offset(e){let t=0;this._plotOffsets&&void 0!==this._plotOffsets[e]&&(t+=this._plotOffsets[e]);const i=this.properties().childs(),s=i.offsets?.childs()[e];return s&&(t+=s.childs().val.value()),i.offset&&(t+=i.offset.childs().val.value()),t}tags(){return!this._metaInfo||!this._metaInfo.description||this._metaInfo.isTVScriptStub||this._metaInfo.is_hidden_study||this._metaInfo.isTVScript&&"tv-scripting"===this._metaInfo.productId?[]:[this._metaInfo.description]}copiable(){return ri&&!this.isChildStudy()}setPriceScale(e){super.setPriceScale(e),(0,Gt.emit)("study_event",this.id(),"price_scale_changed")}priceRange(e,t,i){let s=null;const r=this._metaInfo,n=this._fillPrecalculatedAutoscaleInfo(e,t,i);let a=this.data().minMaxOnRangeCached(e,t,n.fields);if(a=(0,T.mergeMinMax)(n.baseValueMinMax,a),n.useMainSeriesRange){const i=[{name:"low",offset:0},{name:"high",offset:0}],s=this.series().data().bars().minMaxOnRangeCached(e,t,i);a=(0,T.mergeMinMax)(a,s)}if(null!==a&&(s=new D.PriceRange(a.min,a.max)),r.bands&&i.targetPriceScale===this.priceScale())for(let e=0;e<r.bands.length;e++){const t=(0,o.ensureDefined)(this._properties.childs().bands.childs()[e]).childs();if(t.visible.value()){const e=t.value.value();if(!(0,K.isNumber)(e))continue;s?s.apply(e,e):s=new D.PriceRange(e,e)}}if(this._graphicsPriceRangeGroups){const r=this.priceScale()===this._series.priceScale()?void 0:this.priceScale()!==i.targetPriceScale,n=function(e,t,i,s){let r=null;for(const n of e){const e=n.groupPriceRange(t,i,s);null!==e&&(r=null===r?e:r.merge(e))}return r}(this._graphicsPriceRangeGroups,e,t,!!i.forceOverlayOnly||r);n&&(s=s?s.merge(n):n)}return this._postProcessPriceRange(s,i)}autoScaleInfo(e,t,i){const s=this.priceRange(e,t,i),r=this.priceScale()===this._series.priceScale()?void 0:this.priceScale()!==i.targetPriceScale,n=this._graphicsPriceRangeGroups?function(e,t,i,s){const r=oe();for(const n of e){const e=n.groupPixelMargins(t,i,s);r.bottomPixelMargin=Math.max(r.bottomPixelMargin,e.bottomPixelMargin),r.topPixelMargin=Math.max(r.topPixelMargin,e.topPixelMargin)}return r}(this._graphicsPriceRangeGroups,e,t,!!i.forceOverlayOnly||r):{topPixelMargin:0,bottomPixelMargin:0};return{range:s,topPixelMargin:n.topPixelMargin,bottomPixelMargin:n.bottomPixelMargin}}formatter(e){return this._formatter??this._firstSourceOrSeries().formatter(!1)}defaultFormatter(){
const e=this._firstSourceOrSeries();return this._defaultFormatter??e.defaultFormatter?.()??e.formatter()}plotFormatter(e){return this._plotFormatters.get(e)??this.formatter()}isMultiPaneAvailable(){return this._metaInfo.hasForceOverlayPlots()||(0,A.hasForceOverlayPrimitives)(this._metaInfo)}isMultiPaneEnabled(){return this._metaInfo.hasForceOverlayPlots()}updateAllViews(e){const t=this._model.paneForSource(this),i=this._model.mainPane(),s="viewport-change"===e.type&&e.pane&&e.pane!==i;"viewport-change"===e.type&&e.pane&&e.pane!==t||(this._paneViews.forEach((t=>t.update(e))),this._labelPaneViews.forEach((t=>t.update(e))),this._dataWindowView?.update(),this._legendView?.update(),this._statusView?.update(),this._priceAxisViews.forEach((t=>t.update(e))),this._priceLinesAxisViews.forEach((t=>t.update(e))),this._inputsLinesPaneView?.update(e),this._inputsAnchorsPaneView?.update(e),this._inputsTimeAxisPaneViews.forEach((t=>t.update(e))),this._inputsPriceAxisPaneViews.forEach((t=>t.update(e)))),s||(this._forceOverlaysPaneViews.forEach((t=>t.update(e))),this._forceOverlayLabelPaneViews.forEach((t=>t.update(e))),this._forceOverlayPriceAxisViews.forEach((t=>t.update(e)))),"data-source-change"===e.type&&e.sourceId===this.id()&&e.clearData&&this._children.forEach((e=>e.updateAllViews({type:"data-source-change",sourceId:e.id(),clearData:!0})))}removeByRemoveAllStudies(){return!0}getStudyName(){return this._studyName}nearestIndex(e,t,i){return this.data().search(e,t,i)?.index}getMinFirstBarIndexForPlot(e){const t=this._properties.childs(),i=this._metaInfo,s=t.styles.childs()[e]?.child("showLast")?.value()??t.filledAreasStyle.childs()[e]?.child("showLast")?.value()??i.styles?.[e]?.showLast??t.ohlcPlots.childs()[e]?.child("showLast")?.value()??i.ohlcPlots?.[e]?.showLast??null;if(null===s)return-1/0;const r=this.data().lastIndex();return null===r?-1/0:r-s+1}guiPlotName(e,t){return this._metaInfo.styles?.[t]?.title??this.title(e)}childStudyByRebind(){return this._childStudyByRebind}isPine(){return void 0!==this._metaInfo.pine}isStandardPine(){return this.isPine()&&O.StudyMetaInfo.isStandardPine(this._metaInfo.id)}isLinkedToSeries(){return!0===this._metaInfo.linkedToSeries}preferredZOrder(){return!1===this._metaInfo.behind_chart?0:null}defaultPlotIdForAlert(){return this._metaInfo.plots.length?this._metaInfo.plots[0].id:null}resolvedSymbolInfoBySymbol(e){return this._resolvedSymbols&&e&&this._resolvedSymbols[this._getSymbolForResolve(e)]||null}hasPendingUnresolvedSymbols(){return this._pendingResolveSymbols.size>0}hasSymbolInputs(){return this._metaInfo.inputs.some((e=>"symbol"===e.type))}currency(){const e=this.metaInfo();return Boolean(e)&&e.is_price_study?this._firstSourceOrSeries().currency():null}currencySourceSymbolInfo(){return this._currencySourceSymbolInfo??this.symbolSource()?.symbolInfo()??null}unit(){const e=this.metaInfo();return Boolean(e)&&e.is_price_study?this._firstSourceOrSeries().unit():null}canOverrideMinTick(){return!1}dataWindowView(){return this._dataWindowView}statusView(){return this._statusView}legendView(){
return this._legendView}pineSourceCodeModel(){return this.metaInfo().pine?(this._pineSourceCodeModel||(this._pineSourceCodeModel=new C.AsyncResourceWrapper(Promise.all([i.e(89230),i.e(35980),i.e(97525),i.e(19719),i.e(65414),i.e(42095),i.e(26035),i.e(83005),i.e(89199)]).then(i.bind(i,38447)).then((e=>this._isDestroyed?null:new e.PineSourceCodeModel(this))))),this._pineSourceCodeModel.promise()):Promise.resolve(null)}inputsForAlertState(){return this.inputs()}sessionId(){return this._firstSourceOrSeries().sessionId()}sessionIdChanged(){return this._firstSourceOrSeries().sessionIdChanged()}getSymbolString(e){return""===e?"":(0,z.encodeExtendedSymbolOrGetSimpleSymbolString)(this._getSymbolObject(e))}onStatusChanged(){return this._statusChanged}symbolsResolved(){return this._symbolsResolved}onHibernationStateChange(){return this._onHibernationStateChange}legendValuesProvider(){return new E.StudyLegendValuesProvider(this,this.model())}statusProvider(e){return new $.StudyStatusProvider(this)}correctScaleMargins(e){if("Volume"===this.metaInfo().shortId){const t=this.model().paneForSource(this);return null!==t&&t.isOverlay(this)&&t.containsMainSeries()?{top:.75,bottom:0}:{top:e.top,bottom:0}}return e}canBeHiddenByGlobalFlag(){return!0}isSourceHidden(){return!this.isVisible()||this.canBeHiddenByGlobalFlag()&&W.hideAllIndicators().value()}wasCompletedBefore(){return this._wasCompletedBefore}paneViews(e){const t=this._model.mainPane();if(this.isSourceHidden())return null;if(!e.hasPriceDataSource(this))return e!==t?null:this._forceOverlaysPaneViews;const i=[];return!this._startMovingPoint&&this._wasCompletedBefore&&i.push(...this._paneViews.filter((e=>!e.isForceOverlay?.()))),this._inputsLinesPaneView&&(this._startMovingPoint||this._model.selection().isSelected(this))&&i.push(this._inputsLinesPaneView),this._inputsAnchorsPaneView&&i.push(this._inputsAnchorsPaneView),e===t&&i.push(...this._forceOverlaysPaneViews),i}labelPaneViews(e){const t=this._model.mainPane();if(this.isSourceHidden()||!e.hasPriceDataSource(this))return this._metaInfo.hasForceOverlayPlots()?e!==t?null:this._forceOverlayLabelPaneViews:null;const i=[...this._labelPaneViews];return e===t&&i.push(...this._forceOverlayLabelPaneViews),i}timeAxisViews(){return this._model.selection().isSelected(this)?this._inputsTimeAxisPaneViews:null}priceAxisViews(e,t){if(t!==this.priceScale()&&t===this._model.mainSeries().priceScale()&&!e.hasDataSource(this))return this._forceOverlayPriceAxisViews;const i=this._properties.childs().oldShowLastValue;if(i&&!i.value())return null;let s=this._priceAxisViews.slice();return this._model.selection().isSelected(this)&&(s=s.concat(this._inputsPriceAxisPaneViews)),t===this._model.mainSeries().priceScale()&&(s=s.concat(this._forceOverlayPriceAxisViews)),e.findTargetPriceAxisViews(this,t,s,this._priceLinesAxisViews)}movable(){return null!==this._inputsAnchorsPaneView}startMoving(e,t,i,s){this._startMovingPoint=e}move(e,t,i,s){if(void 0!==e.logical&&null!==this._startMovingPoint){if(Array.isArray(t)){const i=t
;this._updateInputValue(e.logical,i[0]),this._updateInputValue(e.logical,i[1])}else this._updateInputValue(e.logical,t);this.updateAllViews((0,Bt.sourceChangeEvent)(this.id()))}}endMoving(e,t){return this._startMovingPoint=null,{indexesChanged:!1,pricesChanged:!1}}clearData(){this._invalidateLastNonEmptyPlotRowCache(),this.data().clear(),this._graphics instanceof F.LiveStudyGraphics&&this._graphics?.clear(),this._plotOffsets={},this.hasBarColorer()&&this._model.mainSeries().invalidateBarStylesCache(),this.updateAllViews((0,Bt.sourceChangeEvent)({sourceId:this.id(),clearData:!0}))}convertYCoordinateToPriceForMoving(e,t){const i=this.priceScale();if(!t||!i||i.isEmpty())return null;const s=t.firstValue();return null===s?null:i.coordinateToPrice(e,s)}processHibernate(e){const t=this.isVisible();if(!this.isStarted()&&t&&(this._sources.forEach((e=>{e.processHibernate()})),this.start(void 0,void 0,e),this._onHibernationStateChange.fire(!1)),this.isHibernationAllowed()&&this.isStarted()&&!t){for(const e of this._children)e.processHibernate();this.stop(void 0,e),this._onHibernationStateChange.fire(!0)}}isHibernationAllowed(){return!this.metaInfo().historyCalculationMayChange&&(!this.hasChildren()||!!this._model.collapsed().value()&&this._children.every((e=>e.isHibernationAllowed())))}isPlotVisibleAt(e,t){let i;const s=this.metaInfo().plots.find((t=>t.id===e));if(i=void 0!==s?(0,L.isOhlcPlot)(s)?this._properties.childs().ohlcPlots.childs()[s.target]:this._properties.childs().styles.childs()[e]:this._properties.childs().ohlcPlots.childs()[e],void 0===i)throw new Error(`Study does not contain ${e} plot`);const r=i.childs().display.value();return null!==r&&(r&t)===t}recalculate(){const e=this._model.paneForSource(this);this._model.recalculatePane(e,(0,Bt.sourceChangeEvent)(this.id())),this._model.updateSource(this)}maxOffset(){return this._maxOffset}onStart(){return this._onStart}onParentSourcesChanges(){return this._onParentSourcesChanges}isHibernated(){return!this.isVisible()&&!this.isStarted()}graphicsViewsReady(){return this._graphicsViewsReady}setLoadingCompilationActive(e){this._compileActiveStatus=e?{type:Tt.StudyStatusType.Loading,startTime:Date.now()}:null,this._statusView?.update(),this._model.updateSource(this),this._statusChanged.fire(this.status())}setErrorCompilation(e){{const t=(0,ce.extractPineId)(this._metaInfo.id);if(null===e||0===e.length||null===t)return this._compileErrorStatus=null,void this._setStatus({type:Tt.StudyStatusType.Undefined});const i=e[0];this._compileErrorStatus={type:Tt.StudyStatusType.Error,errorDescription:{error:i.message,editorError:{...i,id:t},title:"Compilation error"}},this._statusView?.update(),this._model.updateSource(this),this._statusChanged.fire(this.status())}}hasCompileError(){return null!==this._compileErrorStatus}turnaround(e){if(!e)return this._turnaround;return function(e,t){let i=t.turnaround,s=[t];for(;s.length>0;){let e=[];const t=[];s.forEach((i=>{const s=ye(i.sourceStudies).sort(me);if(s.length>0){e=e.concat(s);const i=s.map((e=>e.turnaround)).join("_");t.push(i)}})),
t.length&&(i=t.join("_")+"_"+i),s=e}return e+"_"+i}(this._series.seriesSource().turnaround(),ge(this))}canHaveChildren(){return this._canHaveChildren=this._canHaveChildren??O.StudyMetaInfo.canHaveChildren(this._metaInfo),this._canHaveChildren}setChild(e){-1===this._children.indexOf(e)&&this._children.push(e)}unsetChild(e){const t=this._children.indexOf(e);~t&&this._children.splice(t,1)}getAllChildren(){const e=this._children.slice();for(let t=0;t<e.length;++t){const i=e[t].getAllChildren();for(let t=0;t<i.length;++t)~e.indexOf(i[t])||e.push(i[t])}return e}parentSourceForInput(e){if(e.includes("$")){const t=e.split("$")[0];return this._sources.find((e=>e.id()===t))??null}return this._series}priceStep(){return this._priceStep||this._firstSourceOrSeries().priceStep(!1)}recreatePriceFormatter(){this._recreatePriceFormattingDependencies()}setOwnerSource(e){super.setOwnerSource(e),this._recreatePriceFormattingDependencies()}onTagsChanged(){return this._tagsChanged}getPropertyDefinitionsViewModel(){return null===this._definitionsViewModel?this._getPropertyDefinitionsViewModelClass().then((e=>null===e||this._isDestroyed?null:(null===this._definitionsViewModel&&(this._definitionsViewModel=new e(this._model.undoModel(),this)),this._definitionsViewModel))):Promise.resolve(this._definitionsViewModel)}calculationTime(){return this._calculationTime.readonly()}_getPropertyDefinitionsViewModelClass(){return Promise.resolve(null)}_alertMetaInfo(){return this.metaInfo()}_createStudyOnServer(){if(this._isDestroyed)return!1;const e=this._metaInfo.useVersionFromMetaInfo?(0,O.getStudyIdWithVersion)(this._metaInfo):this._getStudyIdWithLatestVersion();this._studyId=(0,G.makeNextStudyId)(),this._incrementTurnaround(),this._studyName=e;const t=(0,K.clone)((0,o.ensureDefined)(this._inputs));let i;if(O.StudyMetaInfo.patchSoSInputs(t,(e=>this._sources.find((t=>t.id()===e))?.sourceId()??null)),i=this._chartApi.createStudy(this._studyId,this._turnaround,(0,o.ensureNotNull)(this._series.seriesSource().instanceId()),this._studyName,t,this._handler,this._studySpec()),!i)return this._studyId=null,i;if(performance.mark(`calculate_study_${this._studyId}`),void 0===this._oldStudyInputs){if(this._metaInfo.TVScriptMetaInfoExprs){this._previousPatchMap={};const e=this._metaInfo.TVScriptMetaInfoExprs.patchMap;(0,b.iterateAndPatchObjectsByMap)([this._properties,this._metaInfo.defaults,this._metaInfo],e,((e,t,i)=>{const s=e[0],r=e[1],n=e[2];r.hasOwnProperty(t)?(0,o.ensureDefined)(this._previousPatchMap)[i]=s[t].value():(0,o.ensureDefined)(this._previousPatchMap)[i]=n[t]}))}const e=this._prepareInputs(ti);Object.keys(e).some((e=>(0,_.isStudyInputDependsOnChart)({id:e})))||(this._oldStudyInputs=e)}return this._deferredPinePatchProps&&!this._restarting&&this._pinePatchProps(),!0}_stopStudyOnServer(){this._chartApi&&this._chartApi.isConnected().value()&&this.isStarted()&&(this._chartApi.removeStudy((0,o.ensureNotNull)(this._studyId)),this._setStatus({type:Tt.StudyStatusType.Undefined})),performance.clearMarks(`calculate_study_${this._studyId}`),this._studyId=null}
_modifyStudyOnServer(e,t){const i=(0,K.clone)((0,o.ensureDefined)(e));O.StudyMetaInfo.patchSoSInputs(i,(e=>this._sources.find((t=>t.id()===e))?.sourceId()??null)),this._chartApi.modifyStudy((0,o.ensureNotNull)(this._studyId),this._turnaround,i,this._handler,t),performance.mark(`calculate_study_${this._studyId}`)}_sendNotifyCommand(e,t){this._chartApi.notifyStudy((0,o.ensureNotNull)(this._studyId),e,t)}_transformData(e){}_invalidateLastNonEmptyPlotRowCache(){this._lastNonEmptyPlotRowCache={}}_collectDepsForAlert(){const e=[this,...this._getAllOwnerSources().filter((e=>e instanceof fi))];return(0,g.collectDepsForAlert)(e)}_allInputsAreValid(){if(null===this._visibleTimeRangeInputs?.value())return!1;for(const e of this._metaInfo.inputs)if("bar_time"===e.type){const t=e.id;if(null==this._properties.childs().inputs.childs()[t].value())return!1}return!0}async _startAfterSymbolsResolved(e,t){await Promise.all(this._sources.map((e=>!e.isStarted()||e.isRestarting()?new Promise((t=>{e.onStart().subscribe(this,t,!0)})):Promise.resolve()))),this.isStarted()&&!this._restarting||(this._restarting=!1,this._allInputsAreValid()&&!this.metaInfo().isTVScriptStub&&(this._inputs=this._apiInputs(),this._createStudyOnServer()&&(this._subscribeToSessionId(),this._onStart.fire(),!0===e&&this._children&&await this._children.map((e=>e.start(!0,t))))))}async _changeInputsImpl(e,t){const s=this._calcSources(),r=ui(this._metaInfo,e,t),n=()=>{for(const i of this._metaInfo.inputs){if("source"!==i.type)continue;const s=e[i.id].v,r=t[i.id].v;if(s!==r){(0,o.ensureDefined)(this._properties.childs().inputs.child(i.id)).setValue(r)}}};if(this.isStarted()&&this._chartApi.isConnected().value()&&r>0&&!this._chartApi.canCreateStudy(this._studySpec(!0),!0).success){const e=window.user.pro_plan;return(0,I.createGoProDialog)({feature:"studyOnStudy",actions:e&&"pro_premium_expert"===e?[{text:a.t(null,void 0,i(515462)),action:P.PredefinedAction.Close}]:void 0}),void n()}this._inputs=e;let l=!1;const h=Object.values(_.RangeDependentStudyInputNames);for(const i of Object.keys(e))if(JSON.stringify(e[i])!==JSON.stringify(t[i])&&!h.includes(i)){l=!0;break}this._incrementTurnaround(),l&&this.disablePriceRangeReady();try{await this._updateParentSources(s,r,!0),this._modifyStudyOnServer(e,r),this._studyModified=!0}catch(e){Zt.logError(`Error applying parent sources: ${e}`),n()}this.invalidateTitleCache()}_createPriceAxisView(e){return new Ht.StudyPriceAxisView(this,{plotIndex:e})}_createPriceLineAxisView(e){return new Wt.StudyPriceLineAxisView(this,e)}_createStudyPlotPaneView(e){return new mt.StudyPlotPaneView(this,this._series,this._model,e)}_createViews(){this._priceAxisViewsBase=[],this._forceOverlayPriceAxisViews=[],this._priceLinesAxisViews=[],this._paneViews=[],this._forceOverlaysPaneViews=[],this._labelPaneViews=[],this._forceOverlayLabelPaneViews=[];const e=new Set,t=this.metaInfo(),i=Boolean(t.usePlotsZOrder),s=new Map,r=this._properties.childs();if(r.filledAreasStyle&&t.filledAreas)for(let e=0;e<t.filledAreas.length;++e){const n=t.filledAreas[e],a=(0,
o.ensureDefined)(r.filledAreasStyle.childs()[n.id]),l=hi(t,n.id);let h;if("plot_plot"===n.type||l?h=new wt(this,this.model(),n,a):"hline_hline"===n.type?h=new Dt(this,n,a):Zt.logWarn("Unsupported filledArea type: "+n.type),void 0!==h){let e=!1;if("plot_plot"===n.type&&(e=t.isPlotForceOverlay(n.objAId)),e)this._forceOverlaysPaneViews.push(h);else{const e=i?(0,o.ensureDefined)(n.zorder):s.size;li(e,s),s.set(e,{paneViews:[h]})}}}{let r=-1e5;for(let n=0;n<t.plots.length;n++){const a=t.plots[n];let l,h,u,c,d,p=t.isPlotForceOverlay(a.id);if((0,L.isNonVisualPlot)(a))continue;let _=a.id,f=t.styles;const m=(0,L.isBgColorerPlot)(a);if(m)l=new Ce(this,this._series,this._model,_);else if((0,L.isShapesPlot)(a))l=new Ge(this,this._series,this._model,_);else if((0,L.isCharsPlot)(a))l=new it(this,this._series,this._model,_);else if((0,L.isArrowsPlot)(a))l=new ht(this,this._series,this._model,_);else if((0,L.isOhlcPlot)(a)){const i=a.target;if(e.has(i))continue;if(p=t.isPlotForceOverlay(i),e.add(i),oi(t,n))l=new dt(this,this._series,this._model,i);else{if(!ai(t,n)){Zt.logError(`plot ${a.id} looks to be invalid`);continue}l=new _t(this,this._series,this._model,i)}c=this._createPriceAxisView(i),u=new ft.PanePriceAxisView(c,this,this._model),_=i,f=t.ohlcPlots}else(0,L.isDataPlot)(a)||(c=this._createPriceAxisView(_),d=this._createPriceLineAxisView(_),l=this._createStudyPlotPaneView(_),this._properties.childs().styles.childs()[_]?.child("trackPrice")?.value()&&(h=new vt(this,_)),u=new qt(c,this,this._model,_));const y=i?m?r++:(0,o.ensureDefined)(f?.[_]?.zorder):s.size;if(li(y,s),p)c&&this._forceOverlayPriceAxisViews.push(c),l&&this._forceOverlaysPaneViews.push(l),u&&this._forceOverlayLabelPaneViews.push(u);else{const e={paneViews:void 0!==l?[l]:[],labelView:u,priceAxisView:c,priceLineAxisView:d};void 0!==h&&e.paneViews.push(h),s.set(y,e)}}}(this._metaInfo.bands??[]).forEach(((e,t)=>{const n=r.bands.childs()[t];if(n&&n.childs().visible.value()){const t=new Vt(n,this),r=i?(0,o.ensureDefined)(e.zorder):s.size;li(r,s),s.set(r,{paneViews:[t]})}})),r.bandsBackground&&((0,o.assert)(!i,"'usePlotsZOrder' flag does not supported"),s.set(s.size,{paneViews:[new Rt(this)]}));const n=this._paneViews,a=this._forceOverlaysPaneViews;this._createGraphicsPaneViews().then((e=>{for(let t=0;t<e.regularPaneViews.length;t++)n.push(e.regularPaneViews[t]);for(let t=0;t<e.forceOverlayPaneViews.length;t++)a.push(e.forceOverlayPaneViews[t]);this._model.lightUpdate(),this._graphicsViewsReady=!0})),r.areaBackground&&((0,o.assert)(!i,"'usePlotsZOrder' flag does not supported"),s.set(s.size,{paneViews:[new St.AreaBackgroundPaneView(this,this.model())]}));const l=Array.from(s.keys()).sort(((e,t)=>e-t));for(let e=0;e<l.length;e++){const t=(0,o.ensureDefined)(s.get(l[e]));this._paneViews.push(...t.paneViews),t.labelView&&this._labelPaneViews.push(t.labelView),t.priceAxisView&&this._priceAxisViewsBase.push(t.priceAxisView),t.priceLineAxisView&&this._priceLinesAxisViews.push(t.priceLineAxisView)}
this._dataWindowView||(this._dataWindowView=new Ct.StudyDataWindowView(this,this._model)),this._legendView||(this._legendView=new H(this,this._model)),this._statusView||(this._statusView=new U.StudyStatusView(this)),this._concatPriceAxisViews()}_onData(e){switch(e.method){case"study_loading":this._onStudyLoading();break;case"study_error":this._onStudyError(e.params[2]);break;case"study_completed":if(!this._checkTurnaround(e.params[1]))return;this._onStudyCompleted(e.params[e.params.length-1]);break;case"data_update":if(e.params.customId!==this.sourceId()||!this._checkTurnaround(e.params.turnaround))return;(0,o.assert)(!!e.params.nonseries,"data.params.nonseries is missing"),this._onDataUpdate(e.params.plots,(0,o.ensureDefined)(e.params.nonseries),e.params.lastBar);break;case"clear_data":this._checkTurnaround(e.params.turnaround)&&this.clearData()}}_getTelemetryObjectName(){return"study"}_onDataUpdated(e,t,i,s){if(this.hasBarColorer()&&e.length>0){const t=(0,o.ensureNotNull)(this.barColorer()).firstColoredBar(e[0].index);null!==t&&this._model.mainSeries().invalidateBarStylesCache(t)}null!==t&&this._postProcessGraphics();const r=this._model.paneForSource(this);this._model.recalculatePane(r,(0,Bt.sourceChangeEvent)({sourceId:this.id(),firstUpdatedTimePointIndex:s??void 0,nonSeriesOnly:0===e.length})),this._updateSources()}_titleInputs(e,t,i){return this.inputs(this._titleInputsOptions(e,t,i))}_titleInputsOptions(e,t,i){return{symbolsForDisplay:!0,skipHiddenInputs:!0,skipFakeInputs:!1,fakeInputsForDisplay:!0,asObject:!0,skippedGroups:[],skippedInputs:this._skippedTitleInputs(),noExchanges:t,noResolution:i,priceInputsForDisplay:!0,skipOptionalEmptySymbolInputs:si,displayMask:e}}_postProcessGraphics(){this._graphicsPriceAxisViews=this._createGraphicsPriceAxisViews(),this._concatPriceAxisViews()}async _createGraphicsPaneViews(){return(0,F.createGraphicsPaneViews)(this,this.model())}_createGraphicsPriceAxisViews(){return(0,F.createGraphicsPriceAxisViews)(this)}_subscribeToSessionId(){!this._isSubscribedToSessionId&&this.hasSymbolInputs()&&(this.sessionIdChanged().subscribe(this,this._onSessionIdChanged),this._isSubscribedToSessionId=!0)}_recreateFormatter(e){this._recreatePlotsFormatters(e),this._formatter=this._tryCreateFormatter(e),this._defaultFormatter=this._tryCreateDefaultFormatter(e),this._formatterChanged.fire();const t=this.priceScale();null!==t&&t.updateFormatter(),this.getAllChildren().forEach((e=>{e.recreatePriceFormatter()})),this._model.fullUpdate()}_recreatePriceFormattingDependencies(e){this._recreateFormatter(e),this._recreatePriceStep()}_title(e,t,i,s,r,n){const o=this._titleInParts(e,t,i,s,r,n);return this._joinTitlesParts(o)}_postProcessPriceRange(e,t){if(e&&e.minValue()===e.maxValue()&&!this.metaInfo().is_price_study){const t=.005*e.minValue();e=new D.PriceRange(e.minValue()-t,e.maxValue()+t)}const i=t.targetPriceScale;return i&&i.isLog()&&e?new D.PriceRange(i.priceToLogical(e.minValue()),i.priceToLogical(e.maxValue())):e}_titleInParts(e,t,s,r,n,l){const h=this.name(t);s=s||{};const u=[a.t(h,{
context:"study"},i(783477))];let c=[];if(!r){const i=this._getMTFResolutionInputTitle();null!==i&&i.length>0&&u.push(i);const r=this.metaInfo(),a=this._titleInputs((0,Xt.toInputDisplayFlags)(e),n,!0),h=r.inputs.filter((e=>a.hasOwnProperty(e.id))).map((e=>({meta:e,value:a[e.id]})));if(h.length>0){const i={};if(this.isChildStudy())for(let s=0;s<r.inputs.length;++s){const a=r.inputs[s];if(!O.StudyMetaInfo.isSourceInput(a))continue;const h=a.id,u=(0,o.ensureDefined)(this._properties.childs().inputs.child(h)).value();if(u.indexOf("$")>=0){const s=this.parentSourceForInput(u);if(s instanceof fi){const r=s.metaInfo(),o=s.title(e,t,{},!0,n,l);if(1===r.plots.length)i[u]=o;else{const e=u.split("$")[1],t=r.plots[parseInt(e)]?.id,s=r.styles&&r.styles[t],n=s&&s.title||t;i[u]=o+":â€‰"+n}}}}c=h.map((({meta:e,value:t})=>{if("time"===e.type)return new Date(t).toISOString();let r=(0,K.isNumber)(t)?(0,Yt.getNumericFormatter)().format(t):i&&i[t.toString()]||t.toString();return s&&s[r.toString()]&&(r=s[r.toString()]),r}))}}return e===q.TitleDisplayTarget.StatusLine&&this._showPineVersionInStatusLine.value()&&u.push((0,o.ensureDefined)(this._metaInfo.pine).version),[u.join(" Â· "),c]}_seriesDataRangeToSave(e){return this._model.timeScale().visibleExtendedDataRange(e,0)}_getSymbolForResolve(e){return this.getSymbolString(this._getSymbolForApi(e))}_getSymbolForApi(e){return e}_getSymbolObject(e){const t={symbol:e},i=this.currency();return null!==this._currencySourceSymbolInputProperty&&null!==this._currencySourceSymbolInfo&&this._getSymbolForApi(this._currencySourceSymbolInputProperty.value())===e&&(t["currency-id"]=i),t.session=this.sessionId(),t}_onSymbolResolved(e,t,i){{const e=(0,o.ensureNotNull)(this._model.alertsWatcher());e.syncSourceAlertLabels(this);const t=this.getAllChildren();for(const i of t)e.syncSourceAlertLabels(i)}this._onCurrencyMayChange()}_onSymbolResolvingStart(e,t){}_onSymbolError(){}_setStatus(e,t){const i=this.isFailed();this._status=e,e.type===Tt.StudyStatusType.Completed?this._wasCompletedBefore=!0:e.type!==Tt.StudyStatusType.Error&&e.type!==Tt.StudyStatusType.Undefined||(this._wasCompletedBefore=!1),t||(this._statusView?.update(),this._model.updateSource(this),this._statusChanged.fire(this.status())),i!==this.isFailed()&&this._updateAlertCreationAvailable()}_onPropertiesChanged(){this._restarting||(this._inputs?this._tryChangeInputs():this._chartApi&&this._chartApi.isConnected().value()&&this.restart()),this._metaInfo.isTVScript&&this._metaInfo.TVScriptMetaInfoExprs&&(this._restarting?this._deferredPinePatchProps=!0:this._pinePatchProps()),this._recreatePaneViews(),(0,Gt.emit)("study_properties_changed",this._id.value())}_lastNonEmptyPlotRow(e){if(!(0,K.isInteger)(e))return Zt.logDebug("_lastNonEmptyPlotRow: incorrect plotIndex"),null;let t=this._lastNonEmptyPlotRowCache[e]??null;if(null!==t)return t;return t=this.data().findLast(((t,i)=>void 0!==i[e]),1e3),null===t?null:(this._lastNonEmptyPlotRowCache[e]=t,t)}_onCurrencyChanged(){"alwaysOff"!==(0,
Lt.currencyUnitVisibilityProperty)().value()&&this._model.fullUpdate(),this.isStarted()&&this._tryChangeInputs(),this._currencyChanged.fire()}_apiInputs(){return this.inputs({keepOptionalSymbolsEmpty:!0})}async _tryChangeInputs(){const e=this.isStarted()&&this._chartApi.isConnected().value(),t=this._allInputsAreValid(),i=(0,o.ensureDefined)((0,K.clone)(this._inputs)),s=this._apiInputs(),r=JSON.stringify(s),n=r!==JSON.stringify(this._inputs);if(e&&t)try{if(await this._allSymbolsAreResolved(),r!==JSON.stringify(this._apiInputs()))return this._tryChangeInputs();if(this._isStopped())return void(n&&this.disablePriceRangeReady());n&&(await this._changeInputsImpl(s,(0,o.ensureDefined)((0,K.clone)(this._inputs))),(0,o.ensureNotNull)(this.model().alertsWatcher()).syncSourceAlertLabels(this))}catch(e){Zt.logError(`ERROR: ${this._debugId()} _tryChangeInputs: cannot modify study, ${e}`)}else if(e&&!t&&this.stop(!0),!e&&t&&this.start(!0),n){const e=this._calcSources(),t=ui(this._metaInfo,s,i);this._updateParentSources(e,t,!0),this._inputs=s}this._tagsChanged.fire()}_onCurrencyMayChange(){if(null!==this._currencySourceSymbolInputProperty){const e=this.currency();this._updateCurrencySourceSymbolInfo(),e!==this.currency()&&this._onCurrencyChanged()}}_fillPrecalculatedAutoscaleInfo(e,t,i){const s=this._metaInfo,r=this.properties().childs(),n=new Set,o=this._metaInfo.filledAreas||[];for(let e=0;e<o.length;e++){const t=o[e];r.filledAreasStyle.childs()[t.id].childs().visible.value()&&(n.add(t.objAId),n.add(t.objBId))}return s.plots.filter((e=>!(0,L.isPlotWithTechnicalValues)(e))).filter((e=>this._metaInfo.isPlotForceOverlay(e.id)?i.targetPriceScale===this._model.mainSeries().priceScale():i.targetPriceScale===this.priceScale()&&!i.forceOverlayOnly)).filter((e=>n.has(e.id)||this.isPlotVisibleAt(e.id,1))).reduce(((i,s)=>this._applyPlotToPrecalculatedAutoscaleInfo(e,t,i,s)),{fields:[],useMainSeriesRange:!1,baseValueMinMax:null})}_firstSourceOrSeries(){return this._sources[0]??this._series}_skipHistogramBaseOnAutoScale(){return!1}_tryCreateFormatter(e){const t=void 0===e?this.symbolSource().symbolInfo():e;return pi(this._metaInfo.format,this._priceScaleByProperties(),t,this.properties().childs().precision.value())}_tryCreateDefaultFormatter(e){return this._tryCreateFormatter(e)}_mergeData(e){return this._invalidateLastNonEmptyPlotRowCache(),this.data().merge(e)}_skippedTitleInputs(){return this._hideMatches.filter((e=>e.plotIds.every((e=>0===this._getPlotDisplayValue(e))))).map((e=>e.id))}_getPlotDisplayValue(e){return this.properties()?.childs()?.styles?.childs()?.[e]?.childs()?.display?.value()}_onStudyError(e){performance.clearMarks(`calculate_study_${this._studyId}`),this._handleStudyError(this._createStudyError(e)),this._enablePriceRangeReady()}_onStudyCompleted(e){if(performance.getEntriesByName(`calculate_study_${this._studyId}`).length){try{const e=performance.measure(`measure_study_${this._studyId}`,`calculate_study_${this._studyId}`);this._calculationTime.setValue(e.duration)}catch(e){
Zt.logError("Error during measuring study calculation time")}performance.clearMarks(`calculate_study_${this._studyId}`),performance.clearMeasures(`measure_study_${this._studyId}`)}this._studyModified&&(this.clearData(),this._studyModified=!1),this._sendTelemetryCounter(this._getTelemetryObjectName()+"_loaded"),this._setStatus({type:Tt.StudyStatusType.Completed}),this._statusView?.update();const t=this._model.paneForSource(this);this._model.recalculatePane(t,(0,Bt.sourceChangeEvent)(this.id())),this._updateSources();const i=Ft.InvalidationMask.full();null!==this._model.appliedTimeFrame().value()&&i.lockVisibleTimeRangeOnResize(),this._model.invalidate(i)}_incrementTurnaround(){this._turnaround="st"+ ++this._turnaroundCounter}_checkTurnaround(e){return e===this._turnaround||e===this._model.mainSeries().seriesSource().turnaround()||e===this.turnaround(!0)}_updateMaxOffsetValue(){let e=-1/0;for(const t of this._metaInfo.plots)e=Math.max(this.offset(t.id),e);this._maxOffset.setValue(e)}_rightOffsetToUnixTime(e){if(this._series.bars().size()>=e){const t=(0,o.ensureNotNull)(this._series.bars().lastIndex())-e;return(0,o.ensureNotNull)(this._series.bars().valueAt(t))[0]}return null}_concatPriceAxisViews(){this._priceAxisViews=[...this._priceAxisViewsBase,...this._graphicsPriceAxisViews]}_onStudyLoading(){this._setStatus({type:Tt.StudyStatusType.Loading,startTime:Date.now()}),this._statusView?.update(),this._model.updateSource(this)}_handleStudyError(e){this.clearData(),this._setStatus(e);{const t=(0,Tt.convertStudyStatusToString)(e),i=this._getTelemetryAdditionalData(),s=t.indexOf("Command info");i.reason=s>=0?t.slice(0,s).trim():t;if(!/study in error state|the data vendor doesn\'t provide volume data for this symbol.|error in series|unsupported resolution/gi.test(i.reason?.toLowerCase()??"")){const e=this._getTelemetryObjectName();this._sendTelemetryCounter(e+"_error",i)}}this._statusView?.update(),this._model.updateSource(this)}_createStudyError(e){let t;return t=(0,K.isString)(e)?{error:this._getStudyErrorText(e),title:e.includes("study_not_auth")?"Access error":"Runtime error"}:{...e,title:e.title??"Runtime error"},(0,Tt.createStudyError)(t,this.symbolSource().symbolInfo()?.exchange)}_updateSources(){this._model.updateSource(this),this.hasBarColorer()&&this._model.updateSource(this._model.mainSeries())}_unsubscribeToSessionId(){this._isSubscribedToSessionId&&(this.sessionIdChanged().unsubscribe(this,this._onSessionIdChanged),this._isSubscribedToSessionId=!1)}_onSessionIdChanged(){this.restart(!0)}_recreatePriceStep(){let e=null;const t=this._priceScaleByProperties()??this._priceScaleByMetaInfo();null!==t&&(e=1/t),this._priceStep!==e&&(this._priceStep=e,this._priceStepChanged.fire())}_recreatePlotsFormatters(e){this._plotFormatters.clear();const t=this._metaInfo.format,i=this._priceScaleByProperties(),s=void 0===e?this.symbolSource().symbolInfo():e;for(const[e,r]of Object.entries(this._metaInfo.ohlcPlots??{}))if(r?.format){const n=pi(di({...t,...r?.format}),i,s,this.properties().childs().precision.value())
;n&&this._plotFormatters.set(e,n)}for(const[e,r]of Object.entries(this._metaInfo.styles??{}))if(r?.format){const n=pi(di({...t,...r?.format}),i,s,this.properties().childs().precision.value());n&&this._plotFormatters.set(e,n)}for(const e of this._metaInfo.plots)if((0,L.isOhlcPlot)(e)){const t=this._plotFormatters.get(e.target);t&&this._plotFormatters.set(e.id,t)}}_joinTitlesParts(e){const t=e[1]?e[1].join(", "):"";return e[0]+(t.length>0?" ("+t+")":"")}_getMTFResolutionInputTitle(){const e=this.metaInfo();for(let t=0;t<e.inputs.length;t++){const i=e.inputs[t];if("resolution"===i.type&&i.isMTFResolution)return(0,o.ensureDefined)(this._properties.childs().inputs.child(i.id)).value()}return null}_onDataUpdate(e,t,i){this._studyModified&&(this.clearData(),this._studyModified=!1);const s=(0,M.unpackNonSeriesData)(t.d);return this._ongoingDataUpdate=this._ongoingDataUpdate.then((()=>s),(()=>s)).then(this._onDataUnpacked.bind(this,e,t.indexes,i)),this._ongoingDataUpdate}_allSymbolsAreResolved(){const e=this._inputSymbols(),t=[];let i=!1;for(const s of e){const e=this._getSymbolForResolve(s);if(""!==e)if(this._resolvedSymbols[e])i=!0;else{const i=this._resolveSymbol(e,s);t.push(i)}}if(0===t.length){const e=Promise.resolve();return i?e.then((()=>this._symbolsResolved.fire())):e}return Promise.all(t).catch((e=>(this._inputSymbols().includes(e)&&this.stop(!0),this._setStatus({type:Tt.StudyStatusType.Error,errorDescription:{error:Qt}}),this._model.updateSource(this),Promise.reject("Invalid symbol, "+e)))).then((()=>{this._symbolsResolved.fire(),this._recheckLineToolsActuality()}))}_resolveSymbol(e,t){if(""===e)return Promise.resolve();let i=this._pendingResolveSymbols.get(e);return void 0!==i||(i=new Promise(((i,s)=>{this._onSymbolResolvingStart(e,t),this._chartApi.resolveSymbol((0,G.makeNextSymbolId)(),e,(r=>{switch(this._pendingResolveSymbols.delete(e),r.method){case"symbol_resolved":{this._setStatus({type:Tt.StudyStatusType.Undefined});const s=r.params[1];this._resolvedSymbols[e]=s,this._resolvedSymbolsByInput[t]=s,this._onSymbolResolved(e,t,s),this.invalidateTitleCache(!0),i();break}case"symbol_error":if(this._setStatus({type:Tt.StudyStatusType.Error,errorDescription:{error:r.params[1]}}),this._onSymbolError(),r.params[1]===j.permissionDenied&&r.params[2]){if(r.params[2]!==j.SymbolErrorPermissionDeniedReason.Symbol)return void this._resolveSymbol(r.params[2],t).then(i);if(r.params[3])return void this._resolveSymbol(r.params[3],t).then(i)}this._sendTelemetryCounter("symbol_error",Object.assign(this._getTelemetryAdditionalData(),{symbol:e,reason:r.params[1]})),s(t)}}))})),this._pendingResolveSymbols.set(e,i)),i}_recheckLineToolsActuality(){const e=this._model.paneForSource(this);null!==e&&e.sourcesByGroup().lineSourcesForAllSymbols().forEach((e=>{e.ownerSource()===this&&e.calcIsActualSymbol()}))}_sendTelemetryCounter(e,t){void 0===t&&(t=this._getTelemetryAdditionalData());const i={count:1,additional:t};ue.telemetry.sendChartReport(e,i)}_getTelemetryAdditionalData(){let e=""
;return this._metaInfo.pine&&this._metaInfo.pine.version&&this._metaInfo.shortId.indexOf("USER")>=0&&(e="_v"+this._metaInfo.pine.version),{symbol:this.series().actualSymbol(),resolution:this.series().interval(),study:this._metaInfo.shortId+e}}_onSourceFormatterChanged(){null===this._formatter&&(null!==this._priceScale&&this._priceScale.updateFormatter(),this._formatterChanged.fire())}_onSourcePriceStepChanged(){null===this._priceStep&&this._priceStepChanged.fire()}_bandsFirstValue(e){const t=this._metaInfo;if(!t.bands)return null;for(let i=0;i<t.bands.length;i++){const t=(0,o.ensureDefined)(this._properties.childs().bands).childs()[i];if(t.childs().visible.value()){const i=t.childs().value.value();if(e&&0===i)continue;return i}}return null}_prepareInputs(e){(0,o.assert)(!!e,"options not set");const t=this.metaInfo(),i={},s=e.allowedInputTypes?new Set(e.allowedInputTypes):null;for(let r=0;r<t.inputs.length;r++){const n=t.inputs[r];if(null!==s&&!s.has(n.type))continue;if(n.isFake&&e.skipFakeInputs)continue;if(n.isMTFResolution&&e.noResolution)continue;if(void 0!==e.displayMask&&!((0,o.ensureDefined)(n.display)&e.displayMask))continue;if(e.skipHiddenInputs&&(!e.doNotSkipHiddenWithMigrate||!n.migrate)){let t=!1;switch(n.type){case"bool":t=e.skipBooleanInputs;break;case"color":t=e.skipColorInputs;break;case"time":t=e.skipTimeInputs;break;case"text_area":t=e.skipTextareaInputs;break;default:t=Boolean(n.isHidden)}if(t)continue}if(void 0!==n.groupId&&-1!==e.skippedGroups.indexOf(n.groupId))continue;if(-1!==e.skippedInputs.indexOf(n.id))continue;const a=this._prepareInput(n,e);"symbol"===n.type&&e.skipOptionalEmptySymbolInputs&&""===a||(i[n.id]=(0,K.clone)(a))}return i}_prepareInputValue(e,t){const i=e.id,s=this._properties.childs();if(t.valuesAsIsFromProperties)return s.inputs.childs()[i].value();if("symbol"===e.type){const r=t&&t.symbolsForDisplay,n=s.inputs.childs()[i].value();let o=r?n:this._getSymbolForApi(n),a=this._resolvedSymbols?.[this._getSymbolForResolve(o)]??null;if(""===o&&e.optional){if(t&&t.keepOptionalSymbolsEmpty)return o;o=this._model.mainSeries().symbol(),a=this._model.mainSeries().symbolInfo()}if(r)if(a)if(ii){switch(this._model.mainSeries().symbolTextSourceProxyProperty().value()){case"description":o=a.description;break;case"ticker-and-description":o=`${a.name}, ${a.description}`;break;case"ticker":o=a.name}}else o=(0,Et.symbolTitle)(a,t.noExchanges);else ni&&(o="");else a&&(o=a.ticker||a.full_name),!this.isPine()&&t&&t.symbolsForChartApi&&(o=this.getSymbolString(o));return o}if("bar_time"===e.type){let e=s.inputs.childs()[i].value();if(e<0){const t=this._rightOffsetToUnixTime(-e);e=t&&t>=0?t:e}return e}if(this._metaInfo.isTVScript||this._metaInfo.pine){if("text"===i)return this._metaInfo.defaults.inputs?.text??"";if("pineId"===i)return this._metaInfo.scriptIdPart;if("pineVersion"===i)return this._metaInfo.pine?this._metaInfo.pine.version:"-1";if("color"===e.type&&this._metaInfo.isRGB){const e=s.inputs.childs()[i].value();return(0,V.colorToInteger)(e)}if("price"===e.type){
const e=s.inputs.childs()[i].value();return t.priceInputsForDisplay?this.formatter().format(e):e}}return s.inputs.childs()[i].value()}_getAllOwnerSources(){return ci(this).reverse().slice(1)}_getStudyIdWithLatestVersion(){return O.StudyMetaInfo.getStudyIdWithLatestVersion(this.metaInfo())}_debugId(){const e=[];return this._studyId&&e.push(this._studyId),e.push(this._metaInfo.fullId),e.push(this._metaInfo.description),JSON.stringify({study:e})}_hasAvailableAlertPlots(){if(null===this._alertMetaInfo())return!1;const e=this.stateForAlert(),t=c.alertBandFactory.create(e).getPlots();return null!=t&&t.length>0}_hasAlertConditions(){const e=this._alertMetaInfo();if(null===e)return!1;if(e.plots.some(L.isAlertConditionPlot))return!0;const t=this.stateForAlert();return Boolean(t.alerts&&t.alerts.conditions)}_hasAlertFunction(){const e=this._alertMetaInfo();return Boolean(null!==e&&e.hasAlertFunction)}async _updateParentSources(e,t,i){if(this._sources.forEach((e=>e.unsetChild(this))),i&&await Promise.all(e.map((e=>e.isStarted()?Promise.resolve():e.start(!1,!0)))),e.forEach((e=>e.setChild(this))),this._setSources(e),this._recreatePriceFormattingDependencies(),0!==t&&this._sources.length<=1){const e=this._firstSourceOrSeries(),t=this._priceScale,i=(0,o.ensureNotNull)(e.priceScale());if(t!==i){const t=this._model.paneForSource(this),s=(0,o.ensureNotNull)(this._model.paneForSource(e));t===s&&s.move(this,i,!0)}}}_calcSources(){const e=this._properties.childs().inputs.state();return O.StudyMetaInfo.getSourceIdsByInputs(this._metaInfo.inputs,e).map((e=>{if("high"===e||"open"===e||"low"===e||"close"===e||"hl2"===e||"ohl3"===e||"ohlc4"===e)return null;return this._model.allStudies().find((t=>t.canHaveChildren()&&t.id()===e))??null})).filter(K.notNull)}_isStopped(){return!this.isStarted()}_onDataUnpacked(e,t,i,s){if(this._isDestroyed)return;"nochange"!==t&&this._processPlotOffsets(s),this._transformData(e);const r=this._mergeData(e);null!==s&&(s.indexes_replace?((0,o.assert)("nochange"!==t),this._graphics.replaceIndexesTo(t)):("nochange"!==t&&this._graphics.replaceIndexesTo(t),void 0!==s.graphicsCmds&&this._graphics.processCommands(s.graphicsCmds))),this._onDataUpdated(e,s,t,r&&r.index),this.priceRangeReady()||this._enablePriceRangeReady(),this._dataUpdated.fire(i,!1,r)}_processPlotOffsets(e){if(e&&e.indexes_replace)return;const t=this._plotOffsets;this._plotOffsets=e&&e.offsets||{},(0,s.default)(t,this._plotOffsets)||this.updateAllViews((0,Bt.sourceChangeEvent)({sourceId:this.id(),clearData:!0})),this._updateMaxOffsetValue()}_applyPlotToPrecalculatedAutoscaleInfo(e,t,i,s){const r=s.id,n=this._properties.childs().styles.childs()[r],a=(0,L.isShapesPlot)(s)||(0,L.isCharsPlot)(s);i.useMainSeriesRange=i.useMainSeriesRange||(0,L.isArrowsPlot)(s);let l=(0,L.isLinePlot)(s)||(0,L.isOhlcPlot)(s);if(a){const e=(0,o.ensureDefined)(n).childs().location.value(),t=[N.MarkLocation.Absolute,N.MarkLocation.Top,N.MarkLocation.Bottom].indexOf(e)<0;i.useMainSeriesRange=i.useMainSeriesRange||a&&t,l=l||e===N.MarkLocation.Absolute}if(!l)return i;const h={
name:r,offset:this.offset(r)},u=n.childs().plottype.value();if(!this._skipHistogramBaseOnAutoScale()&&[L.LineStudyPlotStyle.Histogram,L.LineStudyPlotStyle.Columns,L.LineStudyPlotStyle.Area].indexOf(u)>=0){const s=(this._metaInfo.styles??{})?.[r]?.histogramBase;if(void 0===s)return i;const n=this.data().minMaxOnRangeCached(e,t,[h]);return(0,K.isNumber)(s)&&null!==n&&(i.baseValueMinMax=(0,T.mergeMinMax)(i.baseValueMinMax,{min:s,max:s}),i.baseValueMinMax=(0,T.mergeMinMax)(i.baseValueMinMax,n)),i}return i.fields.push(h),i}async _onSourceInputChanged(){if(!this.isStarted()){const e=this._calcSources();{const t=1===e.length&&e[0]!==this._sources[0]?1:0;this._updateParentSources(e,t,!1)}}}_buildInputs(e){(0,o.assert)(!!e,"options not set");let t={};try{t=this._prepareInputs(e)}catch(e){Zt.logWarn("Failed to prepare study inputs: "+e)}if(e.asObject){const e={};return Object.keys(t).forEach((i=>{null!=t[i]&&(e[i]=t[i])})),e}{const e=[];return Object.keys(t).forEach((i=>{null!=t[i]&&e.push(t[i])})),e}}_prepareInput(e,t){const i=this._prepareInputValue(e,t);return!e.isFake||t.fakeInputsForDisplay||t.onlyAtomValues?i:{v:i,f:!0,t:e.type}}_plotsForAlert(){return(0,g.plotsForAlert)(this.metaInfo(),this.offset.bind(this))}_calcIsActualInterval(){const e=this._isActualInterval;this._isActualInterval=(0,Ot.isActualInterval)(this._series.intervalObj(),this._properties.childs().intervalsVisibilities),e!==this._isActualInterval&&(this._onIsActualIntervalChange.fire(),this._visibleChanged(),this.processHibernate())}_visibleChanged(){this._series.invalidateBarColorerCache()}_getNonPriceParent(){const e=this._sources;for(const t of e)if(t instanceof fi){const e=t.metaInfo();return e.is_price_study&&"Compare@tv-basicstudies"!==e.id?t._getNonPriceParent():t}return null}_updateInputValue(e,t){const i=this._properties.childs().inputs.childs();if(i[t.id])if("price"===t.type)i[t.id].setValue(e.price);else if("time"===t.type){const s=this._model.timeScale().indexToTimePoint(e.index);null!==s&&i[t.id].setValue(1e3*s)}}_initializeStudyInputsPaneViews(){const e=(0,_.editableStudyInputs)(this._metaInfo.inputs);if(0===e.length)return;const t={convertPriceToCoordinate:e=>{const t=this.priceScale();if(null!==t&&!t.isEmpty()){const i=this.firstValue();if(null!==i)return t.priceToCoordinate(e,i)}return null},formatPrice:e=>{const t=this.priceScale();if(null!==t&&!t.isEmpty()){const i=this.firstValue();if(null!==i)return t.formatPrice(e,i)}return""},getInputValue:e=>this._properties.childs().inputs.child(e)?.value()??null,isSelected:()=>this._model.selection().isSelected(this),isHovered:()=>this===this._model.hoveredSource()};Promise.all([i.e(62183).then(i.bind(i,566195)),i.e(62183).then(i.bind(i,384892)),i.e(62183).then(i.bind(i,373109)),i.e(62183).then(i.bind(i,745642))]).then((i=>{const[s,r,n,o]=i;this._inputsAnchorsPaneView=new s.StudyInputsAnchorsPaneView(e,this._model,t);const a=e.filter((e=>!Array.isArray(e)));this._inputsLinesPaneView=new r.StudyInputsLinesPaneView(a,this._model,t);let l=!1;e.forEach((e=>{if(Array.isArray(e)){
const i="time"===e[0].type?e[0]:e[1],s="price"===e[0].type?e[0]:e[1];this._inputsTimeAxisPaneViews.push(new n.StudyInputTimeAxisPaneView(i,this._model,t.getInputValue)),this._inputsPriceAxisPaneViews.push(new o.StudyInputPriceAxisPaneView(s,t)),l=!0}else"time"===e.type?this._inputsTimeAxisPaneViews.push(new n.StudyInputTimeAxisPaneView(e,this._model,t.getInputValue)):(this._inputsPriceAxisPaneViews.push(new o.StudyInputPriceAxisPaneView(e,t)),l=!0)})),l&&this.formatterChanged().subscribe(this,this.invalidateTitleCache)}))}_updateCurrencySourceSymbolInfo(){}_initializeCurrencySource(){const e=this.metaInfo(),t="symbolInputSymbolSource"===e.symbolSource?.type&&e.symbolSource?.inputId,i=e.inputs.find((e=>e.id===t));if("string"==typeof t&&"symbol"===i?.type&&e.is_price_study){const e=this._properties.childs().inputs.childs()[t];void 0!==e&&(e.subscribe(this,this._onCurrencyMayChange),this._currencySourceSymbolInputProperty=e)}}_recreatePaneViews(){this.hasBarColorer()&&this._model.mainSeries().invalidateBarStylesCache(),this._createViews(),this.recalculate(),this.updateAllViews((0,Bt.sourceChangeEvent)(this.id()))}_pinePatchProps(){this._deferredPinePatchProps=!1;const e=this._prepareInputs(ti);if(!this._areStudyInputsModified(e))return;this._oldStudyInputs=e;const t=(0,b.patchPropertiesAsync)(this._properties,this._metaInfo,e,this._previousPatchMap),i=this._allSymbolsAreResolved(),s=this._propertiesPatched=new Promise((e=>{const r=()=>{s===this._propertiesPatched?e():this._propertiesPatched.then(e)};Promise.all([t,i]).then((()=>{r(),this._isDestroyed||(this._createViews(),this.recalculate(),this.updateAllViews((0,Bt.sourceChangeEvent)(this.id())),this.invalidateTitleCache())})).catch((e=>{r(),Zt.logError(`ERROR: ${this._debugId()} pine inputs patching failed, reason: ${e}`)}))}))}_areStudyInputsModified(e){if(0===Object.keys(e).length)return!1;if(void 0===this._oldStudyInputs)return!0;const t=Object.keys(this._oldStudyInputs);(0,o.assert)(t.length===Object.keys(e).length,"keys quantity should be equal");for(const i of t)if((0,o.assert)(e.hasOwnProperty(i),`key '${i}' should exist in study inputs`),(0,o.ensureDefined)(this._oldStudyInputs)[i]!==e[i])return!0;return!1}_onVisibleTimeRangeInputsChanged(e){null!==e?this._updateVisibleTimeRangeInputs(e):this.isStarted()&&this._chartApi.isConnected().value()&&this.stop(!0)}_updateVisibleTimeRangeInputs(e,t=!0){const i={first_visible_bar_time:e.firstVisibleBarTime,last_visible_bar_time:e.lastVisibleBarTime,subscribeRealtime:e.subscribeRealtime},s=this.metaInfo().inputs,r=[];for(const e of s)i.hasOwnProperty(e.id)&&r.push(e.id);const n=this.properties().childs().inputs;for(const e of r)n.childs()[e].setValueSilently(i[e]);t&&r.length>0&&n.fireChanged()}_getStudyErrorText(e){switch(e.match(/^study_not_auth:(.*)?@.*/)?.[1]){case"Script":case"StrategyScript":return"This script is invite-only. To request access, please contact its author.";case"VbPSessions":case"VbPPeriodic":case"VbPVisible":return"Volume Profile indicator available only on our upgraded plans."}
return e.split(":",2)[0]}_priceScaleByProperties(){if("default"===this.properties().childs().precision.value())return null;const e=parseInt(this.properties().childs().precision.value());return isFinite(e)?Math.pow(10,e):null}_priceScaleByMetaInfo(){const e=this.metaInfo().format,t="inherit"!==e.type?e.precision:void 0,i=(0,K.isNumber)(t)?Math.pow(10,t):void 0;if("price"===e.type||"percent"===e.type)return i||100;if("volume"===e.type){if(void 0===e.precision){const e=this.series().symbolInfo();if(null!==e&&(0,K.isNumber)(e.volume_precision))return Math.pow(10,e.volume_precision)}return 1}return"inherit"===e.type||Zt.logWarn("Unsupported format type: "+e.type),null}_inputSymbols(){return this.metaInfo().inputs.filter((e=>"symbol"===e.type)).map((e=>(0,o.ensureDefined)(this._properties.childs().inputs.child(e.id)).value()))}_studySpec(e){return{id:this._metaInfo.id,child:e??this.isChildStudy(),fundamental:(0,de.isFundamentalStudyMetaInfo)(this._metaInfo)}}_onFormatterPropsChanged(){this._recreatePriceFormattingDependencies()}_setSources(e){this.invalidateTitleCache(),this._sources=e,this._onParentSourcesChanges.fire()}}},359658:(e,t,i)=>{i.d(t,{plotShapesData:()=>r});var s=i(444372);const r={shape_arrow_down:{guiName:s.t(null,void 0,i(734247)),id:"shape_arrow_down",paneRendererClass:"PaneRendererArrowDown",pineName:"shape.arrowdown",icon:"arrow_down"},shape_arrow_up:{guiName:s.t(null,void 0,i(777231)),id:"shape_arrow_up",paneRendererClass:"PaneRendererArrowUp",pineName:"shape.arrowup",icon:"arrow_up"},shape_circle:{guiName:s.t(null,void 0,i(191944)),id:"shape_circle",paneRendererClass:"PaneRendererCircleShape",pineName:"shape.circle",icon:"circle"},shape_cross:{guiName:s.t(null,void 0,i(506969)),id:"shape_cross",paneRendererClass:"PaneRendererCrossShape",pineName:"shape.cross",icon:"cross"},shape_diamond:{guiName:s.t(null,void 0,i(415179)),id:"shape_diamond",paneRendererClass:"PaneRendererDiamond",pineName:"shape.diamond",icon:"diamond"},shape_flag:{guiName:s.t(null,void 0,i(333885)),id:"shape_flag",paneRendererClass:"PaneRendererFlagShape",pineName:"shape.flag",icon:"flag"},shape_label_down:{guiName:s.t(null,void 0,i(785924)),id:"shape_label_down",paneRendererClass:"PaneRendererLabelDown",pineName:"shape.labeldown",icon:"label_down"},shape_label_up:{guiName:s.t(null,void 0,i(649857)),id:"shape_label_up",paneRendererClass:"PaneRendererLabelUp",pineName:"shape.labelup",icon:"label_up"},shape_square:{guiName:s.t(null,void 0,i(66205)),id:"shape_square",paneRendererClass:"PaneRendererSquare",pineName:"shape.square",icon:"square"},shape_triangle_down:{guiName:s.t(null,void 0,i(676152)),id:"shape_triangle_down",paneRendererClass:"PaneRendererTriangleApexDown",pineName:"shape.triangledown",icon:"triangle_down"},shape_triangle_up:{guiName:s.t(null,void 0,i(21236)),id:"shape_triangle_up",paneRendererClass:"PaneRendererTriangleApexUp",pineName:"shape.triangleup",icon:"triangle_up"},shape_xcross:{guiName:s.t(null,void 0,i(211316)),id:"shape_xcross",paneRendererClass:"PaneRendererXCross",pineName:"shape.xcross",icon:"x_cross"}}},
151848:(e,t,i)=>{i.d(t,{translatedIntervalString:()=>r});var s=i(395394);function r(e){const t=(0,s.getTranslatedResolutionModel)(e,!0);return null===t?e:t.multiplier+(t.mayOmitShortKind?"":t.shortKind)}},154241:(e,t,i)=>{i.d(t,{createVisibilityController:()=>h});var s=i(444372),r=i(778785),n=i(998418),o=i(62802);const a="visibleOnMouseOver";function l(e){return"alwaysOn"===e||"alwaysOff"===e?e:a}function h(e,t){let h,u;function c(){if(!h){h=(0,n.createPrimitiveProperty)();let i=o.getValue(e);void 0===i&&void 0!==t&&(i=o.getValue(t)),h.setValue(l(i)),h.subscribe(h,(t=>{o.setValue(e,l(t.value()))}))}return h}return{property:c,availableValues:function(){return[{id:"visibleOnMouseOver",value:"visibleOnMouseOver",title:r.mobiletouch?s.t(null,void 0,i(458302)):s.t(null,void 0,i(437967))},{id:"alwaysOn",value:"alwaysOn",title:s.t(null,void 0,i(336299))},{id:"alwaysOff",value:"alwaysOff",title:s.t(null,void 0,i(840452))}]},actualBehavior:function(){if(!u){u=(0,n.createPrimitiveProperty)();const e=c(),t=()=>{const t=function(e){switch(e){case"alwaysOn":return"alwaysOn";case"alwaysOff":return"alwaysOff";case"visibleOnMouseOver":return r.mobiletouch?"visibleOnTapSelection":"visibleOnMouseOver";default:throw new Error(`Unknown visibility type: ${e}`)}}(e.value());u&&u.setValue(t)};e.subscribe(u,t),t()}return u},restoreDefaultValue:function(){c().setValue(a),o.remove(e)}}}},732634:(e,t,i)=>{i.d(t,{getSeriesIdForAlert:()=>o,getStudyIdForAlert:()=>a});var s=i(923533),r=i(484593),n=i(378975);function o(e,t){return(0,s.hash)(e+n.Interval.normalize(t)).toString()}function a(e,t,i){return(0,s.hash)(e+(0,r.sortedStringify)(t)+(i??"")).toString()}},500013:(e,t,i)=>{i.d(t,{extractTitleParts:()=>n,studyIdsWithNoInputsInTitle:()=>r});var s=i(675647);const r=new Set(["Volume@tv-basicstudies","AnchoredVWAP@tv-basicstudies"]);function n({title:e,studyId:t,hasInputs:i,description:n}){if(!i)return[e];let o;return n?o=function(e,t){return e.replace(t,"").trim()||void 0}(e,n):[n,o]=function(e){if(")"!==e[e.length-1])return[e];let t=0;for(let i=e.length-1;i>=0;i--)if(")"===e[i])t++;else if("("===e[i]&&(t--,0===t&&i>1&&" "===e[i-1]))return[e.slice(0,i-1),e.slice(i)];return[e]}(e),!o||r.has((0,s.extractStudyId)(t))?[n]:[n,o]}},19303:(e,t,i)=>{var s;i.d(t,{DataSourceDangerReason:()=>s}),function(e){e.Spread="spread",e.PineRepainting="pine-repainting",e.CryptoCap="cryptocap"}(s||(s={}))},682170:(e,t,i)=>{var s=i(474150).isStudyStateForAlertType,r=i(748947),n=i(745397).generateTitleForGui,o=i(338619).getLogger("Alerts.Band"),a=i(975179),l=i(881025),h=i(889301).lineToolsLocalizedNames;TradingView="object"==typeof i.g?i.g.TradingView:TradingView||{};var u={create:function(e){var t,i=e||{},r=i.type;if("MainSeries"===r)t=d;else if(s(r,!0))t=p;else if("Value"===r)t=_;else{if(!/^LineTool.*/i.test(r))return o.logError("Unknown alert band type "+r),null;t=f}return new t(i)}};function c(e){this._band=e||{}}function d(){c.apply(this,arguments)}function p(){c.apply(this,arguments)}function _(){c.apply(this,arguments)}function f(){c.apply(this,arguments)}
c.prototype.id=function(){return this._band.id},c.prototype.type=function(){return this._band.type},c.prototype.title=function(){return this._band.title},c.prototype.isTVScript=function(){return this._band.isTVScript},c.prototype.scriptVersion=function(){return this._band.scriptVersion},c.prototype.hasPlots=function(){return this._band.plots&&this._band.plots.length},c.prototype.getActualSymbol=function(){return this._band.actualSymbol},c.prototype.getSymbolString=function(){return this._band.symbolString},c.prototype.getPlotTitle=function(e){return e.title?e.title:r.isOhlcOpenPlot(e)?e.ohlcTitle+" "+i.i18next(null,void 0,i(16610)):r.isOhlcHighPlot(e)?e.ohlcTitle+" "+i.i18next(null,void 0,i(778254)):r.isOhlcLowPlot(e)?e.ohlcTitle+" "+i.i18next(null,void 0,i(165318)):r.isOhlcClosePlot(e)?e.ohlcTitle+" "+i.i18next(null,void 0,i(862578)):"vol"===e.id?i.i18next(null,void 0,i(937644)):"vol_ma"===e.id?i.i18next(null,void 0,i(609373)):"open"===e.id?i.i18next(null,void 0,i(16610)):"high"===e.id?i.i18next(null,void 0,i(778254)):"low"===e.id?i.i18next(null,void 0,i(165318)):"close"===e.id?i.i18next(null,void 0,i(862578)):e.id},c.prototype.getPlots=function(e){var t=e||{};if(!this._band.plots||!this._band.plots.length)return this._band.plots;if("inputSelect"===t.format){var i=-1;return this._band.plots.map((function(e){return{value:++i,title:this.getPlotTitle(e)}}),this)}return this._band.plots},c.prototype.hasUsualPlots=function(){var e=this._band.plots;return!e||e.filter(r.isAlertConditionPlot).length<e.length},c.prototype.getInputs=function(){return{}},inherit(d,c),d.prototype.title=function(e){var t=i(268552),s=e||{},r=!!s.withInterval,o=this._band.actualSymbol;return t&&(o=t.shortName(o)),n({symbol:o,interval:r?this._band.interval:void 0,style:this._band.style,inputs:this._band.styleInputs||{},boxSize:this._band.boxSize,reversalAmount:this._band.reversalAmount,sessionDescription:s.sessionDescription})},d.prototype.getInterval=function(){return this._band.interval},d.prototype.getStyle=function(){return this._band.style},d.prototype.getStyleInputs=function(){return this._band.styleInputs},d.prototype.isRangeBasedStyle=function(){return a.isRangeBasedStyle(this._band.style)},d.prototype.isSpread=function(){return this._band.isSpread},d.prototype.sessionId=function(){return this._band.sessionId},d.prototype.sessionDescription=function(){return this._band.sessionDescription},d.prototype.getDividendsAdjustment=function(){return this._band.dividendsAdjustment},d.prototype.getBackAdjustment=function(){return this._band.backAdjustment},d.prototype.getSettlementAsClose=function(){return this._band.settlementAsClose},inherit(p,c),p.prototype.title=function(e){var t,s,r,n=e||{},o=n.withPlotTitle,a=this._band;return n.short&&a.shortTitle?t=a.shortTitle:a.title?t=a.title:(t=a.shortDescription||"Study",s=[],Object.keys(a.inputs).forEach((function(e){var t=a.inputs[e]&&a.inputs[e].id;t&&!a.inputs[e].isHidden&&void 0!==a.inputs[t]&&s.push(a.inputs[t])})),s.length&&(t+=" ("+s.join(", ")+")")),
o&&(r=this.selectedPlot())&&(t+=" "+(r.title||i.i18next(null,void 0,i(370589)))),l.isRtl()&&(t=l.forceLTRStr(t)),t},p.prototype.selectedPlot=function(){var e=this._band;return void 0===e.plotIndex?null:this.getPlots().filter((function(t){return t.value===e.plotIndex}))[0]||null},p.prototype.getInputs=function(){return this._band.inputs||{}},p.prototype.isTVLibrary=function(){return this._band.isTVLibrary||!1},p.prototype.scriptIdPart=function(){return this._band.scriptIdPart},inherit(_,c),_.prototype.title=function(e){var t=this._band.value||0;return e.formatter?e.formatter.format(parseFloat(t)):parseFloat(t).toString()},inherit(f,c),f.prototype.title=function(){return h[this._band.type]||this.title()},e.exports.alertBandFactory=u},474150:(e,t,i)=>{var s;function r(e,t){let i="Study"===e||e===s.StudyLineTool||/^study_\w+/.test(e);return t&&(i=i||"StudyStrategy"===e||"ReplayStudyStrategy"===e),i}i.d(t,{StateForAlertType:()=>s,isStudyStateForAlertType:()=>r}),function(e){e.MainSeries="MainSeries",e.Study="Study",e.StudyLineTool="StudyLineTool",e.StudyStrategy="StudyStrategy",e.ReplayStudyStrategy="ReplayStudyStrategy"}(s||(s={}))},230839:(e,t,i)=>{function s(e,t){for(const i of t.keys())e.add(i)}i.d(t,{addToSet:()=>s})},545437:(e,t,i)=>{i.d(t,{showTooManyStudiesNotice:()=>n});var s=i(444372),r=i(779923);function n(e){(0,r.showWarning)({title:s.t(null,void 0,i(966719)),text:s.t(null,{replace:{number:`${e}`}},i(586146))})}},923533:(e,t,i)=>{function s(e){let t,i=0;if(0===e.length)return i;for(var s=0;s<e.length;s++)t=e.charCodeAt(s),i=(i<<5)-i+t,i|=0;return i}i.d(t,{hash:()=>s})}}]);